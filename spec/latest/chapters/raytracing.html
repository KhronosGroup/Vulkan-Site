<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ray Tracing :: Vulkan Documentation Project</title>
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../../../_/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../_/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../_/img/favicon-16x16.png">
    <link rel="manifest" href="../../../_/static/site.webmanifest">
    <link rel="mask-icon" href="../../../_/img/safari-pinned-tab.svg" color="#a41e22">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="theme-color" content="#ffffff">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../.."><img class="navbar-item" alt="Vulkan White Label" src="../../../_/Vulkan_Docs.svg" /></a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field has-filter">
          <label for="search-input"></label>
          <input id="search-input" type="text" placeholder="Search the docs">
          <label class="filter checkbox">
            <input type="checkbox" data-facet-filter="component:spec" checked> In this component
          </label>
        </div>
      </div>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <!-- <a class="navbar-item" href="#">Home</a> -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Specs</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../spec/latest/chapters/introduction.html">Vulkan 1.3</a>
            <a class="navbar-item" href="https://registry.khronos.org/OpenGL/specs/gl/GLSLangSpec.4.60.html">GLSL</a>
            <a class="navbar-item" href="../../../guide/latest/hlsl.html">HLSL</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Education</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../features/latest/features/index.html">Vulkan Feature Descriptions</a>
            <a class="navbar-item" href="../../../guide/latest/index.html">Vulkan Guide</a>
            <a class="navbar-item" href="../../../samples/latest/README.html">Vulkan Samples</a>
            <a class="navbar-item" href="../../../tutorial/latest/index.html">Vulkan Tutorial</a>
            <a class="navbar-item" href="https://www.youtube.com/c/vulkan">YouTube</a>
            <a class="navbar-item" href="https://vulkan.org">More Info at Vulkan.org</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Feedback</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://github.com/KhronosGroup/Vulkan-Site/issues/new/choose" target="_blank">Report a Problem</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://discord.gg/vulkan">Vulkan Discord</a>
            <a class="navbar-item" href="https://reddit.com/r/vulkan">Reddit</a>
            <a class="navbar-item" href="https://stackoverflow.com/questions/tagged/vulkan">Stack Overflow</a>
            <a class="navbar-item" href="https://fosstodon.org/@vulkan">Mastodon</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="spec" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">Vulkan Specification</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="fundamentals.html">Fundamentals</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="initialization.html">Initialization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="devsandqueues.html">Devices and Queues</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="cmdbuffers.html">Command Buffers</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="synchronization.html">Synchronization and Cache Control</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="renderpass.html">Render Pass</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="shaders.html">Shaders</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="pipelines.html">Pipelines</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="memory.html">Memory Allocation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="resources.html">Resource Creation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="samplers.html">Samplers</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="descriptorsets.html">Resource Descriptors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="interfaces.html">Shader Interfaces</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="textures.html">Image Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="fragmentdensitymapops.html">Fragment Density Map Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="queries.html">Queries</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="clears.html">Clear Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="copies.html">Copy Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="drawing.html">Drawing Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="fxvertex.html">Fixed-Function Vertex Processing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="tessellation.html">Tessellation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="geometry.html">Geometry Shading</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="VK_NV_mesh_shader/mesh.html">Mesh Shading</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="VK_HUAWEI_cluster_culling_shader/clusterculling.html">Cluster Culling Shading</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="vertexpostproc.html">Fixed-Function Vertex Post-Processing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="primsrast.html">Rasterization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="fragops.html">Fragment Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="framebuffer.html">The Framebuffer</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="dispatch.html">Dispatching Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="device_generated_commands/generatedcommands.html">Device-Generated Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="sparsemem.html">Sparse Resources</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="VK_KHR_surface/wsi.html">Window System Integration (WSI)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="VK_KHR_deferred_host_operations/deferred_host_operations.html">Deferred Host Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="VK_EXT_private_data.html">Private Data</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="accelstructures.html">Acceleration Structures</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="VK_EXT_opacity_micromap/micromaps.html">Micromap</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="raytraversal.html">Ray Traversal</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="raytracing.html">Ray Tracing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="VK_NV_memory_decompression.html">Memory Decompression</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="videocoding.html">Video Coding</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="VK_NV_optical_flow/optical_flow.html">Optical Flow</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="executiongraphs.html">Execution Graphs</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="extensions.html">Extending Vulkan</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="features.html">Features</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="limits.html">Limits</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="formats.html">Formats</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="capabilities.html">Additional Capabilities</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="debugging.html">Debugging</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendices/spirvenv.html">Vulkan Environment for SPIR-V</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendices/memorymodel.html">Memory Model</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendices/compressedtex.html">Compressed Image Formats</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendices/versions.html">Core Revisions (Informative)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendices/extensions.html">Layers &amp; Extensions (Informative)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendices/roadmap.html">Vulkan Roadmap Milestones</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendices/boilerplate.html">API Boilerplate</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendices/invariance.html">Invariance</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendices/glossary.html">Lexicon</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../appendices/credits.html">Credits (Informative)</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Vulkan Specification</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <div class="title"><a href="../../../tutorial/latest/00_Introduction.html">Khronos Vulkan Tutorial</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../tutorial/latest/00_Introduction.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../features/latest/features/index.html">Vulkan Feature Descriptions</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../features/latest/features/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../guide/latest/index.html">Vulkan Guide</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../guide/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../samples/latest/README.html">Vulkan Samples</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../samples/latest/README.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <div class="title"><a href="../index.html">Vulkan Specification</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Vulkan Specification</a></li>
    <li><a href="raytracing.html">Ray Tracing</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Ray Tracing</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Ray tracing uses a separate rendering pipeline from both the graphics and
compute pipelines (see <a href="#pipelines-ray-tracing">Ray Tracing Pipeline</a>).</p>
</div>
<div id="fig-raypipe" class="imageblock text-center">
<div class="content">
<img src="../_images/ray_tracing_execution.svg" alt="ray tracing execution">
</div>
<div class="title">Figure 1. Ray tracing pipeline execution</div>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Caption</div>
<div class="paragraph">
<p>Interaction between the different shader stages in the ray tracing pipeline</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Within the ray tracing pipeline, a <a href="#glossary-pipeline-trace-ray">pipeline trace ray</a> instruction <strong>can</strong> be called to perform a <a href="#ray-traversal">ray traversal</a> that invokes the various ray tracing shader stages during its
execution.
The relationship between the ray tracing pipeline object and the geometries
present in the acceleration structure traversed is passed into the ray
tracing command in a <a href="resources.html#VkBuffer" class="xref page">VkBuffer</a> object known as a <em>shader binding
table</em>.
<code>OpExecuteCallableKHR</code> can also be used in ray tracing pipelines to
invoke a <a href="#shaders-callable">callable shader</a>.</p>
</div>
<div class="paragraph">
<p>During execution, control alternates between scheduling and other
operations.
The scheduling functionality is implementation-specific and is responsible
for workload execution.
The shader stages are programmable.
<a href="#ray-traversal"><em>Traversal</em></a>, which refers to the process of traversing
acceleration structures to find potential intersections of rays with
geometry, is fixed function.</p>
</div>
<div class="paragraph">
<p>The programmable portions of the pipeline are exposed in a single-ray
programming model, with each invocation handling one ray at a time.
Memory operations <strong>can</strong> be synchronized using standard memory barriers.
The <code>Workgroup</code> scope and variables with a storage class of
<code>Workgroup</code> <strong>must</strong> not be used in the ray tracing pipeline.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ray-tracing-shader-call"><a class="anchor" href="#ray-tracing-shader-call"></a>Shader Call Instructions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <em>shader call</em> is an instruction which <strong>may</strong> cause execution to continue
elsewhere by creating one or more invocations that execute a different
shader stage.</p>
</div>
<div class="paragraph">
<p>The following table lists all shader call instructions and which stages each
one <strong>can</strong> directly call.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Instruction</th>
<th class="tableblock halign-left valign-top">Intersection</th>
<th class="tableblock halign-left valign-top">Any-Hit</th>
<th class="tableblock halign-left valign-top">Closest Hit</th>
<th class="tableblock halign-left valign-top">Miss</th>
<th class="tableblock halign-left valign-top">Callable</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OpTraceRayKHR</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OpReportIntersectionKHR</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OpExecuteCallableKHR</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The invocations created by shader call instructions are grouped into
subgroups by the implementation.
Those subgroups <strong>may</strong> be unrelated to the subgroup of the parent invocation.</p>
</div>
<div id="ray-tracing-recursion-depth" class="paragraph">
<p><em>Pipeline trace ray instructions</em> <strong>can</strong> be used recursively; invoked shaders
<strong>can</strong> themselves execute pipeline trace ray instructions, to a maximum depth
defined by the
<a href="#limits-maxRayRecursionDepth"><code>maxRayRecursionDepth</code></a> limit.</p>
</div>
<div class="paragraph">
<p>Shaders directly invoked from the API always have a recursion depth of 0;
each shader executed by a pipeline trace ray instruction has a recursion
depth one higher than the recursion depth of the shader which invoked it.
Applications <strong>must</strong> not invoke a shader with a recursion depth greater than
the value of
<code>maxPipelineRayRecursionDepth</code> specified in the pipeline.</p>
</div>
<div class="paragraph">
<p>There is no explicit recursion limit for other shader call instructions
which may recurse (e.g. <code>OpExecuteCallableKHR</code>) but there is an upper
bound determined by the <a href="#ray-tracing-pipeline-stack">stack size</a>.</p>
</div>
<div id="ray-tracing-repack" class="paragraph">
<p>An <em>invocation repack instruction</em> is a ray tracing instruction where the
implementation <strong>may</strong> change the set of invocations that are executing.
When a repack instruction is encountered, the invocation is suspended and a
new invocation begins and executes the instruction.
After executing the repack instruction (which <strong>may</strong> result in other ray
tracing shader stages executing) the new invocation ends and the original
invocation is resumed, but it <strong>may</strong> be resumed in a different subgroup or at
a different <code>SubgroupLocalInvocationId</code> within the same subgroup.
When a subset of invocations in a subgroup execute the invocation repack
instruction, those that do not execute it remain in the same subgroup at the
same <code>SubgroupLocalInvocationId</code>.</p>
</div>
<div class="paragraph">
<p>The <code>OpTraceRayKHR</code>,
<code>OpReportIntersectionKHR</code>, and <code>OpExecuteCallableKHR</code> instructions are
invocation repack instructions.</p>
</div>
<div class="paragraph">
<p>The invocations that are executing before a shader call instruction, after
the instruction, or are created by the instruction, are
<a href="#shader-call-related">shader-call-related</a>.</p>
</div>
<div class="paragraph">
<p>If the implementation changes the composition of subgroups, the values of
<code>SubgroupSize</code>, <code>SubgroupLocalInvocationId</code>,
and builtin variables that are derived from them (<code>SubgroupEqMask</code>,
<code>SubgroupGeMask</code>, <code>SubgroupGtMask</code>, <code>SubgroupLeMask</code>,
<code>SubgroupLtMask</code>) <strong>must</strong> be changed accordingly by the invocation repack
instruction.
The application <strong>must</strong> use <a href="../appendices/spirvenv.html#builtin-volatile-semantics" class="xref page"><code>Volatile</code> semantics</a> on these <code>BuiltIn</code> variables when used in the ray generation,
closest hit, miss, intersection, and callable shaders.
Similarly, the application <strong>must</strong> use <code>Volatile</code> semantics on any
<code>RayTmaxKHR</code> decorated <code>Builtin</code> used in an intersection shader.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="shaders.html#shaders-group-operations" class="xref page">Subgroup operations</a> are permitted in the
programmable ray tracing shader stages.
However, shader call instructions place a bound on where results of subgroup
instructions or subgroup-scoped instructions that execute the dynamic
instance of that instruction are potentially valid.
For example, care <strong>must</strong> be taken when using the result of a ballot operation
that was computed before an invocation repack instruction, after that repack
instruction.
The ballot <strong>may</strong> be incorrect as the set of invocations could have changed.</p>
</div>
<div class="paragraph">
<p>While the <code>SubgroupSize</code> built-in is required to be declared
<code>Volatile</code>, its value will never change unless
<code>VK_PIPELINE_SHADER_STAGE_CREATE_ALLOW_VARYING_SUBGROUP_SIZE_BIT</code> is set
on pipeline creation, as without that bit set, its value is required to
match that of <a href="limits.html#VkPhysicalDeviceSubgroupProperties" class="xref page">VkPhysicalDeviceSubgroupProperties</a>::<code>subgroupSize</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When a ray tracing shader executes a dynamic instance of an invocation
repack instruction which results in another ray tracing shader being
invoked, their instructions are related by
<a href="#shader-call-order">shader-call-order</a>.</p>
</div>
<div class="paragraph">
<p>For ray tracing invocations that are
<a href="#shader-call-related">shader-call-related</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="../appendices/memorymodel.html#memory-model-memory-operation" class="xref page">memory operations</a> on
    <code>StorageBuffer</code>, <code>Image</code>, and <code>ShaderRecordBufferKHR</code> storage
    classes <strong>can</strong> be synchronized using the
<code>Device</code> or <code>QueueFamily</code>
    scope.</p>
</li>
<li>
<p>the <code>CallableDataKHR</code>, <code>IncomingCallableDataKHR</code>,
<code>RayPayloadKHR</code>, <code>HitAttributeKHR</code>, and <code>IncomingRayPayloadKHR</code>
storage classes are <a href="../appendices/memorymodel.html#memory-model-shader-io" class="xref page">system-synchronized</a> and
no application availability and visibility operations are required.</p>
</li>
<li>
<p>memory operations within a single invocation before and after the shader
call instruction are ordered by
<a href="../appendices/memorymodel.html#memory-model-program-order" class="xref page">program-order</a> and do not require explicit
synchronization.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ray-tracing-commands"><a class="anchor" href="#ray-tracing-commands"></a>Ray Tracing Commands</h2>
<div class="sectionbody">
<div class="paragraph">
<p><em>Ray tracing commands</em> provoke work in the ray tracing pipeline.
Ray tracing commands are recorded into a command buffer and when executed by
a queue will produce work that executes according to the currently bound ray
tracing pipeline.
A ray tracing pipeline <strong>must</strong> be bound to a command buffer before any ray
tracing commands are recorded in that command buffer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="shader-binding-table"><a class="anchor" href="#shader-binding-table"></a>Shader Binding Table</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A <em>shader binding table</em> is a resource which establishes the relationship
between the ray tracing pipeline and the acceleration structures that were
built for the ray tracing pipeline.
It indicates the shaders that operate on each geometry in an acceleration
structure.
In addition, it contains the resources accessed by each shader, including
indices of textures, buffer device addresses, and constants.
The application allocates and manages <em>shader binding tables</em> as
<a href="resources.html#VkBuffer" class="xref page">VkBuffer</a> objects.</p>
</div>
<div class="paragraph">
<p>Each entry in the shader binding table consists of
<code>shaderGroupHandleSize</code> bytes of data, either as queried by
<code>vkGetRayTracingShaderGroupHandlesKHR</code> to refer to those specified
shaders, or all zeros to refer to a zero shader group.
A zero shader group behaves as though it is a shader group consisting
entirely of <code>VK_SHADER_UNUSED_KHR</code>.
The remainder of the data specified by the stride is application-visible
data that can be referenced by a <code>ShaderRecordBufferKHR</code> block in the
shader.</p>
</div>
<div class="paragraph">
<p>The shader binding tables to use in a ray tracing pipeline are passed to the
<code>vkCmdTraceRaysKHR</code>, or <code>vkCmdTraceRaysIndirectKHR</code> commands.
Shader binding tables are read-only in shaders that are executing on the ray
tracing pipeline.</p>
</div>
<div class="paragraph">
<p>Shader variables identified with the <code>ShaderRecordBufferKHR</code> storage
class are used to access the provided shader binding table.
Such variables <strong>must</strong> be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>typed as <code>OpTypeStruct</code>, or an array of this type,</p>
</li>
<li>
<p>identified with a <code>Block</code> decoration, and</p>
</li>
<li>
<p>laid out explicitly using the <code>Offset</code>, <code>ArrayStride</code>, and
<code>MatrixStride</code> decorations as specified in
<a href="interfaces.html#interfaces-resources-layout" class="xref page">Offset and Stride Assignment</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>Offset</code> decoration for any member of a <code>Block</code>-decorated variable
in the <code>ShaderRecordBufferKHR</code> storage class <strong>must</strong> not cause the space
required for that variable to extend outside the range <span class="eq">[0,
<code>maxStorageBufferRange</code>)</span>.</p>
</div>
<div class="paragraph">
<p>Accesses to the shader binding table from ray tracing pipelines <strong>must</strong> be
<a href="synchronization.html#synchronization-dependencies" class="xref page">synchronized</a> with the
<code>VK_PIPELINE_STAGE_RAY_TRACING_SHADER_BIT_KHR</code>
<a href="synchronization.html#synchronization-pipeline-stages" class="xref page">pipeline stage</a> and an
<a href="synchronization.html#synchronization-access-types" class="xref page">access type</a> of
<code>VK_ACCESS_SHADER_READ_BIT</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Because different shader record buffers can be associated with the same
shader, a shader variable with <code>ShaderRecordBufferKHR</code> storage class will
not be dynamically uniform if different invocations of the same shader can
reference different data in the shader record buffer, such as if the same
shader occurs twice in the shader binding table with a different shader
record buffer.
In this case, indexing resources based on values in the
<code>ShaderRecordBufferKHR</code> storage class, the index should be decorated as
<code>NonUniform</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="shader-binding-table-indexing-rules"><a class="anchor" href="#shader-binding-table-indexing-rules"></a>Indexing Rules</h3>
<div class="paragraph">
<p>In order to execute the correct shaders and access the correct resources
during a ray tracing dispatch, the implementation <strong>must</strong> be able to locate
shader binding table entries at various stages of execution.
This is accomplished by defining a set of indexing rules that compute shader
binding table record positions relative to the buffer&#8217;s base address in
memory.
The application <strong>must</strong> organize the contents of the shader binding table&#8217;s
memory in a way that application of the indexing rules will lead to correct
records.</p>
</div>
<div class="sect3">
<h4 id="_ray_generation_shaders"><a class="anchor" href="#_ray_generation_shaders"></a>Ray Generation Shaders</h4>
<div class="paragraph">
<p>Only one ray generation shader is executed per ray tracing dispatch.</p>
</div>
</div>
<div class="sect3">
<h4 id="shader-binding-table-hit-shader-indexing"><a class="anchor" href="#shader-binding-table-hit-shader-indexing"></a>Hit Shaders</h4>
<div class="paragraph">
<p>The base for the computation of intersection, any-hit, and closest hit
shader locations is the <code>instanceShaderBindingTableRecordOffset</code> value
stored with each instance of a top-level acceleration structure
(<code>VkAccelerationStructureInstanceKHR</code>).
This value determines the beginning of the shader binding table records for
a given instance.</p>
</div>
<div class="paragraph">
<p>In the following rule, <code>geometryIndex</code> refers to the
<a href="#acceleration-structure-geometry-index">geometry index</a> of the intersected
geometry within the instance.</p>
</div>
<div class="paragraph">
<p>The <code>sbtRecordOffset</code> and <code>sbtRecordStride</code> values are passed in as
parameters to
calls made in the shaders.
See Section 8.19 (Ray Tracing Functions) of the OpenGL Shading Language
Specification for more details.
In SPIR-V, these correspond to the <code>SBTOffset</code> and <code>SBTStride</code>
parameters to the <a href="#glossary-pipeline-trace-ray">pipeline trace ray</a>
instructions.</p>
</div>
<div class="paragraph">
<p>The result of this computation is then added to
.</p>
</div>
</div>
<div class="sect3">
<h4 id="_miss_shaders"><a class="anchor" href="#_miss_shaders"></a>Miss Shaders</h4>
<div class="paragraph">
<p>A miss shader is executed whenever a ray query fails to find an intersection
for the given scene geometry.
Multiple miss shaders <strong>may</strong> be executed throughout a ray tracing dispatch.</p>
</div>
<div class="paragraph">
<p>The base for the computation of miss shader locations is
.</p>
</div>
<div class="paragraph">
<p>The <code>missIndex</code> value is passed in as a parameter to
calls made in the shaders.
See Section 8.19 (Ray Tracing Functions) of the OpenGL Shading Language
Specification for more details.
In SPIR-V, this corresponds to the <code>MissIndex</code> parameter to the
<a href="#glossary-pipeline-trace-ray">pipeline trace ray</a> instructions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_callable_shaders"><a class="anchor" href="#_callable_shaders"></a>Callable Shaders</h4>
<div class="paragraph">
<p>A callable shader is executed when requested by a ray tracing shader.
Multiple callable shaders <strong>may</strong> be executed throughout a ray tracing
dispatch.</p>
</div>
<div class="paragraph">
<p>The base for the computation of callable shader locations is
.</p>
</div>
<div class="paragraph">
<p>The <code>sbtRecordIndex</code> value is passed in as a parameter to
calls made in the shaders.
See Section 8.19 (Ray Tracing Functions) of the OpenGL Shading Language
Specification for more details.
In SPIR-V, this corresponds to the <code>SBTIndex</code> parameter to the
instruction.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ray-tracing-pipeline-stack"><a class="anchor" href="#ray-tracing-pipeline-stack"></a>Ray Tracing Pipeline Stack</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ray tracing pipelines have a potentially large set of shaders which <strong>may</strong> be
invoked in various call chain combinations to perform ray tracing.
To store parameters for a given shader execution, an implementation <strong>may</strong> use
a stack of data in memory.
This stack <strong>must</strong> be sized to the sum of the stack sizes of all shaders in
any call chain executed by the application.</p>
</div>
<div class="paragraph">
<p>If the stack size is not set explicitly, the stack size for a pipeline is:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"></dt>
<dd>
<p><span class="eq">rayGenStackMax +  min(1,
<code>maxPipelineRayRecursionDepth</code>) ×
max(closestHitStackMax, missStackMax, intersectionStackMax
+  anyHitStackMax) +  max(0,
<code>maxPipelineRayRecursionDepth</code>-1) ×
max(closestHitStackMax, missStackMax) +  2 ×
callableStackMax</span></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>where <span class="eq">rayGenStackMax</span>, <span class="eq">closestHitStackMax</span>, <span class="eq">missStackMax</span>,
<span class="eq">anyHitStackMax</span>, <span class="eq">intersectionStackMax</span>, and <span class="eq">callableStackMax</span>
are the maximum stack values queried by the respective shader stages for any
shaders in any shader groups defined by the pipeline.</p>
</div>
<div class="paragraph">
<p>This stack size is potentially significant, so an application <strong>may</strong> want to
provide a more accurate stack size after pipeline compilation.
The value that the application provides is the maximum value of the sum of
all shaders in a call chain across all possible call chains, taking into
account any application specific knowledge about the properties of the call
chains.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For example, if an application has two types of closest hit and miss shaders
that it can use but the first level of rays will only use the first kind
(possibly reflection) and the second level will only use the second kind
(occlusion or shadow ray, for example) then the application can compute the
stack size by something similar to:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"></dt>
<dd>
<p><span class="eq"><code>rayGenStack</code> +  max(<code>closestHit1Stack</code>,
<code>miss1Stack</code>) +  max(<code>closestHit2Stack</code>,
<code>miss2Stack</code>)</span></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>This is guaranteed to be no larger than the default stack size computation
which assumes that both call levels may be the larger of the two.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ray-tracing-capture-replay"><a class="anchor" href="#ray-tracing-capture-replay"></a>Ray Tracing Capture Replay</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In a similar way to
<a href="features.html#features-bufferDeviceAddressCaptureReplay" class="xref page">bufferDeviceAddressCaptureReplay</a>,
the <a href="#features-rayTracingPipelineShaderGroupHandleCaptureReplay"><code>rayTracingPipelineShaderGroupHandleCaptureReplay</code></a> feature allows the
querying of opaque data which <strong>can</strong> be used in a future replay.</p>
</div>
<div class="paragraph">
<p>During the capture phase, capture/replay tools are expected to query opaque
data for shader group handle replay using
<code>vkGetRayTracingCaptureReplayShaderGroupHandlesKHR</code>.</p>
</div>
<div class="paragraph">
<p>Providing the opaque data during replay, using
<code>VkRayTracingShaderGroupCreateInfoKHR</code>::<code>pShaderGroupCaptureReplayHandle</code>
at pipeline creation time, causes the implementation to generate identical
shader group handles to those in the capture phase, allowing capture/replay
tools to reuse previously recorded shader binding table buffer contents or
to obtain the same handles by calling
<code>vkGetRayTracingCaptureReplayShaderGroupHandlesKHR</code> again.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
  </body>
</html>
