<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VK_EXT_external_memory_acquire_unmodified :: Vulkan Documentation Project Demo</title>
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../.."><img class="navbar-item" alt="Vulkan White Label" src="../../../../_/Vulkan_White_Dec16.svg" /></a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label for="search-input"></label><input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <!-- <a class="navbar-item" href="#">Home</a> -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Specs</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../spec/latest/chapters/introduction.html">Vulkan 1.3</a>
            <a class="navbar-item" href="https://registry.khronos.org/OpenGL/specs/gl/GLSLangSpec.4.60.html">GLSL</a>
            <a class="navbar-item" href="/guide/latest/hlsl.html">HLSL</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Education</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../guide/latest/index.html">Vulkan Guide</a>
            <a class="navbar-item" href="../../../../tutorial/latest/index.html">Vulkan Tutorial</a>
            <a class="navbar-item" href="../../../../samples/latest/README.html">Vulkan Samples</a>
            <a class="navbar-item" href="https://www.youtube.com/c/vulkan">YouTube</a>
            <a class="navbar-item" href="https://vulkan.org">More Info at Vulkan.org</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://discord.gg/vulkan">Vulkan Discord</a>
            <a class="navbar-item" href="https://reddit.com/r/vulkan">Reddit</a>
            <a class="navbar-item" href="https://stackoverflow.com/questions/tagged/vulkan">Stack Overflow</a>
            <a class="navbar-item" href="https://twitter.com/vulkanapi">X</a>
            <a class="navbar-item" href="https://fosstodon.org/@vulkan">Mastodon</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="spec" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">Vulkan Specification and Proposals</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/fundamentals.html">Fundamentals</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/initialization.html">Initialization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/devsandqueues.html">Devices and Queues</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/cmdbuffers.html">Command Buffers</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/synchronization.html">Synchronization and Cache Control</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/renderpass.html">Render Pass</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/shaders.html">Shaders</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/pipelines.html">Pipelines</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/memory.html">Memory Allocation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/resources.html">Resource Creation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/samplers.html">Samplers</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/descriptorsets.html">Resource Descriptors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/interfaces.html">Shader Interfaces</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/textures.html">Image Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/fragmentdensitymapops.html">Fragment Density Map Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/queries.html">Queries</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/clears.html">Clear Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/copies.html">Copy Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/drawing.html">Drawing Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/fxvertex.html">Fixed-Function Vertex Processing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/tessellation.html">Tessellation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/geometry.html">Geometry Shading</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_NV_mesh_shader/mesh.html">Mesh Shading</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_HUAWEI_cluster_culling_shader/clusterculling.html">Cluster Culling Shading</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/vertexpostproc.html">Fixed-Function Vertex Post-Processing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/primsrast.html">Rasterization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/fragops.html">Fragment Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/framebuffer.html">The Framebuffer</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/dispatch.html">Dispatching Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_NV_device_generated_commands/generatedcommands.html">Device-Generated Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/sparsemem.html">Sparse Resources</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_KHR_surface/wsi.html">Window System Integration (WSI)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_KHR_deferred_host_operations/deferred_host_operations.html">Deferred Host Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_EXT_private_data.html">Private Data</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/accelstructures.html">Acceleration Structures</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_EXT_opacity_micromap/micromaps.html">Micromap</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/raytraversal.html">Ray Traversal</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/raytracing.html">Ray Tracing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_NV_memory_decompression.html">Memory Decompression</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/video_extensions.html">Video Coding</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_NV_optical_flow/optical_flow.html">Optical Flow</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/extensions.html">Extending Vulkan</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/features.html">Features</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/limits.html">Limits</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/formats.html">Formats</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/capabilities.html">Additional Capabilities</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/debugging.html">Debugging</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/spirvenv.html">Vulkan Environment for SPIR-V</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/memorymodel.html">Memory Model</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/compressedtex.html">Compressed Image Formats</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/versions.html">Core Revisions (Informative)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/extensions.html">Layers &amp; Extensions (Informative)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/roadmap.html">Vulkan Roadmap Milestones</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/boilerplate.html">API Boilerplate</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/invariance.html">Invariance</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/glossary.html">Lexicon</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/credits.html">Credits (Informative)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Vulkan Proposals</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Vulkan Roadmap</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="Roadmap.html">Vulkan Roadmap</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Extension Proposals</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_AMD_shader_early_and_late_fragment_tests.html">VK_AMD_shader_early_and_late_fragment_tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_attachment_feedback_loop_layout.html">VK_EXT_attachment_feedback_loop_layout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_graphics_pipeline_library.html">VK_EXT_graphics_pipeline_library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_image_2d_array_of_3d.html">VK_EXT_image_2d_array_of_3d</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_image_compression_control.html">VK_EXT_image_compression_control</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_metal_objects.html">VK_EXT_metal_objects</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_multisampled_render_to_single_sampled.html">VK_EXT_multisampled_render_to_single_sampled</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_non_seamless_cube_map.html">VK_EXT_non_seamless_cube_map</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_primitives_generated_query.html">VK_EXT_primitives_generated_query</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_rasterization_order_attachment_access.html">VK_EXT_rasterization_order_attachment_access</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_shader_module_identifier.html">VK_EXT_shader_module_identifier</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_subpass_merge_feedback.html">VK_EXT_subpass_merge_feedback</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_GOOGLE_surfaceless_query.html">VK_GOOGLE_surfaceless_query</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_HUAWEI_invocation_mask.html">VK_HUAWEI_invocation_mask</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_dynamic_rendering.html">VK_KHR_dynamic_rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_fragment_shader_barycentric.html">VK_KHR_fragment_shader_barycentric</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_fragment_shading_rate.html">VK_KHR_fragment_shading_rate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_integer_dot_product.html">VK_KHR_shader_integer_dot_product</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_QCOM_image_processing.html">VK_QCOM_image_processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_QCOM_tile_properties.html">VK_QCOM_tile_properties</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Extension Proposal Template</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="template.html">Proposal Template</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Vulkan Specification and Proposals</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../tutorial/latest/00_Introduction.html">Khronos Vulkan Tutorial</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../tutorial/latest/00_Introduction.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../guide/latest/index.html">Vulkan Guide</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../guide/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../samples/latest/README.html">Vulkan Samples</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../samples/latest/README.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../index.html">Vulkan Specification and Proposals</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Vulkan Specification and Proposals</a></li>
    <li><a href="VK_EXT_external_memory_acquire_unmodified.html">VK_EXT_external_memory_acquire_unmodified</a></li>
  </ul>
</nav>
    <!--
  <div class="edit-this-page"><a href="https://github.com/KhronosGroup/Vulkan-Docs/edit/main/antora/modules/proposals/pages/proposals/VK_EXT_external_memory_acquire_unmodified.adoc">Edit this Page</a></div>
      -->
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">VK_EXT_external_memory_acquire_unmodified</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_problem_statement">1. Problem Statement</a></li>
<li><a href="#_solution_space">2. Solution Space</a>
<ul class="sectlevel2">
<li><a href="#_design_goals">2.1. Design Goals</a></li>
<li><a href="#_considered_solutions">2.2. Considered Solutions</a></li>
<li><a href="#_solution_analysis">2.3. Solution Analysis</a></li>
</ul>
</li>
<li><a href="#_proposal">3. Proposal</a>
<ul class="sectlevel2">
<li><a href="#_feature">3.1. Feature</a></li>
<li><a href="#_caution">3.2. Caution</a></li>
</ul>
</li>
<li><a href="#_issues">4. Issues</a>
<ul class="sectlevel2">
<li><a href="#_resolved_out_of_scope_how_to_determine_if_a_resources_external_memory_is_modified">4.1. RESOLVED: OUT OF SCOPE. How to determine if a resource&#8217;s external memory is modified?</a></li>
</ul>
</li>
<li><a href="#_further_functionality">5. Further Functionality</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This document proposes adding a performance hint that may reduce the runtime
cost of memory barriers that acquire ownership of a resource from an external
queue family (such as
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VK_QUEUE_FAMILY_FOREIGN_EXT.html">VK_QUEUE_FAMILY_FOREIGN_EXT</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_problem_statement"><a class="anchor" href="#_problem_statement"></a>1. Problem Statement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A memory barrier that acquires ownership of a resource from an external queue
family may, in some cases, have an unacceptable runtime cost and produce
noticeable latency.</p>
</div>
<div class="paragraph">
<p>An external resource&#8217;s data may be split between external memory and
non-external memory.
The resource&#8217;s <em>external memory</em> is the collection of ranges
of <a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkDeviceMemory.html">VkDeviceMemory</a> bound to the resource,
where the <a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkDeviceMemory.html">VkDeviceMemory</a> has been imported or
exported with an API related to
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VK_KHR_external_memory.html">VK_KHR_external_memory</a>.
The external memory is shared among all external APIs and/or processes that
access the resource.
The resource&#8217;s <em>non-external memory</em>, in this discussion,
is any implementation-private memory that
is associated with the resource
and does not reside in any range of <a href="#chapters/memory.adoc#VkDeviceMemory" class="xref unresolved">VkDeviceMemory</a> bound to the resource.
For example, if the external resource is a <a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkImage.html">VkImage</a>,
then in some Vulkan implementations
the external memory may contain the image&#8217;s pixel data and externally shared metadata,
and the non-external memory may contain implementation-private metadata.
Note that, in some Vulkan implementations,
the resource&#8217;s non-external memory, unlike its external memory, is
not shared globally among the APIs and/or processes that use the resource.
For example, each <a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkDevice.html">VkDevice</a>
and <code>EGLContext</code> that accesses the resource may maintain its own private
non-external memory for the resource.</p>
</div>
<div class="paragraph">
<p>For this discussion, a resource&#8217;s <em>external memory</em> is considered
<em>unmodified</em> if no bit was modified in the allocated memory.
This definition refers only to the physical bits in the allocated memory, and
is independent of Vulkan operations such as image layout transitions, shader
access, transfer commands, etc.
In particular, operations that seem to be read-only may modify a resource&#8217;s
memory in some cases.
This definition is also independent of the resource&#8217;s <em>non-external memory</em>;
that is, it is independent of any modifications to implementation-private memory
associated with the resource.</p>
</div>
<div class="paragraph">
<p>The performance problem is due to the Vulkan implementation&#8217;s need to maintain
synchronization between data contained in the resource&#8217;s external memory
and in its non-external memory.
When an application releases ownership of a resource to an external queue
family and later re-acquires ownership, the external queue family may have
modified the resource&#8217;s external memory during its ownership.
If the external queue family <em>did</em> modify the resource&#8217;s external memory,
then, when the application re-acquires ownership, the Vulkan implementation
must, during the ownership-acquire operation, synchronize the resource&#8217;s non-external
data with the new, modified external data.
In this case, the synchronization operation is unavoidable.
However, if the external queue family <em>did not</em> modify the resource&#8217;s external
memory, and if the implementation is <em>unable to determine</em> that the external
memory remained unmodified, then the Vulkan implementation must <em>still</em>
synchronize the data during the acquire operation.
In this case, the synchronization operation is unnecessary.
If the application had the ability to inform that Vulkan implementation that
resource&#8217;s external memory remained unmodified, then the implementation could
avoid the synchronization operation.</p>
</div>
<div class="paragraph">
<p>For example, suppose the application renders to an image, then transfers
ownership of the image to
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VK_QUEUE_FAMILY_FOREIGN_EXT.html">VK_QUEUE_FAMILY_FOREIGN_EXT</a>,
then later re-acquires the image with
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkImageMemoryBarrier.html">VkImageMemoryBarrier</a>.
Suppose the application knows that the external queue family did not modify
the image&#8217;s external memory, but cannot inform the Vulkan implementation
of its unmodified status due to lack of Vulkan API.
The Vulkan implementation must perform the unnecessary data synchronization
during the execution of the <a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkImageMemoryBarrier.html">VkImageMemoryBarrier</a>.</p>
</div>
<div class="paragraph">
<p>The problem is especially relevant for systems that implement
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkSwapchainKHR.html">VkSwapchainKHR</a>
by layering it atop the external memory extensions such as
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VK_EXT_external_memory_dma_buf.html">VK_EXT_external_memory_dma_buf</a>.
On such systems, the application may suffer the performance overhead each time
it acquires an image from the swapchain, even though the window system did not
modify the image&#8217;s memory.
Specifically, the overhead is likely to occur when the application transitions
the image layout away from
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkImageLayout.html">VK_IMAGE_LAYOUT_PRESENT_SRC_KHR</a>
after <a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/vkAcquireNextImageKHR.html">vkAcquireNextImageKHR</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solution_space"><a class="anchor" href="#_solution_space"></a>2. Solution Space</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_design_goals"><a class="anchor" href="#_design_goals"></a>2.1. Design Goals</h3>
<div class="ulist">
<ul>
<li>
<p>The solution must provide the application a way to inform the implementation
that the external resource has remained unmodified for the duration from the
application&#8217;s most recent release of ownership to the external queue family
until the application&#8217;s current ownership acquire operation.</p>
</li>
<li>
<p>The solution should not require the implementation to internally track the
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkImageLayout.html">VkImageLayout</a> of external images.
Such tracking can be complex to implement and cause performance overhead.</p>
</li>
<li>
<p>The solution must work well for systems that implement
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkSwapchainKHR.html">VkSwapchainKHR</a> by layering it atop external
memory extensions such as
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VK_EXT_external_memory_dma_buf.html">VK_EXT_external_memory_dma_buf</a>.</p>
</li>
<li>
<p>After acquiring a swapchain image but before using the image, applications
must transition the image away from
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkImageLayout.html">VK_IMAGE_LAYOUT_PRESENT_SRC_LAYOUT_KHR</a>
(which preserves the image&#8217;s pixels) or
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VK_IMAGE_LAYOUT_UNDEFINED.html">VK_IMAGE_LAYOUT_UNDEFINED</a>
(which discards the image&#8217;s pixels). The solution should work well and
improve performance regardless of the source layout.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_considered_solutions"><a class="anchor" href="#_considered_solutions"></a>2.2. Considered Solutions</h3>
<div class="ulist">
<ul>
<li>
<p><strong>A</strong>. Define a new read-only external queue family, such as
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VK_QUEUE_FAMILY_FOREIGN_READ_ONLY_EXT.html">VK_QUEUE_FAMILY_FOREIGN_READ_ONLY_EXT</a>.
When the application transfers ownership of a resource to this queue family,
it implicitly informs the implementation that the external queue will not
modify the resource&#8217;s external memory.</p>
</li>
<li>
<p><strong>B</strong>. Extend resource creation, such as <a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkImageCreateInfo.html">VkImageCreateInfo</a>,
with a new parameter that informs the implementation that no external queue
will modify the resource&#8217;s external memory.</p>
</li>
<li>
<p><strong>C</strong>. Extend the ownership-release memory barrier, such as
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkImageMemoryBarrier.html">VkImageMemoryBarrier</a>, with a new
parameter that informs the implementation that the resource&#8217;s external memory
will remain unmodified for the duration of the external queue family&#8217;s
ownership.</p>
</li>
<li>
<p><strong>D</strong>. Extend the ownership-acquire memory barrier, such as
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkImageMemoryBarrier.html">VkImageMemoryBarrier</a>, with a new
parameter that informs the implementation that the resource&#8217;s external memory
has remained unmodified since the most recent ownership-release.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_solution_analysis"><a class="anchor" href="#_solution_analysis"></a>2.3. Solution Analysis</h3>
<div class="paragraph">
<p>For analyzing the pros and cons of each solution, let us examine the life of
an external image that involves the following producers/consumers.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Vulkan application. It juggles the external image among the following
producers/consumers in addition to its own independent Vulkan rendering.</p>
</li>
<li>
<p>A video decoder.</p>
</li>
<li>
<p>A library that post-processes the image with Vulkan.
For example, the library may apply color correction or add dropshadows.
When the image is submitted to the library for post-processing, sometimes the
library applies changes to the image, sometimes the library returns the image
unchanged.</p>
</li>
<li>
<p>A presentation engine (such as a window system) that only reads the image
and never modifies it.
The application does not use Vulkan WSI to interact with the presentation
engine, such as <a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/vkCreateWaylandSurfaceKHR.html">vkCreateWaylandSurfaceKHR</a>,
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkSwapchainKHR.html">VkSwapchainKHR</a>, and
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/vkQueuePresentKHR.html">vkQueuePresentKHR</a>.
Instead, the application effectively implements these
functions itself with a combination of
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VK_EXT_external_memory_dma_buf.html">VK_EXT_external_memory_dma_buf</a>,
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VK_EXT_queue_family_foreign.html">VK_EXT_queue_family_foreign</a>,
and  native Wayland API from <code>libwayland-client</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The image is used in the following loop:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>a</strong>. Application&#8217;s Vulkan releases ownership of the image to the video decoder.</p>
</li>
<li>
<p><strong>b</strong>. Video decoder writes to the image, discarding all previous pixel data.</p>
</li>
<li>
<p><strong>c</strong>. Application&#8217;s Vulkan acquires ownership.</p>
</li>
<li>
<p><strong>d</strong>. Application&#8217;s Vulkan adds a visual effect to the image.</p>
</li>
<li>
<p><strong>e</strong>. Application&#8217;s Vulkan releases ownership to the post-processing library.</p>
</li>
<li>
<p><strong>f</strong>. Post-processing library works on the image. This step has two subcases:</p>
</li>
<li>
<p><strong>f.rw</strong>. Post-processing library modifies the image.</p>
</li>
<li>
<p><strong>f.ro</strong>. Post-processing library does not modify the image.</p>
</li>
<li>
<p><strong>g</strong>. Application&#8217;s Vulkan acquires ownership.</p>
</li>
<li>
<p><strong>h</strong>. Application&#8217;s Vulkan samples the image during full-scene composition.</p>
</li>
<li>
<p><strong>i</strong>. Application&#8217;s Vulkan releases ownership to the presentation engine.</p>
</li>
<li>
<p><strong>j</strong>. Application&#8217;s Vulkan acquires ownership.</p>
</li>
<li>
<p><strong>k</strong>. Loop. This step has two subcases:</p>
</li>
<li>
<p><strong>k.a</strong>. The video decoder is ready to provide a new frame. Goto (a).</p>
</li>
<li>
<p><strong>k.d</strong>. The video decoder is not yet ready. Goto (d).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Solution (B) is unusable in this workflow.</p>
</div>
<div class="paragraph">
<p>Solution (A) works well for steps (i, j, k) because the presentation engine is
read-only.
However, the solution is unusable at step (e) because the application does not
know yet whether step (f.rw) or (f.ro) will be taken.</p>
</div>
<div class="paragraph">
<p>Solution (<code>C</code>) is equivalent to (A) in this example scenario.</p>
</div>
<div class="paragraph">
<p>Solution (D) works well for all steps in the sequence. In particular, between
(f) and (g), the application can query the post-processing library, asking
whether (f.rw) or (f.ro) occurred. If (f.ro), the the application can add the
performance hint to <a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkImageMemoryBarrier.html">VkImageMemoryBarrier</a> in step (g).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proposal"><a class="anchor" href="#_proposal"></a>3. Proposal</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We propose API for solution (D).</p>
</div>
<div class="sect2">
<h3 id="_feature"><a class="anchor" href="#_feature"></a>3.1. Feature</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">// Extends `VkImageMemoryBarrier*` and `VkBufferMemoryBarrier*`.
typedef struct VkExternalMemoryAcquireUnmodifiedEXT {
    VkStructureType sType;
    const void* pNext;
    VkBool32 acquireUnmodifiedMemory;
} VkExternalMemoryAcquireUnmodifiedEXT;</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the application releases ownership of an external resource to an
external queue family and later re-acquires ownership, and the application
knows that resource&#8217;s external memory remained unmodified between the release
and acquire, then the application should chain
<code>VkExternalMemoryAcquireUnmodifiedEXT</code> into the acquire-operation&#8217;s memory
barrier and set <code>acquireUnmodifiedMemory = VK_TRUE</code>.</p>
</div>
<div class="paragraph">
<p>If <code>acquireUnmodifiedMemory</code> is <code>VK_FALSE</code>, then the Vulkan implementation
ignores the struct.
In particular, the struct in this case <em>does not</em> specify that the resource&#8217;s
external memory is modified, but rather that it is unknown whether it is
modified or not.</p>
</div>
<div class="paragraph">
<p>To allow flexibility in applications and layers, we propose allowing this
struct to be chained into any memory barrier for any resource.
If the memory barrier&#8217;s <code>srcQueueFamilyIndex</code> does not specify an external
queue family, then the Vulkan implementation ignores the struct.
This flexibility simplifies the implementation of layers that implement
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VkSwapchainKHR.html">VkSwapchainKHR</a> atop
<a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/VK_KHR_external_memory.html">VK_KHR_external_memory</a> and native
window system APIs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_caution"><a class="anchor" href="#_caution"></a>3.2. Caution</h3>
<div class="paragraph">
<p>Applications and libraries should not use "common sense" approaches to
determine whether an API has modified the resource.
They should make the determination solely with dedicated query APIs or with
specialist knowledge of the API&#8217;s implementation.</p>
</div>
<div class="paragraph">
<p><em>A counter-example for a "common sense" approach.</em>
Operations that appear to be read-only may be implemented as read-write.
Suppose the post-processing library discussed above wants to provide API that
allows the application to query, between steps (f) and (g), whether the library
has modified the image.
A deceptively straightforward, but incorrect, method of implementing the query
is to track all Vulkan API and SPIR-V instructions that accesses the image.
The query will report "unmodified" if and only if the library accessed the
image only with "read-only" Vulkan API and SPIR-V instructions.
In this method, examples of "read-only" access are SPIR-V instructions such as
<a href="https://www.khronos.org/registry/SPIR-V/specs/unified1/SPIRV.html#OpImageRead">OpImageRead</a>,
<a href="https://www.khronos.org/registry/SPIR-V/specs/unified1/SPIRV.html#OpImageFetch">OpImageFetch</a>,
and <a href="https://www.khronos.org/registry/SPIR-V/specs/unified1/SPIRV.html#OpImageSampleImplicitLod">OpImageSampleImplicitLod</a>,
and transfer commands such as <a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/man/html/vkCmdCopyImage.html">vkCmdCopyImage</a>.
Surprisingly, these operations may not be implemented as read-only.
The Vulkan implementation, before dispatching the "read-only" shader
or transfer command, may modify the image&#8217;s external memory
in order to improve the performance of the image reads,
or in order to coerce the image to use a memory layout
that is compatible with fickle hardware requirements.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_issues"><a class="anchor" href="#_issues"></a>4. Issues</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_resolved_out_of_scope_how_to_determine_if_a_resources_external_memory_is_modified"><a class="anchor" href="#_resolved_out_of_scope_how_to_determine_if_a_resources_external_memory_is_modified"></a>4.1. RESOLVED: OUT OF SCOPE. How to determine if a resource&#8217;s external memory is modified?</h3>
<div class="paragraph">
<p>This proposal does not provide a way for the application to query whether the
resource&#8217;s external memory was modified by an external queue family,
which is unfortunately necessary for the application to determine whether to set
<code>VkExternalMemoryAcquireUnmodifiedEXT::acquireUnmodifiedMemory</code>.</p>
</div>
<div class="paragraph">
<p>When the external queue family accesses the resource with non-Vulkan APIs, then
such queries are clearly outside the scope of Vulkan.
Each API that accesses the resource should provide its own query API.
It is a contradiction to define Vulkan API for this query because,
if Vulkan were able to determine whether a non-Vulkan API modified the
resource&#8217;s external memory,
then this extension would be unnecessary (see the problem statement).</p>
</div>
<div class="paragraph">
<p>However, when the external queue family accesses the image with Vulkan
then the query API should reasonably belong in Vulkan itself.
For example, in the post-processing library discussed above,
the library cannot provide a query API to the application
unless Vulkan itself provides a query API to the library.
In this proposal&#8217;s design discussions,
we agreed that designing such a query API is
significantly more complex than designing this proposal&#8217;s hint API.
Because this proposal&#8217;s feature is immediately useful
despite Vulkan lacking the query API, we agreed to postpone the design of the
query.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_further_functionality"><a class="anchor" href="#_further_functionality"></a>5. Further Functionality</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The natural complement to this proposal&#8217;s feature
is a feature that would provide the application a way to query
whether Vulkan itself has modified a resource&#8217;s external memory.
This feature is deferred to a future extension, as explained in the Issues
section.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <!--
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
    -->
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
  </body>
</html>
