<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VK_KHR_video_decode_queue :: Vulkan Documentation Project Demo</title>
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Vulkan Documentation Project Demo</a>
      <div class="navbar-item">
        <img alt="Vulkan White Label" src="../../../../_/Vulkan_White_Dec16.svg" height="100%" />
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label for="search-input"></label><input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <!-- <a class="navbar-item" href="#">Home</a> -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Specs</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../spec/latest/chapters/introduction.html">Vulkan 1.3</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Guides</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../guide/latest/index.html">Vulkan Guide</a>
          </div>
        </div>
            <!--
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Tools</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">TBD</a>
          </div>
        </div>
            -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Tutorial</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../tutorial/latest/index.html">Vulkan Tutorial</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Samples</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../samples/latest/README.html">Vulkan Samples</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Help</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://discord.gg/vulkan">Vulkan Discord</a>
            <a class="navbar-item" href="https://khr.io/khrdiscord">Khronos Discord</a>
          </div>
        </div>
            <!--
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
            -->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="spec" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../index.html">Vulkan Specification and Proposals</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/introduction.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/fundamentals.html">Fundamentals</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/initialization.html">Initialization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/devsandqueues.html">Devices and Queues</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/cmdbuffers.html">Command Buffers</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/synchronization.html">Synchronization and Cache Control</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/renderpass.html">Render Pass</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/shaders.html">Shaders</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/pipelines.html">Pipelines</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/memory.html">Memory Allocation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/resources.html">Resource Creation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/samplers.html">Samplers</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/descriptorsets.html">Resource Descriptors</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/interfaces.html">Shader Interfaces</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/textures.html">Image Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/fragmentdensitymapops.html">Fragment Density Map Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/queries.html">Queries</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/clears.html">Clear Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/copies.html">Copy Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/drawing.html">Drawing Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/fxvertex.html">Fixed-Function Vertex Processing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/tessellation.html">Tessellation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/geometry.html">Geometry Shading</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_NV_mesh_shader/mesh.html">Mesh Shading</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_HUAWEI_cluster_culling_shader/clusterculling.html">Cluster Culling Shading</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/vertexpostproc.html">Fixed-Function Vertex Post-Processing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/primsrast.html">Rasterization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/fragops.html">Fragment Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/framebuffer.html">The Framebuffer</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/dispatch.html">Dispatching Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_NV_device_generated_commands/generatedcommands.html">Device-Generated Commands</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/sparsemem.html">Sparse Resources</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_KHR_surface/wsi.html">Window System Integration (WSI)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_KHR_deferred_host_operations/deferred_host_operations.html">Deferred Host Operations</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_EXT_private_data.html">Private Data</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/accelstructures.html">Acceleration Structures</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_EXT_opacity_micromap/micromaps.html">Micromap</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/raytraversal.html">Ray Traversal</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/raytracing.html">Ray Tracing</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_NV_memory_decompression.html">Memory Decompression</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/video_extensions.html">Video Coding</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/VK_NV_optical_flow/optical_flow.html">Optical Flow</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/extensions.html">Extending Vulkan</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/features.html">Features</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/limits.html">Limits</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/formats.html">Formats</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/capabilities.html">Additional Capabilities</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../chapters/debugging.html">Debugging</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/spirvenv.html">Vulkan Environment for SPIR-V</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/memorymodel.html">Memory Model</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/compressedtex.html">Compressed Image Formats</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/versions.html">Core Revisions (Informative)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/extensions.html">Layers &amp; Extensions (Informative)</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/roadmap.html">Vulkan Roadmap Milestones</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/boilerplate.html">API Boilerplate</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/invariance.html">Invariance</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/glossary.html">Lexicon</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../appendices/credits.html">Credits (Informative)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Vulkan Proposals</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Vulkan Roadmap</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="Roadmap.html">Vulkan Roadmap</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Extension Proposals</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_AMD_shader_early_and_late_fragment_tests.html">VK_AMD_shader_early_and_late_fragment_tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_attachment_feedback_loop_layout.html">VK_EXT_attachment_feedback_loop_layout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_graphics_pipeline_library.html">VK_EXT_graphics_pipeline_library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_image_2d_array_of_3d.html">VK_EXT_image_2d_array_of_3d</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_image_compression_control.html">VK_EXT_image_compression_control</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_metal_objects.html">VK_EXT_metal_objects</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_multisampled_render_to_single_sampled.html">VK_EXT_multisampled_render_to_single_sampled</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_non_seamless_cube_map.html">VK_EXT_non_seamless_cube_map</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_primitives_generated_query.html">VK_EXT_primitives_generated_query</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_rasterization_order_attachment_access.html">VK_EXT_rasterization_order_attachment_access</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_shader_module_identifier.html">VK_EXT_shader_module_identifier</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_subpass_merge_feedback.html">VK_EXT_subpass_merge_feedback</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_GOOGLE_surfaceless_query.html">VK_GOOGLE_surfaceless_query</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_HUAWEI_invocation_mask.html">VK_HUAWEI_invocation_mask</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_dynamic_rendering.html">VK_KHR_dynamic_rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_fragment_shader_barycentric.html">VK_KHR_fragment_shader_barycentric</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_fragment_shading_rate.html">VK_KHR_fragment_shading_rate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_integer_dot_product.html">VK_KHR_shader_integer_dot_product</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_QCOM_image_processing.html">VK_QCOM_image_processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_QCOM_tile_properties.html">VK_QCOM_tile_properties</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Extension Proposal Template</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="template.html">Proposal Template</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Vulkan Specification and Proposals</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../guide/latest/index.html">Vulkan Guide</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../guide/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../samples/latest/README.html">Vulkan Samples</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../samples/latest/README.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../index.html">Vulkan Specification and Proposals</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../index.html">Vulkan Specification and Proposals</a></li>
    <li><a href="VK_KHR_video_decode_queue.html">VK_KHR_video_decode_queue</a></li>
  </ul>
</nav>
    <!--
  <div class="edit-this-page"><a href="https://github.com/KhronosGroup/Vulkan-Docs/edit/main/antora/modules/proposals/pages/proposals/VK_KHR_video_decode_queue.adoc">Edit this Page</a></div>
      -->
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">VK_KHR_video_decode_queue</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_problem_statement">1. Problem Statement</a></li>
<li><a href="#_solution_space">2. Solution Space</a></li>
<li><a href="#_proposal">3. Proposal</a>
<ul class="sectlevel2">
<li><a href="#_video_decode_queues">3.1. Video Decode Queues</a></li>
<li><a href="#_video_decode_profiles">3.2. Video Decode Profiles</a></li>
<li><a href="#_new_pipeline_stage_and_access_flags">3.3. New Pipeline Stage and Access Flags</a></li>
<li><a href="#_new_buffer_and_image_usage_flags">3.4. New Buffer and Image Usage Flags</a></li>
<li><a href="#_new_format_feature_flags">3.5. New Format Feature Flags</a></li>
<li><a href="#_basic_operation">3.6. Basic Operation</a></li>
<li><a href="#_decode_output_picture">3.7. Decode Output Picture</a></li>
<li><a href="#_reconstructed_picture">3.8. Reconstructed Picture</a></li>
<li><a href="#_reference_pictures">3.9. Reference Pictures</a></li>
<li><a href="#_capabilities">3.10. Capabilities</a></li>
<li><a href="#_usage_summary">3.11. Usage Summary</a></li>
</ul>
</li>
<li><a href="#_examples">4. Examples</a>
<ul class="sectlevel2">
<li><a href="#_select_queue_family_with_video_decode_support_for_a_given_video_codec_operation">4.1. Select queue family with video decode support for a given video codec operation</a></li>
<li><a href="#_check_support_and_query_the_capabilities_for_a_video_decode_profile">4.2. Check support and query the capabilities for a video decode profile</a></li>
<li><a href="#_select_decode_output_and_dpb_formats_supported_by_the_video_decode_profile">4.3. Select decode output and DPB formats supported by the video decode profile</a></li>
<li><a href="#_create_bitstream_buffer">4.4. Create bitstream buffer</a></li>
<li><a href="#_create_decode_output_image_and_image_view">4.5. Create decode output image and image view</a></li>
<li><a href="#_create_dpb_image_and_image_view">4.6. Create DPB image and image view</a></li>
<li><a href="#_record_decode_operation_without_reconstructed_picture_setup_or_reference_pictures">4.7. Record decode operation (without reconstructed picture setup or reference pictures)</a></li>
<li><a href="#_record_decode_operation_with_reconstructed_picture_setup_distinct_mode">4.8. Record decode operation with reconstructed picture setup (DISTINCT mode)</a></li>
<li><a href="#_record_decode_operation_with_reconstructed_picture_setup_coincide_mode">4.9. Record decode operation with reconstructed picture setup (COINCIDE mode)</a></li>
<li><a href="#_record_decode_operation_with_reference_picture_list">4.10. Record decode operation with reference picture list</a></li>
</ul>
</li>
<li><a href="#_issues">5. Issues</a>
<ul class="sectlevel2">
<li><a href="#_resolved_why_is_there_no_vk_pipeline_stage_video_decode_bit_khr">5.1. RESOLVED: Why is there no <code>VK_PIPELINE_STAGE_VIDEO_DECODE_BIT_KHR</code>?</a></li>
<li><a href="#_resolved_are_the_decode_output_picture_data_and_reconstructed_picture_data_used_to_activate_a_dpb_slot_written_to_the_same_resource">5.2. RESOLVED: Are the decode output picture data and reconstructed picture data used to activate a DPB slot written to the same resource?</a></li>
<li><a href="#_resolved_how_can_layered_codec_specific_decode_extensions_enable_applications_to_provide_the_necessary_codec_specific_picture_information_parameter_sets_etc_that_may_be_needed_to_perform_the_video_coding_operations">5.3. RESOLVED: How can layered codec-specific decode extensions enable applications to provide the necessary codec-specific picture information, parameter sets, etc. that may be needed to perform the video coding operations?</a></li>
<li><a href="#_resolved_can_vkcmdvideodecodekhr_only_decode_frames_what_about_field_decoding_slice_decoding_etc">5.4. RESOLVED: Can <code>vkCmdVideoDecodeKHR</code> only decode frames? What about field decoding, slice decoding, etc.?</a></li>
<li><a href="#_resolved_what_is_the_effect_of_the_flags_provided_in_vkvideodecodeusageinfokhrvideousagehints">5.5. RESOLVED: What is the effect of the flags provided in <code>VkVideoDecodeUsageInfoKHR::videoUsageHints</code>?</a></li>
</ul>
</li>
<li><a href="#_further_functionality">6. Further Functionality</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This document outlines a proposal to enable performing video decode operations in Vulkan.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_problem_statement"><a class="anchor" href="#_problem_statement"></a>1. Problem Statement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Integrating video decode operations into Vulkan applications enable a wide set of new usage scenarios including, but not limited to, the following examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Applying post-processing on top of video frames decoded from a compressed video stream</p>
</li>
<li>
<p>Sourcing dynamic texture data from compressed video streams</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is also not uncommon for Vulkan capable devices to feature dedicated hardware acceleration for video decompression.</p>
</div>
<div class="paragraph">
<p>The goal of this proposal is to enable these use cases, allow exposing the underlying hardware capabilities, and provide tight integration with other functionalities of the Vulkan API.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solution_space"><a class="anchor" href="#_solution_space"></a>2. Solution Space</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following options have been considered:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Rely on external sharing capabilities to interact with existing video decode APIs</p>
</li>
<li>
<p>Add new dedicated APIs to Vulkan specific to video decoding</p>
</li>
<li>
<p>Build upon a common set of APIs that enable video coding operations in general</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>As discussed in the proposal for the <code>VK_KHR_video_queue</code> extension, reusing a common, shared infrastructure across all video coding functionalities that leverage existing Vulkan capabilities was preferred, hence this extension follows option 3.</p>
</div>
<div class="paragraph">
<p>Further sub-options were considered whether a common set of APIs could be used to enable video decoding in general, upon which codec-specific extensions can be built. As the possibility of API reuse is similarly possible within the domain of video decoding as it is for video coding in general, this proposal follows the same principle to extend <code>VK_KHR_video_queue</code> with codec-independent video decoding capabilities.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proposal"><a class="anchor" href="#_proposal"></a>3. Proposal</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_video_decode_queues"><a class="anchor" href="#_video_decode_queues"></a>3.1. Video Decode Queues</h3>
<div class="paragraph">
<p>While <code>VK_KHR_video_queue</code> already includes support for a more fine grained query to determine the set of supported video codec operations for a given queue family, this extension introduces an explicit queue flag called <code>VK_QUEUE_VIDEO_DECODE_BIT_KHR</code> to indicate support for video decoding.</p>
</div>
<div class="paragraph">
<p>Applications can use this flag bit to identify video decode capable queue families in general, if needed, before querying more details about the individual video codec operations supported through the use of the <code>VkQueueFamilyVideoPropertiesKHR</code> structure. It also indicates support for the set of command buffer commands available on video decode queues, which include the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pipeline barrier and event handling commands used for synchronization</p>
</li>
<li>
<p>Basic query commands to begin, end, and reset queries</p>
</li>
<li>
<p>Timestamp write commands</p>
</li>
<li>
<p>Generic video coding commands</p>
</li>
<li>
<p>The new video decode command introduced by this extension</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the full list of individual commands supported by video decode queues, and whether any command is supported inside/outside of video coding scopes, refer to the manual page of the corresponding command.</p>
</div>
</div>
<div class="sect2">
<h3 id="_video_decode_profiles"><a class="anchor" href="#_video_decode_profiles"></a>3.2. Video Decode Profiles</h3>
<div class="paragraph">
<p>Video decode profiles are defined using a <code>VkVideoProfileInfoKHR</code> structure that specifies a <code>videoCodecOperation</code> value identifying a video decode operation. This extension does not introduce any video decode operation flags, as that is left to the codec-specific decode extensions.</p>
</div>
<div class="paragraph">
<p>On the other hand, this extension allows the application to specify usage hints specific to video decoding by chaining the following new structure to <code>VkVideoProfileInfoKHR</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">typedef struct VkVideoDecodeUsageInfoKHR {
    VkStructureType               sType;
    const void*                   pNext;
    VkVideoDecodeUsageFlagsKHR    videoUsageHints;
} VkVideoDecodeUsageInfoKHR;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The hint flags introduced by this extension are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>VK_VIDEO_DECODE_USAGE_TRANSCODING_BIT_KHR</code> should be used in video transcoding use cases</p>
</li>
<li>
<p><code>VK_VIDEO_DECODE_USAGE_OFFLINE_BIT_KHR</code> should be used when decoding local video content</p>
</li>
<li>
<p><code>VK_VIDEO_DECODE_USAGE_STREAMING_BIT_KHR</code> should be used when decoding video content streamed over network</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These usage hints do not provide any restrictions or guarantees, so any combination of flags can be used, but they allow the application to better communicate the intended use case scenario so that implementations can make appropriate choices based on it.</p>
</div>
<div class="paragraph">
<p>Logically, however, it is part of the video profile definition, so capabilities may vary across video decode profiles that only differ in terms of video decode usage hints, and it also affects video profile compatibility between resources and video sessions, so the same <code>VkVideoDecodeUsageInfoKHR</code> structure has to be included everywhere where the specific video decode profile is used.</p>
</div>
</div>
<div class="sect2">
<h3 id="_new_pipeline_stage_and_access_flags"><a class="anchor" href="#_new_pipeline_stage_and_access_flags"></a>3.3. New Pipeline Stage and Access Flags</h3>
<div class="paragraph">
<p>This extension also introduces a new pipeline stage identified by the <code>VK_PIPELINE_STAGE_2_VIDEO_DECODE_BIT_KHR</code> flag to enable synchronizing video decode operations with respect to other Vulkan operations.</p>
</div>
<div class="paragraph">
<p>In addition, two new access flags are introduced to indicate reads and writes, respectively, performed by the video decode pipeline stage:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>VK_ACCESS_2_VIDEO_DECODE_READ_BIT_KHR</code></p>
</li>
<li>
<p><code>VK_ACCESS_2_VIDEO_DECODE_WRITE_BIT_KHR</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As these flags did no longer fit into the legacy 32-bit enums, this extension requires the <code>VK_KHR_synchronization2</code> extension and relies on the 64-bit versions of the pipeline stage and access mask flags to handle synchronization specific to video decode operations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_new_buffer_and_image_usage_flags"><a class="anchor" href="#_new_buffer_and_image_usage_flags"></a>3.4. New Buffer and Image Usage Flags</h3>
<div class="paragraph">
<p>This extension introduces the following new buffer usage flags:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>VK_BUFFER_USAGE_VIDEO_DECODE_SRC_BIT_KHR</code> allows using the buffer as a video bitstream buffer in video decode operations</p>
</li>
<li>
<p><code>VK_BUFFER_USAGE_VIDEO_DECODE_DST_BIT_KHR</code> is reserved for future use</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This extension also introduces the following new image usage flags:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>VK_IMAGE_USAGE_VIDEO_DECODE_SRC_BIT_KHR</code> is reserved for future use</p>
</li>
<li>
<p><code>VK_IMAGE_USAGE_VIDEO_DECODE_DST_BIT_KHR</code> allows using the image as a decode output picture</p>
</li>
<li>
<p><code>VK_IMAGE_USAGE_VIDEO_DECODE_DPB_BIT_KHR</code> allows using the image as a decode DPB picture (reconstructed/reference picture)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Specifying these usage flags alone is not sufficient to create a buffer or image that is compatible to be used with a video session created against any particular video profile. In fact, when specifying any of these usage flags at resource creation time, the application has to include a <code>VkVideoProfileListInfoKHR</code> structure in the <code>pNext</code> chain of the corresponding create info structure that includes a video decode profile. The created resources will be compatible only with that single video decode profile (and any additional video encode profiles that may have been specified in the list).</p>
</div>
</div>
<div class="sect2">
<h3 id="_new_format_feature_flags"><a class="anchor" href="#_new_format_feature_flags"></a>3.5. New Format Feature Flags</h3>
<div class="paragraph">
<p>To indicate which formats are compatible with video decode usage, the following new format feature flags are introduced:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>VK_FORMAT_FEATURE_VIDEO_DECODE_OUTPUT_BIT_KHR</code> indicates support for decode output picture usage</p>
</li>
<li>
<p><code>VK_FORMAT_FEATURE_VIDEO_DECODE_DPB_BIT_KHR</code> indicates support for decode DPB picture usage</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The presence of the format flags alone, as returned by the various format queries, is not sufficient to indicate that an image with that format is usable with video decoding using any particular video decode profile. Actual compatibility with a specific video decode profile has to be verified using the <code>vkGetPhysicalDeviceVideoFormatPropertiesKHR</code> command.</p>
</div>
</div>
<div class="sect2">
<h3 id="_basic_operation"><a class="anchor" href="#_basic_operation"></a>3.6. Basic Operation</h3>
<div class="paragraph">
<p>Video decode operations can be recorded into command buffers allocated from command pools created against queue families that support the <code>VK_QUEUE_VIDEO_DECODE_BIT_KHR</code> flag.</p>
</div>
<div class="paragraph">
<p>Recording video decode operations happens through the use of the following new command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">VKAPI_ATTR void VKAPI_CALL vkCmdDecodeVideoKHR(
    VkCommandBuffer                             commandBuffer,
    const VkVideoDecodeInfoKHR*                 pDecodeInfo);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The common, codec-independent parameters of the video decode operation are provided using the following new structure:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">typedef struct VkVideoDecodeInfoKHR {
    VkStructureType                       sType;
    const void*                           pNext;
    VkVideoDecodeFlagsKHR                 flags;
    VkBuffer                              srcBuffer;
    VkDeviceSize                          srcBufferOffset;
    VkDeviceSize                          srcBufferRange;
    VkVideoPictureResourceInfoKHR         dstPictureResource;
    const VkVideoReferenceSlotInfoKHR*    pSetupReferenceSlot;
    uint32_t                              referenceSlotCount;
    const VkVideoReferenceSlotInfoKHR*    pReferenceSlots;
} VkVideoDecodeInfoKHR;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Executing such a video decode operation results in the decompression of a single picture (unless otherwise defined by layered extensions), and, if there is an active <code>VK_QUERY_TYPE_RESULT_STATUS_ONLY_KHR</code> query, the status of the video decode operation is recorded into the active query slot.</p>
</div>
<div class="paragraph">
<p>If the decode operation requires additional codec-specific parameters, then such parameters are provided in the <code>pNext</code> chain of the structure above. Whether such codec-specific information is necessary, and what it may contain is up to the codec-specific extensions.</p>
</div>
<div class="paragraph">
<p><code>srcBuffer</code>, <code>srcBufferOffset</code>, and <code>srcBufferRange</code> provide information about the used video bitstream buffer range. The video decode operation reads the compressed picture data from this buffer range.</p>
</div>
<div class="paragraph">
<p>The application has to create the video bitstream buffer with the new <code>VK_BUFFER_USAGE_VIDEO_DECODE_SRC_BIT_KHR</code> usage flag, and must also include the used video session&#8217;s video profile in the <code>VkVideoProfileListInfoKHR</code> structure specified at buffer creation time.</p>
</div>
<div class="paragraph">
<p>The expected contents of the video bitstream buffer range depends on the specific video codec used, as defined by corresponding codec-specific extensions built upon this proposal.</p>
</div>
<div class="paragraph">
<p>The <code>dstPictureResource</code>, <code>pSetupReferenceSlot</code>, and <code>pReferenceSlots</code> members specify the decode output picture, reconstructed picture, and reference pictures, respectively, used by the video decode operation, as discussed in later sections of this proposal.</p>
</div>
</div>
<div class="sect2">
<h3 id="_decode_output_picture"><a class="anchor" href="#_decode_output_picture"></a>3.7. Decode Output Picture</h3>
<div class="paragraph">
<p><code>dstPictureResource</code> defines the parameters of the video picture resource to use as the decode output picture. The video decode operation writes the picture data resulting from the decompression of the bitstream data to this video picture resource. As such it is a mandatory parameter of the operation.</p>
</div>
<div class="paragraph">
<p>The application has to create the image view specified in <code>dstPictureResource.imageViewBinding</code> with the new <code>VK_IMAGE_USAGE_VIDEO_DECODE_DST_BIT_KHR</code> usage flag, and must also include the used video session&#8217;s video profile in the <code>VkVideoProfileListInfoKHR</code> structure specified at image creation time.</p>
</div>
<div class="paragraph">
<p>The image subresource backing the decode output picture has to be in the new <code>VK_IMAGE_LAYOUT_VIDEO_DECODE_DST_KHR</code> layout at the time the video decode operation is executed, except if it matches the reconstructed picture, as discussed later, in which case the image subresource has to be in the new <code>VK_IMAGE_LAYOUT_VIDEO_DECODE_DPB_KHR</code> layout.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reconstructed_picture"><a class="anchor" href="#_reconstructed_picture"></a>3.8. Reconstructed Picture</h3>
<div class="paragraph">
<p><code>pSetupReferenceSlot</code> is an optional parameter specifying the video picture resource to use as the reconstructed picture and the DPB slot index to activate with it. Content-wise, a reconstructed picture is generally identical to the decode output picture, but unlike the latter, the reconstructed picture can be used as a reference picture in future video decode operations, hence it is a picture that is part of the DPB.</p>
</div>
<div class="paragraph">
<p>When a non-<code>NULL</code> <code>pSetupReferenceSlot</code> is specified, the DPB slot identified by its <code>slotIndex</code> member is activated with the video picture resource specified by its <code>pPictureResource</code> member. Hence this parameter can be used to add new reference pictures to the DPB, and change the association between DPB slot indices and video picture resources. That also implies that the application has to specify a video picture resource in <code>pSetupReferenceSlot&#8594;pPictureResource</code> that was included in the set of bound reference picture resources specified when the video coding scope was started (in one of the elements of <code>VkVideoBeginCodingInfoKHR::pReferenceSlots</code>). No similar requirement exists for the decode output picture specified by <code>dstPictureResource</code> which can refer to any video picture resource.</p>
</div>
<div class="paragraph">
<p>The application has to create the image view specified in <code>pSetupReferenceSlot&#8594;pPictureResource&#8594;imageViewBinding</code> with the new <code>VK_IMAGE_USAGE_VIDEO_DECODE_DPB_BIT_KHR</code> usage flag, and must also include the used video session&#8217;s video profile in the <code>VkVideoProfileListInfoKHR</code> structure specified at image creation time.</p>
</div>
<div class="paragraph">
<p>The image subresource backing the reconstructed picture has to be in the new <code>VK_IMAGE_LAYOUT_VIDEO_DECODE_DPB_KHR</code> layout at the time the video decode operation is executed.</p>
</div>
<div class="paragraph">
<p>Implementations diverge in the way they handle reconstructed pictures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On some implementations the decode output picture and reconstructed picture have to be <em>distinct</em> video picture resources, even if the picture data written by the video decode operation to the two resources is identical.</p>
</li>
<li>
<p>On other implementations the decode output picture and reconstructed picture have to <em>coincide</em>, i.e. both have to refer to the same video picture resource.</p>
</li>
<li>
<p>Some other implementations may actually support both modes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Support for the individual modes is indicated by the <code>VK_VIDEO_DECODE_CAPABILITY_DPB_AND_OUTPUT_COINCIDE_BIT_KHR</code> and <code>VK_VIDEO_DECODE_CAPABILITY_DPB_AND_OUTPUT_DISTINCT_BIT_KHR</code> capability flags. Implementations are only required to support one of the two modes, hence portable applications have to make sure that they support both options. Dealing with this implementation divergence, however, is fairly simple.</p>
</div>
<div class="paragraph">
<p>Generally speaking, the application has to create the following images in order to decode a video stream:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One or more images that will contain the reference pictures associated with the DPB.</p>
</li>
<li>
<p>An additional image usable as the decode output picture (if not all decoded pictures are expected to be stored in the DPB).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The application should always create the image(s) backing the DPB with the <code>VK_IMAGE_USAGE_VIDEO_DECODE_DPB_BIT_KHR</code> usage flag. If only the <em>coincide</em> mode is supported for reconstructed pictures, then the DPB image(s) that may be used as a reconstructed picture in a video decode operation have to also include the <code>VK_IMAGE_USAGE_VIDEO_DECODE_DST_KHR</code> usage flag to allow them to be used as coinciding decode output and reconstructed pictures.</p>
</div>
<div class="paragraph">
<p>The image backing the decode output picture should always be created with the <code>VK_IMAGE_USAGE_VIDEO_DECODE_DST_BIT_KHR</code> usage flag.</p>
</div>
<div class="paragraph">
<p>The DPB image(s) are expected to be in the <code>VK_IMAGE_LAYOUT_VIDEO_DECODE_DPB_KHR</code> layout while in use by video decode operations, while the decode output image is expected to be in the <code>VK_IMAGE_LAYOUT_VIDEO_DECODE_DST_KHR</code> layout.</p>
</div>
<div class="paragraph">
<p>Now we have two cases to consider:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When a reconstructed picture needs to be specified (as the picture is expected to be used as a reference picture later on); and</p>
</li>
<li>
<p>When one is not needed (<code>pSetupReferenceSlot = NULL</code>)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In case of (2), the application can use the image created for the decode output picture in <code>dstPictureResource</code>, indifferent of whether the <em>distinct</em> or <em>coincide</em> mode is used.</p>
</div>
<div class="paragraph">
<p>In case of (1), the behavior is as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In <em>distinct</em> mode the decode output picture&#8217;s image should be used in <code>dstPictureResource</code>, and (one of) the DPB image(s) should be referred to in <code>pSetupReferenceSlot</code>, as it would naturally follow.</p>
</li>
<li>
<p>In <em>coincide</em> mode both <code>dstPictureResource</code> and <code>pSetupReferenceSlot</code> should refer to a video picture resource in (one of) the DPB image(s).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the latter situation the decoded picture will be written only to the DPB image, and the image created for decode-output-only use remains unused. If the application wants to concurrently use the decoded picture while also performing video decode operations using the same picture as reference, it can manually copy the decoded picture stored in the DPB image to the otherwise unused decode output image, if needed. This way it practically mimics the behavior of an implementation supporting the <em>distinct</em> mode. However, in most use cases that is not necessary, hence on implementations supporting the <em>coincide</em> mode the application can avoid having two copies of the decoded pictures, even if they are used as reference pictures later on.</p>
</div>
<div class="paragraph">
<p>If the video profile in use requires additional codec-specific parameters for the reconstructed picture, then such parameters are provided in the <code>pNext</code> chain of <code>pSetupReferenceSlot</code>. Whether such codec-specific reconstructed picture information is necessary, and what it may contain is up to the codec-specific extensions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_reference_pictures"><a class="anchor" href="#_reference_pictures"></a>3.9. Reference Pictures</h3>
<div class="paragraph">
<p>If the video session allows, reference pictures can be specified in the <code>pReferenceSlots</code> array to provide predictions of the values of samples of the decoded picture.</p>
</div>
<div class="paragraph">
<p>Each entry in the <code>pReferenceSlots</code> array adds one or more pictures, currently associated with the DPB slot specified in the element&#8217;s <code>slotIndex</code> member and stored in the video picture specified in the element&#8217;s <code>pPictureResource</code> member, to the list of active reference pictures to use in the video decode operation.</p>
</div>
<div class="paragraph">
<p>The application has to make sure to specify each video picture resource used as a reference picture in a video decode operation, beforehand, in the set of bound reference picture resources specified when the video coding scope was started (in one of the elements of <code>VkVideoBeginCodingInfoKHR::pReferenceSlots</code>).</p>
</div>
<div class="paragraph">
<p>The application has to create the image view specified in <code>pPictureResource&#8594;imageViewBinding</code> of the elements of <code>pReferenceSlots</code> with the new <code>VK_IMAGE_USAGE_VIDEO_DECODE_DPB_BIT_KHR`</code> usage flag, and must also include the used video session’s video profile in the <code>VkVideoProfileListInfoKHR</code> structure specified at image creation time.</p>
</div>
<div class="paragraph">
<p>The image subresources backing the reference pictures have to be in the new <code>VK_IMAGE_LAYOUT_VIDEO_DECODE_DPB_KHR</code> layout at the time the video decode operation is executed.</p>
</div>
<div class="paragraph">
<p>Typically the number of elements in <code>pReferenceSlots</code> equals the number of reference pictures added, but in certain cases (depending on the used video codec and video profile) there may be multiple pictures in the same DPB slot resource.</p>
</div>
<div class="paragraph">
<p>If the video profile in use requires additional codec-specific parameters for the reference pictures, then such parameters are provided in the <code>pNext</code> chain of the elements of <code>pReferenceSlots</code>. Whether such codec-specific reference picture information is necessary, and what it may contain is up to the codec-specific extensions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_capabilities"><a class="anchor" href="#_capabilities"></a>3.10. Capabilities</h3>
<div class="paragraph">
<p>Querying capabilities specific to video decoding happens through the query mechanisms introduced by the <code>VK_KHR_video_queue</code> extension.</p>
</div>
<div class="paragraph">
<p>Support for individual video decode operations can be retrieved for each queue family using the <code>VkQueueFamilyVideoPropertiesKHR</code> structure, as discussed earlier.</p>
</div>
<div class="paragraph">
<p>The application can also use the <code>vkGetPhysicalDeviceVideoCapabilitiesKHR</code> command to query the capabilities of a specific video decode profile. In case of video decode profiles, the following new structure has to be included in the <code>pNext</code> chain of the <code>VkVideoCapabilitiesKHR</code> structure used to retrieve the general video decode capabilities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">typedef struct VkVideoDecodeCapabilitiesKHR {
    VkStructureType                    sType;
    void*                              pNext;
    VkVideoDecodeCapabilityFlagsKHR    flags;
} VkVideoDecodeCapabilitiesKHR;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This structure only contains a new decode-specific <code>flags</code> member that indicates support for various video decode capabilities, like the support for the <em>distinct</em> and <em>coincide</em> modes for reconstructed pictures, as discussed earlier.</p>
</div>
<div class="paragraph">
<p>The <code>vkGetPhysicalDeviceVideoFormatPropertiesKHR</code> command can be used to query the supported image/picture formats for a given set of video profiles, as described in the <code>VK_KHR_video_queue</code> extension.</p>
</div>
<div class="paragraph">
<p>In particular, if the application would like to query the list of format properties supported for decode output pictures, then it should include the new <code>VK_IMAGE_USAGE_VIDEO_DECODE_DST_BIT_KHR</code> usage flag in <code>VkPhysicalDeviceVideoFormatInfoKHR::imageUsage</code>.</p>
</div>
<div class="paragraph">
<p>Similarly, to query the list of format properties supported for decode DPB pictures (reconstructed/reference pictures), then it should include the new <code>VK_IMAGE_USAGE_VIDEO_DECODE_DPB_BIT_KHR</code> usage flag in <code>VkPhysicalDeviceVideoFormatInfoKHR::imageUsage</code>.</p>
</div>
<div class="paragraph">
<p>When using the <em>coincide</em> mode, the application will need DPB pictures that support both decode output and DPB usage, hence it should call <code>vkGetPhysicalDeviceVideoFormatPropertiesKHR</code> with <code>VkPhysicalDeviceVideoFormatInfoKHR::imageUsage</code> including both <code>VK_IMAGE_USAGE_VIDEO_DECODE_DST_BIT_KHR</code> and <code>VK_IMAGE_USAGE_VIDEO_DECODE_DPB_BIT_KHR</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_usage_summary"><a class="anchor" href="#_usage_summary"></a>3.11. Usage Summary</h3>
<div class="paragraph">
<p>To summarize the usage of the video decoding features introduced by this extension, let us take a look at a typical usage scenario when using this extension to decode a video stream.</p>
</div>
<div class="paragraph">
<p>Before the application can start recording command buffers with video decode operations, it has to do the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensure that the implementation can decode the video content at hand by first querying the video codec operations supported by each queue family using the <code>vkGetPhysicalDeviceQueueFamilyProperties2</code> command and the <code>VkQueueFamilyVideoPropertiesKHR</code> output structure.</p>
</li>
<li>
<p>If needed, the application has to also retrieve the <code>VkQueueFamilyQueryResultStatusPropertiesKHR</code> output structure for the queue family to check support for <code>VK_QUERY_TYPE_RESULT_STATUS_ONLY_KHR</code> queries.</p>
</li>
<li>
<p>Construct the <code>VkVideoProfileInfoKHR</code> structure describing the entire video profile, including the video codec operation, chroma subsampling, bit depths, and any other usage or codec-specific parameters.</p>
</li>
<li>
<p>Ensure that the specific video profile is supported by the implementation using the <code>vkGetPhysicalDeviceVideoCapabilitiesKHR</code> command and retrieve the general, decode-specific, and codec-specific capabilities at the same time.</p>
</li>
<li>
<p>Query the list of supported image/picture format properties supported for the video profile using the <code>vkGetPhysicalDeviceVideoFormatPropertiesKHR</code> structure, and select a suitable format for the DPB and decode output pictures.</p>
</li>
<li>
<p>Create an image corresponding to the decode output picture with the appropriate usage flags and video profile list, as described earlier, and bind suitable device memory to the image. Also create an image view with the appropriate usage flags to use in the video decode operations.</p>
</li>
<li>
<p>If needed, create one or more images corresponding to the DPB pictures with the appropriate usage flags and video profile list, as described earlier, and bind suitable device memory to them. Also create any image views with the appropriate usage flags to use in the video decode operations.</p>
</li>
<li>
<p>Create a buffer with the <code>VK_BUFFER_USAGE_VIDEO_DECODE_SRC_BIT_KHR</code> usage flag and the video profile list, to use as the source video bitstream buffer. If the buffer is expected to be populated using the CPU, consider binding compatible host-visible device memory to the buffer.</p>
</li>
<li>
<p>If result status queries are needed and supported (as determined earlier), create a query pool with the <code>VK_QUERY_TYPE_RESULT_STATUS_ONLY_KHR</code> query type and the used video decode profile.</p>
</li>
<li>
<p>Create the video session using the video decode profile and appropriate parameters within the capabilities supported by the profile, as determined earlier. Bind suitable device memory to each memory binding index of the video session.</p>
</li>
<li>
<p>If needed, create a video session parameters object for the video session.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Recording video decode operations into command buffers typically consists of the following sequence:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Start a video coding scope with the created video session (and parameters) object using the <code>vkCmdBeginVideoCodingKHR</code> command. Make sure to include all video picture resources in <code>VkVideoBeginCodingInfoKHR::pReferenceSlots</code> that may be used as reconstructed or reference pictures within the video coding scope, and ensure that the DPB slots specified for each reflect the current DPB slot association for the resource.</p>
</li>
<li>
<p>If this is the first video coding scope the video session is used in, reset the video session to the initial state by recording a <code>vkCmdControlVideoCodingKHR</code> command with the <code>VK_VIDEO_CODING_CONTROL_RESET_BIT_KHR</code> flag.</p>
</li>
<li>
<p>If needed, start a <code>VK_QUERY_TYPE_RESULT_STATUS_ONLY_KHR</code> query using <code>vkCmdBeginQuery</code>. Reset the query using <code>vkCmdResetQueryPool</code>, beforehand, as needed.</p>
</li>
<li>
<p>Issue a video decode operation using the <code>vkCmdDecodeVideoKHR</code> command with appropriate parameters, as discussed earlier.</p>
</li>
<li>
<p>If needed, end the started query using <code>vkCmdEndQuery</code>.</p>
</li>
<li>
<p>Record any further control or decode operations into the video coding scope, as needed.</p>
</li>
<li>
<p>End the video coding scope using the <code>vkCmdEndVideoCodingKHR</code> command.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_examples"><a class="anchor" href="#_examples"></a>4. Examples</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_select_queue_family_with_video_decode_support_for_a_given_video_codec_operation"><a class="anchor" href="#_select_queue_family_with_video_decode_support_for_a_given_video_codec_operation"></a>4.1. Select queue family with video decode support for a given video codec operation</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">VkVideoCodecOperationFlagBitsKHR neededVideoDecodeOp = ...
uint32_t queueFamilyIndex;
uint32_t queueFamilyCount;

vkGetPhysicalDeviceQueueFamilyProperties2(physicalDevice, &amp;queueFamilyCount, NULL);

VkQueueFamilyProperties2* props = calloc(queueFamilyCount,
    sizeof(VkQueueFamilyProperties2));
VkQueueFamilyVideoPropertiesKHR* videoProps = calloc(queueFamilyCount,
    sizeof(VkQueueFamilyVideoPropertiesKHR));

for (queueFamilyIndex = 0; queueFamilyIndex &lt; queueFamilyCount; ++queueFamilyIndex) {
    props[queueFamilyIndex].sType = VK_STRUCTURE_TYPE_QUEUE_FAMILY_PROPERTIES_2;
    props[queueFamilyIndex].pNext = &amp;videoProps[queueFamilyIndex];

    videoProps[queueFamilyIndex].sType = VK_STRUCTURE_TYPE_QUEUE_FAMILY_VIDEO_PROPERTIES_KHR;
}

vkGetPhysicalDeviceQueueFamilyProperties2(physicalDevice, &amp;queueFamilyCount, props);

for (queueFamilyIndex = 0; queueFamilyIndex &lt; queueFamilyCount; ++queueFamilyIndex) {
    if ((props[queueFamilyIndex].queueFamilyProperties.queueFlags &amp; VK_QUEUE_VIDEO_DECODE_BIT_KHR) != 0 &amp;&amp;
        (videoProps[queueFamilyIndex].videoCodecOperations &amp; neededVideoDecodeOp) != 0) {
        break;
    }
}

if (queueFamilyIndex &lt; queueFamilyCount) {
    // Found appropriate queue family
    ...
} else {
    // Did not find a queue family with the needed capabilities
    ...
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_check_support_and_query_the_capabilities_for_a_video_decode_profile"><a class="anchor" href="#_check_support_and_query_the_capabilities_for_a_video_decode_profile"></a>4.2. Check support and query the capabilities for a video decode profile</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">VkResult result;

// We also include the optional decode usage hints here
VkVideoDecodeUsageInfoKHR profileUsageInfo = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_DECODE_USAGE_INFO_KHR,
    .pNext = ... // pointer to codec-specific profile structure
    .videoUsageHints = VK_VIDEO_DECODE_USAGE_DEFAULT_KHR,
};

VkVideoProfileInfoKHR profileInfo = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_PROFILE_INFO_KHR,
    .pNext = &amp;profileUsageInfo
    .videoCodecOperation = ... // used video decode operation
    .chromaSubsampling = VK_VIDEO_CHROMA_SUBSAMPLING_420_BIT_KHR,
    .lumaBitDepth = VK_VIDEO_COMPONENT_BIT_DEPTH_8_BIT_KHR,
    .chromaBitDepth = VK_VIDEO_COMPONENT_BIT_DEPTH_8_BIT_KHR
};

VkVideoDecodeCapabilitiesKHR decodeCapabilities = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_DECODE_CAPABILITIES_KHR,
    .pNext = ... // pointer to codec-specific capability structure
}

VkVideoCapabilitiesKHR capabilities = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_CAPABILITIES_KHR,
    .pNext = &amp;decodeCapabilities
};

result = vkGetPhysicalDeviceVideoCapabilitiesKHR(physicalDevice, &amp;profileInfo, &amp;capabilities);

if (result == VK_SUCCESS) {
    // Profile is supported, check additional capabilities
    ...
} else {
    // Profile is not supported, result provides additional information about why
    ...
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_select_decode_output_and_dpb_formats_supported_by_the_video_decode_profile"><a class="anchor" href="#_select_decode_output_and_dpb_formats_supported_by_the_video_decode_profile"></a>4.3. Select decode output and DPB formats supported by the video decode profile</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">VkVideoProfileInfoKHR profileInfo = {
    ...
};

VkVideoProfileListInfoKHR profileListInfo = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_PROFILE_LIST_INFO_KHR,
    .pNext = NULL,
    .profileCount = 1,
    .pProfiles = &amp;profileInfo
};

VkPhysicalDeviceVideoFormatInfoKHR formatInfo = {
    .sType = VK_STRUCTURE_TYPE_PHYSICAL_DEVICE_VIDEO_FORMAT_INFO_KHR,
    .pNext = &amp;profileListInfo
};

VkVideoFormatPropertiesKHR* formatProps = NULL;

// First query decode output formats
formatInfo.imageUsage = VK_IMAGE_USAGE_VIDEO_DECODE_DST_BIT_KHR;

vkGetPhysicalDeviceVideoFormatPropertiesKHR(physicalDevice, &amp;formatInfo, &amp;formatCount, NULL);
formatProps = calloc(formatCount, sizeof(VkVideoFormatPropertiesKHR));
for (uint32_t i = 0; i &lt; formatCount; ++i) {
    formatProps.sType = VK_STRUCTURE_TYPE_VIDEO_FORMAT_PROPERTIES_KHR;
}
vkGetPhysicalDeviceVideoFormatPropertiesKHR(physicalDevice, &amp;formatInfo, &amp;formatCount, formatProps);

for (uint32_t i = 0; i &lt; formatCount; ++i) {
    // Select decode output format and image creation capabilities best suited for the use case
    ...
}
free(formatProps);

// Then query DPB formats
formatInfo.imageUsage = VK_IMAGE_USAGE_VIDEO_DECODE_DPB_BIT_KHR;

// If DISTINCT mode is not supported or if COINCIDE mode is supported and preferred, then the DPB
// images generally have to be created to be usable both as decode output and DPB pictures
if ((decodeCapabilities.flags &amp; VK_VIDEO_DECODE_CAPABILITY_DPB_AND_OUTPUT_DISTINCT_BIT_KHR) == 0 || preferCoincideMode) {
    formatInfo.imageUsage |= VK_IMAGE_USAGE_VIDEO_DECODE_DST_BIT_KHR;
}

vkGetPhysicalDeviceVideoFormatPropertiesKHR(physicalDevice, &amp;formatInfo, &amp;formatCount, NULL);
formatProps = calloc(formatCount, sizeof(VkVideoFormatPropertiesKHR));
for (uint32_t i = 0; i &lt; formatCount; ++i) {
    formatProps.sType = VK_STRUCTURE_TYPE_VIDEO_FORMAT_PROPERTIES_KHR;
}
vkGetPhysicalDeviceVideoFormatPropertiesKHR(physicalDevice, &amp;formatInfo, &amp;formatCount, formatProps);

for (uint32_t i = 0; i &lt; formatCount; ++i) {
    // Select DPB format and image creation capabilities best suited for the use case
    ...
}
free(formatProps);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_bitstream_buffer"><a class="anchor" href="#_create_bitstream_buffer"></a>4.4. Create bitstream buffer</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">VkBuffer bitstreamBuffer = VK_NULL_HANDLE;

VkVideoProfileListInfoKHR profileListInfo = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_PROFILE_LIST_INFO_KHR,
    .pNext = NULL,
    .profileCount = ... // number of video profiles to use the bitstream buffer with
    .pProfiles = ... // pointer to an array of video profile information structure chains
};

VkBufferCreateInfo createInfo = {
    .sType = VK_STRUCTURE_TYPE_BUFFER_CREATE_INFO,
    .pNext = &amp;profileListInfo,
    ...
    .usage = VK_BUFFER_USAGE_VIDEO_DECODE_SRC_BIT_KHR | ... // any other usages that may be needed
    ...
};

vkCreateBuffer(device, &amp;createInfo, NULL, &amp;bitstreamBuffer);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_decode_output_image_and_image_view"><a class="anchor" href="#_create_decode_output_image_and_image_view"></a>4.5. Create decode output image and image view</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">VkImage outputImage = VK_NULL_HANDLE;
VkImageView outputImageView = VK_NULL_HANDLE;

VkVideoProfileListInfoKHR profileListInfo = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_PROFILE_LIST_INFO_KHR,
    .pNext = NULL,
    .profileCount = ... // number of video profiles to use the decode output image with
    .pProfiles = ... // pointer to an array of video profile information structure chains
};

VkImageCreateInfo imageCreateInfo = {
    .sType = VK_STRUCTURE_TYPE_IMAGE_CREATE_INFO,
    .pNext = &amp;profileListInfo,
    ...
    .usage = VK_IMAGE_USAGE_VIDEO_DECODE_DST_BIT_KHR | ... // any other usages that may be needed
    ...
};

vkCreateImage(device, &amp;imageCreateInfo, NULL, &amp;outputImage);

VkImageViewUsageCreateInfo imageViewUsageInfo = {
    .sType = VK_STRUCTURE_TYPE_IMAGE_VIEW_USAGE_CREATE_INFO,
    .pNext = NULL,
    .usage = VK_IMAGE_USAGE_VIDEO_DECODE_DST_BIT_KHR
};

VkImageViewCreateInfo imageViewCreateInfo = {
    .sType = VK_STRUCTURE_TYPE_IMAGE_VIEW_CREATE_INFO,
    .pNext = &amp;imageViewUsageInfo,
    .flags = 0,
    .image = outputImage,
    .viewType = ... // image view type (only 2D or 2D_ARRAY is supported)
    ... // other image view creation parameters
};

vkCreateImageView(device, &amp;imageViewCreateInfo, NULL, &amp;outputImageView);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_dpb_image_and_image_view"><a class="anchor" href="#_create_dpb_image_and_image_view"></a>4.6. Create DPB image and image view</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">// NOTE: This example creates a single image and image view that is used to back all DPB pictures
// but, depending on the support of the VK_VIDEO_CAPABILITY_SEPARATE_REFERENCE_IMAGES_BIT_KHR
// capability flag, the application can choose to create separate images for each DPB slot or
// picture

VkImage dpbImage = VK_NULL_HANDLE;
VkImageView dpbImageView = VK_NULL_HANDLE;

VkImageUsage dpbImageUsage = VK_IMAGE_USAGE_VIDEO_DECODE_DPB_BIT_KHR;

// If DISTINCT mode is not supported or if COINCIDE mode is supported and preferred, then the DPB
// images generally have to be created to be usable both as decode output and DPB pictures
if ((decodeCapabilities.flags &amp; VK_VIDEO_DECODE_CAPABILITY_DPB_AND_OUTPUT_DISTINCT_BIT_KHR) == 0 || preferCoincideMode) {
    dpbImageUsage |= VK_IMAGE_USAGE_VIDEO_DECODE_DST_BIT_KHR;
}


VkVideoProfileListInfoKHR profileListInfo = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_PROFILE_LIST_INFO_KHR,
    .pNext = NULL,
    .profileCount = ... // number of video profiles to use the decode DPB image with
    .pProfiles = ... // pointer to an array of video profile information structure chains
};

VkImageCreateInfo imageCreateInfo = {
    .sType = VK_STRUCTURE_TYPE_IMAGE_CREATE_INFO,
    .pNext = &amp;profileListInfo,
    ...
    .usage = dpbImageUsage | ... // any other usages that may be needed
    ...
    .arrayLayers = // typically equal to the DPB slot count
};

vkCreateImage(device, &amp;imageCreateInfo, NULL, &amp;dpbImage);

VkImageViewUsageCreateInfo imageViewUsageInfo = {
    .sType = VK_STRUCTURE_TYPE_IMAGE_VIEW_USAGE_CREATE_INFO,
    .pNext = NULL,
    .usage = dpbImageUsage
};

VkImageViewCreateInfo imageViewCreateInfo = {
    .sType = VK_STRUCTURE_TYPE_IMAGE_VIEW_CREATE_INFO,
    .pNext = &amp;imageViewUsageInfo,
    .flags = 0,
    .image = dpbImage,
    .viewType = ... // image view type (only 2D or 2D_ARRAY is supported)
    ... // other image view creation parameters
};

vkCreateImageView(device, &amp;imageViewCreateInfo, NULL, &amp;dpbImageView);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_record_decode_operation_without_reconstructed_picture_setup_or_reference_pictures"><a class="anchor" href="#_record_decode_operation_without_reconstructed_picture_setup_or_reference_pictures"></a>4.7. Record decode operation (without reconstructed picture setup or reference pictures)</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">vkCmdBeginVideoCodingKHR(commandBuffer, ...);

VkVideoPictureResourceInfoKHR decodeOutputPictureResource = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_PICTURE_RESOURCE_INFO_KHR,
    .pNext = NULL,
    .codedOffset = ... // offset within the image subresource (typically { 0, 0 })
    .codedExtent = ... // extent of decoded picture (typically the video frame size)
    .baseArrayLayer = 0,
    .imageViewBinding = outputImageView
};

VkVideoDecodeInfoKHR decodeInfo = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_DECODE_INFO_KHR,
    .pNext = ... // pointer to codec-specific picture information structure
    .flags = 0,
    .srcBuffer = bitstreamBuffer,
    .srcBufferOffset = ... // offset of picture data in the video bitstream buffer
    .srcBufferRange = ... // size of picture data in the video bitstream buffer
    .dstPictureResource = decodeOutputPictureResource,
    .pSetupReferenceSlot = NULL,
    .referenceSlotCount = 0,
    .pReferenceSlots = NULL
};

vkCmdDecodeVideoKHR(commandBuffer, &amp;decodeInfo);

vkCmdEndVideoCodingKHR(commandBuffer, ...);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_record_decode_operation_with_reconstructed_picture_setup_distinct_mode"><a class="anchor" href="#_record_decode_operation_with_reconstructed_picture_setup_distinct_mode"></a>4.8. Record decode operation with reconstructed picture setup (DISTINCT mode)</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">// Bound reference resource list provided has to include reconstructed picture resource
vkCmdBeginVideoCodingKHR(commandBuffer, ...);

VkVideoPictureResourceInfoKHR decodeOutputPictureResource = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_PICTURE_RESOURCE_INFO_KHR,
    .pNext = NULL,
    .codedOffset = ... // offset within the image subresource (typically { 0, 0 })
    .codedExtent = ... // extent of decoded picture (typically the video frame size)
    .baseArrayLayer = 0,
    .imageViewBinding = outputImageView
};

VkVideoPictureResourceInfoKHR reconstructedPictureResource = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_PICTURE_RESOURCE_INFO_KHR,
    .pNext = NULL,
    .codedOffset = ... // offset within the image subresource (typically { 0, 0 })
    .codedExtent = ... // extent of reconstructed picture (typically the video frame size)
    .baseArrayLayer = ... // layer to use for setup picture in DPB
    .imageViewBinding = dpbImageView
};

VkVideoReferenceSlotInfoKHR setupSlotInfo = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_REFERENCE_SLOT_INFO_KHR,
    .pNext = ... // pointer to codec-specific reconstructed picture information structure
    .slotIndex = ... // DPB slot index to activate with the reconstructed picture
    .pPictureResource = &amp;reconstructedPictureResource
};

VkVideoDecodeInfoKHR decodeInfo = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_DECODE_INFO_KHR,
    .pNext = ... // pointer to codec-specific picture information structure
    ...
    .dstPictureResource = decodeOutputPictureResource,
    .pSetupReferenceSlot = &amp;setupSlotInfo,
    ...
};

vkCmdDecodeVideoKHR(commandBuffer, &amp;decodeInfo);

vkCmdEndVideoCodingKHR(commandBuffer, ...);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_record_decode_operation_with_reconstructed_picture_setup_coincide_mode"><a class="anchor" href="#_record_decode_operation_with_reconstructed_picture_setup_coincide_mode"></a>4.9. Record decode operation with reconstructed picture setup (COINCIDE mode)</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">// Bound reference resource list provided has to include reconstructed picture resource
vkCmdBeginVideoCodingKHR(commandBuffer, ...);

VkVideoPictureResourceInfoKHR reconstructedPictureResource = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_PICTURE_RESOURCE_INFO_KHR,
    .pNext = NULL,
    .codedOffset = ... // offset within the image subresource (typically { 0, 0 })
    .codedExtent = ... // extent of decoded picture (typically the video frame size)
    .baseArrayLayer = ... // layer to use for setup picture in DPB
    .imageViewBinding = dpbImageView
};

VkVideoReferenceSlotInfoKHR setupSlotInfo = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_REFERENCE_SLOT_INFO_KHR,
    .pNext = ... // pointer to codec-specific reconstructed picture information structure
    .slotIndex = ... // DPB slot index to activate with the reconstructed picture
    .pPictureResource = &amp;reconstructedPictureResource
};

VkVideoDecodeInfoKHR decodeInfo = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_DECODE_INFO_KHR,
    .pNext = ... // pointer to codec-specific picture information structure
    ...
    .dstPictureResource = reconstructedPictureResource,
    .pSetupReferenceSlot = &amp;setupSlotInfo,
    ...
};

vkCmdDecodeVideoKHR(commandBuffer, &amp;decodeInfo);

vkCmdEndVideoCodingKHR(commandBuffer, ...);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_record_decode_operation_with_reference_picture_list"><a class="anchor" href="#_record_decode_operation_with_reference_picture_list"></a>4.10. Record decode operation with reference picture list</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">// Bound reference resource list provided has to include all used reference picture resources
vkCmdBeginVideoCodingKHR(commandBuffer, ...);

VkVideoPictureResourceInfoKHR referencePictureResources[] = {
    {
        .sType = VK_STRUCTURE_TYPE_VIDEO_PICTURE_RESOURCE_INFO_KHR,
        .pNext = NULL,
        .codedOffset = ... // offset within the image subresource (typically { 0, 0 })
        .codedExtent = ... // extent of reference picture (typically the video frame size)
        .baseArrayLayer = ... // layer of first reference picture resource
        .imageViewBinding = dpbImageView
    },
    {
        .sType = VK_STRUCTURE_TYPE_VIDEO_PICTURE_RESOURCE_INFO_KHR,
        .pNext = NULL,
        .codedOffset = ... // offset within the image subresource (typically { 0, 0 })
        .codedExtent = ... // extent of reference picture (typically the video frame size)
        .baseArrayLayer = ... // layer of second reference picture resource
        .imageViewBinding = dpbImageView
    },
    ...
};
// NOTE: Individual resources do not have to refer to the same image view, e.g. if different
// image views are created for each picture resource, or if the
// VK_VIDEO_CAPABILITY_SEPARATE_REFERENCE_IMAGES_BIT_KHR capability is supported and the
// application created separate images for the reference pictures.

VkVideoReferenceSlotInfoKHR referenceSlotInfo[] = {
    {
        .sType = VK_STRUCTURE_TYPE_VIDEO_REFERENCE_SLOT_INFO_KHR,
        .pNext = ... // pointer to codec-specific reference picture information structure
        .slotIndex = ... // DPB slot index of the first reference picture
        .pPictureResource = &amp;referencePictureResource[0]
    },
    {
        .sType = VK_STRUCTURE_TYPE_VIDEO_REFERENCE_SLOT_INFO_KHR,
        .pNext = ... // pointer to codec-specific reference picture information structure
        .slotIndex = ... // DPB slot index of the second reference picture
        .pPictureResource = &amp;referencePictureResource[1]
    },
    ...
};

VkVideoDecodeInfoKHR decodeInfo = {
    .sType = VK_STRUCTURE_TYPE_VIDEO_DECODE_INFO_KHR,
    .pNext = ... // pointer to codec-specific picture information structure
    ...
    .referenceSlotCount = sizeof(referenceSlotInfo) / sizeof(referenceSlotInfo[0]),
    .pReferenceSlots = &amp;referenceSlotInfo[0]
};

vkCmdDecodeVideoKHR(commandBuffer, &amp;decodeInfo);

vkCmdEndVideoCodingKHR(commandBuffer, ...);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_issues"><a class="anchor" href="#_issues"></a>5. Issues</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_resolved_why_is_there_no_vk_pipeline_stage_video_decode_bit_khr"><a class="anchor" href="#_resolved_why_is_there_no_vk_pipeline_stage_video_decode_bit_khr"></a>5.1. RESOLVED: Why is there no <code>VK_PIPELINE_STAGE_VIDEO_DECODE_BIT_KHR</code>?</h3>
<div class="paragraph">
<p>This extension requires the <code>VK_KHR_synchronization2</code> extension because the new access flags introduced did not fit in the 32-bit enum <code>VkAccessFlagBits</code>. Accordingly, all new pipeline stage and access flags have been added to the corresponding 64-bit enums and no new flags have been added to the legacy 32-bit enums. While the new pipeline stage flag introduced uses bit #26 which would also fit in the legacy <code>VkPipelineStageFlagBits</code> enum, there is no real benefit to include it. Instead the bit is marked reserved.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resolved_are_the_decode_output_picture_data_and_reconstructed_picture_data_used_to_activate_a_dpb_slot_written_to_the_same_resource"><a class="anchor" href="#_resolved_are_the_decode_output_picture_data_and_reconstructed_picture_data_used_to_activate_a_dpb_slot_written_to_the_same_resource"></a>5.2. RESOLVED: Are the decode output picture data and reconstructed picture data used to activate a DPB slot written to the same resource?</h3>
<div class="paragraph">
<p>When activating DPB slots with reconstructed pictures (reference picture setup), decode operations have to write the decompressed picture data to a DPB-capable video picture resource.</p>
</div>
<div class="paragraph">
<p>Behavior varies across implementations in this case:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Some implementations write the outputs of the picture decompression to two separate resources: the decoded output picture and the reconstructed picture</p>
</li>
<li>
<p>Some other implementations only write picture decompression results to one place, which in this case has to be a DPB picture (as it must be usable as a reference picture later on)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A separate output could be useful if e.g. the application intends to use the decode output picture for other purposes (e.g. for window-system presentation or for texture sampling), while using the reconstructed picture in parallel to continue decoding. However, such concurrent use of the outputs is not always necessary.</p>
</div>
<div class="paragraph">
<p>Trying to mandate a uniform behavior across such implementations could have negative performance implications:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If separate outputs would be required, then implementations using a single output would have to perform additional copies even though the application use cases might not need to have one.</p>
</li>
<li>
<p>If a single output would be required, then applications would have to do copies if they wanted to do such concurrent processing and would not be able to take advantage of implementations that already can write separate outputs in an optimized fashion.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Instead, this extension allows implementations to support either of these modes of operations (separate or single output), as indicated by the <code>VK_VIDEO_DECODE_CAPABILITY_DPB_AND_OUTPUT_DISTINCT_BIT_KHR</code> and <code>VK_VIDEO_DECODE_CAPABILITY_DPB_AND_OUTPUT_COINCIDE_BIT_KHR</code> capability flags, respectively. Implementations are required to support only one of these two modes, and the extension even allows for implementations that may support both modes of operation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resolved_how_can_layered_codec_specific_decode_extensions_enable_applications_to_provide_the_necessary_codec_specific_picture_information_parameter_sets_etc_that_may_be_needed_to_perform_the_video_coding_operations"><a class="anchor" href="#_resolved_how_can_layered_codec_specific_decode_extensions_enable_applications_to_provide_the_necessary_codec_specific_picture_information_parameter_sets_etc_that_may_be_needed_to_perform_the_video_coding_operations"></a>5.3. RESOLVED: How can layered codec-specific decode extensions enable applications to provide the necessary codec-specific picture information, parameter sets, etc. that may be needed to perform the video coding operations?</h3>
<div class="paragraph">
<p>There are multiple points where codec-specific picture information can be provided to a video decode operation. This extension suggests the following convention:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Codec-specific decode parameters are expected to be provided in the <code>pNext</code> chain of <code>VkVideoDecodeInfoKHR</code>.</p>
</li>
<li>
<p>Codec-specific reconstructed picture information is expected to be provided in the <code>pNext</code> chain of <code>VkVideoDecodeInfoKHR::pSetupReferenceSlot</code>.</p>
</li>
<li>
<p>Codec-specific reference picture information is expected to be provided in the <code>pNext</code> chain of the elements of the <code>VkVideoDecodeInfoKHR::pReferenceSlots</code> array.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_resolved_can_vkcmdvideodecodekhr_only_decode_frames_what_about_field_decoding_slice_decoding_etc"><a class="anchor" href="#_resolved_can_vkcmdvideodecodekhr_only_decode_frames_what_about_field_decoding_slice_decoding_etc"></a>5.4. RESOLVED: Can <code>vkCmdVideoDecodeKHR</code> only decode frames? What about field decoding, slice decoding, etc.?</h3>
<div class="paragraph">
<p>This extension does not define the types of pictures or sub-picture content that can be decoded by a <code>vkCmdVideoDecodeKHR</code> command. It is expected that the codec-specific decode extensions built upon this extension define the types of pictures that can be decoded. Furthermore, both codec-specific and codec-independent extensions can expand the set of capabilities introduced here to enable more advanced use cases, as needed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resolved_what_is_the_effect_of_the_flags_provided_in_vkvideodecodeusageinfokhrvideousagehints"><a class="anchor" href="#_resolved_what_is_the_effect_of_the_flags_provided_in_vkvideodecodeusageinfokhrvideousagehints"></a>5.5. RESOLVED: What is the effect of the flags provided in <code>VkVideoDecodeUsageInfoKHR::videoUsageHints</code>?</h3>
<div class="paragraph">
<p>There are no specific behavioral effects associated with any of the video decode usage hints, so the application can specify any combination of these flags. They are included to enable the application to better communicate the intended use case scenario to the implementation.</p>
</div>
<div class="paragraph">
<p>However, just like any other additional video profile information included in the <code>pNext</code> chain of <code>VkVideoProfileInfoKHR</code> structures, they are part of the video profile definition, hence whenever matching video profiles have to be provided to an API call, let that be queries or resource creation structures, the application must provide identical video decode usage hint values. This also applies if the application does not include the <code>VkVideoDecodeUsageInfoKHR</code> structure, which is treated equivalently to specifying the structure with <code>videoUsageHints</code> equal to <code>VK_VIDEO_DECODE_USAGE_DEFAULT_KHR</code> (or zero), per the usual conventions of Vulkan.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_further_functionality"><a class="anchor" href="#_further_functionality"></a>6. Further Functionality</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This extension is meant to provide only common video decode functionality, thus support for individual video decode profiles using specific video compression standards is left for extensions layered on top of the infrastructure provided here.</p>
</div>
<div class="paragraph">
<p>Currently the following layered extensions are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>VK_KHR_video_decode_h264</code> - adds support for decoding H.264/AVC video sequences</p>
</li>
<li>
<p><code>VK_KHR_video_decode_h265</code> - adds support for decoding H.265/HEVC video sequences</p>
</li>
</ul>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <!--
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
    -->
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
  </body>
</html>
