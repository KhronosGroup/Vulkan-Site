<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Buffer device address :: Vulkan Documentation Project Demo</title>
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../../..">Vulkan Documentation Project Demo</a>
      <div class="navbar-item">
        <img alt="Vulkan White Label" src="../../../../../_/Vulkan_White_Dec16.svg" height="100%" />
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label for="search-input"></label><input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <!-- <a class="navbar-item" href="#">Home</a> -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Specs</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../spec/latest/chapters/introduction.html">Vulkan 1.3</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Guides</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../guide/latest/index.html">Vulkan Guide</a>
          </div>
        </div>
            <!--
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Tools</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">TBD</a>
          </div>
        </div>
            -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Tutorial</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../tutorial/latest/index.html">Vulkan Tutorial</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Samples</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../samples/latest/README.html">Vulkan Samples</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Help</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://discord.gg/vulkan">Vulkan Discord</a>
            <a class="navbar-item" href="https://khr.io/khrdiscord">Khronos Discord</a>
          </div>
        </div>
            <!--
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
            -->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="samples" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../README.html">Vulkan Samples</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../README.html">Readme</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#vulkan_basics.adoc">Vulkan basics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../framework/README.html">Sample framework</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/README.adoc">Api usage samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/compute_nbody/README.adoc">Compute N-body❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_compute_nbody/README.adoc">hpp compute nbody❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/dynamic_uniform_buffers/README.adoc">Dynamic uniform buffers❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_dynamic_uniform_buffers/README.adoc">hpp dynamic uniform buffers❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/hdr/README.adoc">HDR❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_hdr/README.adoc">hpp hdr❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/hello_triangle/README.adoc">Hello Triangle❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_hello_triangle/README.adoc">hpp hello triangle❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/hlsl_shaders/README.adoc">HLSL Shaders</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_hlsl_shaders/README.adoc">hpp hlsl shaders</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/instancing/README.adoc">Instancing❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_instancing/README.adoc">hpp instancing❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/separate_image_sampler/README.adoc">Separate image sampler</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_separate_image_sampler/README.adoc">hpp separate image sampler</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/terrain_tessellation/README.adoc">Terrain tessellation❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_terrain_tessellation/README.adoc">hpp terrain tessellation❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/texture_loading/README.adoc">Texture loading❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_texture_loading/README.adoc">hpp texture loading❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/texture_mipmap_generation/README.adoc">Texture mipmap generation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_texture_mipmap_generation/README.adoc">hpp texture mipmap generation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/timestamp_queries/README.adoc">Timestamp queries</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_timestamp_queries/README.adoc">hpp timestamp queries</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#extensions/README.adoc">Extension usage samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/buffer_device_address/README.adoc">Buffer device address</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/calibrated_timestamps/README.adoc">Calibrated timestamps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/conditional_rendering/README.adoc">Conditional rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/conservative_rasterization/README.adoc">Conservative rasterization❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/debug_utils/README.adoc">Debug utils</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/descriptor_buffer_basic/README.adoc">Descriptor buffer basic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/descriptor_indexing/README.adoc">Descriptor indexing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/dynamic_rendering/README.adoc">Dynamic rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/extended_dynamic_state2/README.adoc">Extended dynamic state2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/fragment_shader_barycentric/README.adoc">Fragment shader barycentric</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/fragment_shading_rate/README.adoc">Fragment shading rate❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/fragment_shading_rate_dynamic/README.adoc">Fragment shading rate dynamic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/full_screen_exclusive/README.adoc">Full screen exclusive</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/graphics_pipeline_library/README.adoc">Graphics pipeline library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/logic_op_dynamic_state/README.adoc">Logic op dynamic state</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/memory_budget/README.adoc">Memory budget</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/mesh_shader_culling/README.adoc">Mesh shader culling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/mesh_shading/README.adoc">Mesh shading❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/open_cl_interop/README.adoc">OpenCL interop (Cross-vendor)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/open_cl_interop_arm/README.adoc">OpenCl interop (Arm)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/open_gl_interop/README.adoc">OpenGL interop❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/portability/README.adoc">Portability</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/push_descriptors/README.adoc">Push descriptors❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/raytracing_basic/README.adoc">Raytracing basic❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/raytracing_extended/README.adoc">Raytracing extended</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/ray_queries/README.adoc">Ray queries❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/ray_tracing_reflection/README.adoc">Ray tracing reflection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/synchronization_2/README.adoc">Synchronization 2❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/timeline_semaphore/README.adoc">Timeline semaphore</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/vertex_dynamic_state/README.adoc">Vertex dynamic state</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#performance/README.adoc">Performance samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/16bit_arithmetic/README.adoc">16bit arithmetic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/16bit_storage_input_output/README.adoc">16bit storage input output</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/afbc/README.adoc">AFBC</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/async_compute/README.adoc">Async compute</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/command_buffer_usage/README.adoc">Command buffer usage</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/constant_data/README.adoc">Constant data</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/descriptor_management/README.adoc">Descriptor management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/layout_transitions/README.adoc">Layout transitions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/msaa/README.adoc">MSAA</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/multithreading_render_passes/README.adoc">Multithreading render passes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/multi_draw_indirect/README.adoc">Multi draw indirect</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/pipeline_barriers/README.adoc">Pipeline barriers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#performance/pipeline_cache/README.adoc">Pipeline cache</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#performance/hpp_pipeline_cache/README.adoc">hpp pipeline cache</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/render_passes/README.adoc">Render passes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/specialization_constants/README.adoc">Specialization constants</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/subpasses/README.adoc">Subpasses</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/surface_rotation/README.adoc">Surface rotation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#performance/swapchain_images/README.adoc">Swapchain images</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#performance/hpp_swapchain_images/README.adoc">hpp swapchain images</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/texture_compression_basisu/README.adoc">Texture compression basisu</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/texture_compression_comparison/README.adoc">Texture compression comparison❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/wait_idle/README.adoc">Wait idle</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#tooling/README.adoc">Tooling samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tooling/profiles/README.adoc">Profiles</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#docs/README.adoc">General documentation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/build.html">Build guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#docs/create_sample.adoc">Creating a new sample</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#docs/debug_graphs.adoc">Debug graphics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/memory_limits.html">Memory limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/misc.html">Miscellaneous</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Vulkan Samples</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../../guide/latest/index.html">Vulkan Guide</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../guide/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../../README.html">Vulkan Samples</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../../README.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../../spec/latest/index.html">Vulkan Specification and Proposals</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../spec/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../../spec/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../README.html">Vulkan Samples</a></li>
    <li><a href="README.html">Buffer device address</a></li>
  </ul>
</nav>
    <!--
  <div class="edit-this-page"><a href="https://github.com/gpx1000/Vulkan-Samples/edit/antora/antora/modules/ROOT/pages/samples/extensions/buffer_device_address/README.adoc">Edit this Page</a></div>
      -->
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Buffer device address</h1>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Buffer device address is a very powerful and unique feature to Vulkan which is not present in any other modern graphics API.
The main gist of it is that it exposes GPU virtual addresses directly to the application, and the application can then use said address to access buffer data freely through pointers rather than descriptors.
What makes this feature unique is that we can place these addresses in buffers and load and store to them inside shaders, with full capability to perform pointer arithmetic and other fun tricks.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_buffer"><a class="anchor" href="#_creating_a_buffer"></a>Creating a buffer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To be able to grab a device address from a <code>VkBuffer</code>, we just need to modify our buffer creation slightly.</p>
</div>
<div class="paragraph">
<p>First, the buffer must be created with <code>SHADER_DEVICE_ADDRESS_BIT</code> usage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">VkBufferCreateInfo create_info = vkb::initializers::buffer_create_info(
    VK_BUFFER_USAGE_STORAGE_BUFFER_BIT | VK_BUFFER_USAGE_SHADER_DEVICE_ADDRESS_BIT_KHR, mesh_size);</code></pre>
</div>
</div>
<div class="paragraph">
<p>After that, the memory we bind said buffer to must be allocated with a similar flag.
This time, it is a <code>pNext</code> struct instead.
This struct is core in Vulkan 1.1, but otherwise requires the <code>VK_KHR_device_group</code> extension.
Vulkan 1.1 should be considered a given if buffer device address is supported, so this is more of a technicality than anything else.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">VkMemoryAllocateFlagsInfoKHR flags_info{VK_STRUCTURE_TYPE_MEMORY_ALLOCATE_FLAGS_INFO_KHR};
flags_info.flags             = VK_MEMORY_ALLOCATE_DEVICE_ADDRESS_BIT_KHR;
memory_allocation_info.pNext = &amp;flags_info;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, once we have allocated and bound the buffer to the memory, we can query the address.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">VkBufferDeviceAddressInfoKHR address_info{VK_STRUCTURE_TYPE_BUFFER_DEVICE_ADDRESS_INFO_KHR};
address_info.buffer = buffer.buffer;
buffer.gpu_address  = vkGetBufferDeviceAddressKHR(device, &amp;address_info);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This address works similarly to a normal addresses, and you can freely offset the <code>VkDeviceAddress</code> value as you see fit, as it is really just a <code>uint64_t</code>.
There is no alignment requirement on the host.
When using this pointer, you need to specify the alignment yourself, since unlike descriptors, the shader compiler won&#8217;t be able to infer anything about a raw pointer that you load from somewhere.</p>
</div>
<div class="paragraph">
<p>You can now place this pointer inside another buffer and have fun.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_vulkan_glsl"><a class="anchor" href="#_vulkan_glsl"></a>Vulkan GLSL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Vulkan GLSL, we get the <code>GL_EXT_buffer_reference</code> extension which allows us to declare buffer blocks not as SSBOs, but faux pointer types instead.
GLSL does not have true pointer types, but this is a way to introduce pointers without completely changing the language.
E.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">#extension GL_EXT_buffer_reference : require</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can forward-declare types, which is nice for data structures like linked lists.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">layout(buffer_reference) buffer Position;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can declare a buffer type as well.
This is not an SSBO declaration, but it basically declares a pointer to struct.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">layout(std430, buffer_reference, buffer_reference_align = 8) writeonly buffer Position
{
    vec2 positions[];
};</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>buffer_reference</code> tags the type accordingly, and <code>buffer_reference_align</code> is used to mark that any pointer which is of this type is at least 8 byte aligned.
This is required since the compiler has no idea what alignment a random pointer has.
It is possible to use scalar alignments here if you need it.</p>
</div>
<div class="paragraph">
<p>We can now place the <code>Position</code> type inside another buffer, or another buffer reference type, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">layout(std430, buffer_reference, buffer_reference_align = 8) readonly buffer PositionReferences
{
    Position buffers[];
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have a pointer to array of pointers &#8230;&#8203;
spicy!</p>
</div>
<div class="paragraph">
<p>Finally, we could place a buffer reference inside push constants, an SSBO or a UBO.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">layout(std430, set = 0, binding = 0) readonly buffer Pointers
{
    Positions positions[];
};

layout(std430, push_constant) uniform Registers
{
    PositionReferences references;
} registers;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The size and alignment of a buffer reference is 8 bytes (64-bit).
Placing pointers in push constants is an attractive way of getting direct access to buffer data since we do not require a descriptor set to access buffer data.</p>
</div>
<div class="sect2">
<h3 id="_lack_of_robustness"><a class="anchor" href="#_lack_of_robustness"></a>Lack of robustness</h3>
<div class="paragraph">
<p>A critical thing to note is that a raw pointer has no idea of how much memory is safe to access.
Unlike SSBOs when robustness feature is enabled, you must either do range checks yourself or just not write code that relies on out-of-bounds access :)</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_spir_v"><a class="anchor" href="#_spir_v"></a>SPIR-V</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In SPIR-V we get a new storage class <code>PhysicalStorageBuffer</code> which represents a raw pointer to storage buffer memory.
The use of physical pointers in SPIR-V can be quite useful for use cases which emit SPIR-V directly, so it is useful to know how to use this feature in the IR.</p>
</div>
<div class="sect2">
<h3 id="_addressing_mode"><a class="anchor" href="#_addressing_mode"></a>Addressing mode</h3>
<div class="paragraph">
<p>Rather than the <code>Logical</code> addressing model, we now use the <code>PhysicalStorageBuffer64</code> model, where we allow physical pointers only for the <code>PhysicalStorageBuffer</code> storage class.
Otherwise, everything stays <code>Logical</code> where pointers are completely abstract.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">OpCapability PhysicalStorageBufferAddresses
OpExtension "SPV_KHR_physical_storage_buffer"
OpMemoryModel PhysicalStorageBuffer64 GLSL450</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_alignment_tags"><a class="anchor" href="#_alignment_tags"></a>Alignment tags</h3>
<div class="paragraph">
<p>Explicit alignment is generally not a thing in SPIR-V, but physical storage buffer is an exception.
Since the compiler has no idea what alignment a random pointer has, all uses of <code>OpLoad</code> or <code>OpStore</code> must be tagged with <code>Aligned</code>, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">%57 = OpLoad %_ptr_PhysicalStorageBuffer_Position %56 Aligned 8
OpStore %164 %162 Aligned 8</code></pre>
</div>
</div>
<div class="paragraph">
<p>When using Vulkan GLSL, these <code>Aligned</code> values are inferred from <code>buffer_reference_align</code> and the <code>Offset</code> decorations.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_casting_pointers"><a class="anchor" href="#_casting_pointers"></a>Casting pointers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A key aspect of buffer device address is that we gain the capability to cast pointers freely.</p>
</div>
<div class="paragraph">
<p>While it is technically possible (and useful in some cases!) to "cast pointers" with SSBOs with clever use of aliased declarations like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">layout(set = 0, binding = 0) buffer SSBO { float v1[]; };
layout(set = 0, binding = 0) buffer SSBO2 { vec4 v4[]; };</code></pre>
</div>
</div>
<div class="paragraph">
<p>it gets kind of hairy quickly, and not as flexible when dealing with composite types.</p>
</div>
<div class="sect2">
<h3 id="_casting_to_and_from_integers_pointer_arithmetic"><a class="anchor" href="#_casting_to_and_from_integers_pointer_arithmetic"></a>Casting to and from integers, pointer arithmetic</h3>
<div class="paragraph">
<p>When we have casts between integers and pointers, we get the full madness that is pointer arithmetic.
Nothing stops us from doing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">#extension GL_EXT_buffer_reference : require
layout(buffer_reference) buffer PointerToFloat { float v; };

PointerToFloat pointer = load_pointer();
uint64_t int_pointer = uint64_t(pointer);
int_pointer += offset;
pointer = PointerToFloat(int_pointer);
pointer.v = 42.0;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In SPIR-V, this is a simple <code>OpBitcast</code>.</p>
</div>
<div class="paragraph">
<p>Not all GPUs support 64-bit integers, so it is also possible to use <code>uvec2</code> to represent pointers.
This way, we can do raw pointer arithmetic in 32-bit, which might be more optimal anyways.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">#extension GL_EXT_buffer_reference_uvec2 : require
layout(buffer_reference) buffer PointerToFloat { float v; };
PointerToFloat pointer = load_pointer();
uvec2 int_pointer = uvec2(pointer);
uint carry;
uint lo = uaddCarry(int_pointer.x, offset, carry);
uint hi = int_pointer.y + carry;
pointer = PointerToFloat(uvec2(lo, hi));
pointer.v = 42.0;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_sample"><a class="anchor" href="#_the_sample"></a>The sample</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/extensions/buffer_device_address/images/sample.png" alt="Sample">
</div>
</div>
<div class="paragraph">
<p>The sample is a distilled demonstration of how buffer device addressing could be used to enable a more flexible vertex attribute fetch scheme.
Rather than using fixed function VBOs which cannot be rebound on GPU, we could make use of buffer device address to enable a "meshlet" style of rendering, which is characterized by a rendering style where we chop up meshes into smaller chunks which can be culled and rendered individually.
This is an attractive way of doing GPU-driven rendering.</p>
</div>
<div class="paragraph">
<p>Essentially, we create a bunch of VkBuffers, where each buffer represents a separate mesh (not the most optimal approach, but a useful demonstration).
A mesh has a device address (<code>VkDeviceAddress</code>) which we place in a separate array, which serves as a nifty way of stitching together unrelated buffers.
The mesh buffers are updated in a compute shader, and subsequently read in the vertex shader.</p>
</div>
<div class="paragraph">
<p>This kind of flexibility could be awkward to achieve with normal SSBOs unless everything is backed by a single <code>VkBuffer</code>.</p>
</div>
<div class="paragraph">
<p>Of course, this is just one of many use cases for buffer device address, and was deemed to be the simplest meaningful way to demonstrate this feature.</p>
</div>
<div class="paragraph">
<p>In compute, we pass down a pointer in push constants, which is a very fast way of providing shaders with a buffer as there is no descriptor set required!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">layout(std430, buffer_reference, buffer_reference_align = 8) writeonly buffer Position
{
    vec2 positions[];
};

layout(std430, buffer_reference, buffer_reference_align = 8) readonly buffer PositionReferences
{
    Position buffers[];
};

layout(push_constant) uniform Registers
{
    PositionReferences references;
    float fract_time;
} registers;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we can see, push constants contain a pointer which points to an array of pointers, which then point to a "VBO" block.
We perform one large dispatch to update N different "VBOs" here, where each 16x16 group works with its own base pointer.</p>
</div>
<div class="paragraph">
<p>The position that is computed forms a simple procedural wave pattern.
The actual implementation details are not very interesting.</p>
</div>
<div class="paragraph">
<p>In the vertex shader, we do our faux "meshlet" rendering by assigning one VBO block per <code>gl_InstanceIndex</code>.
For multi-draw-indirect use cases, it would be natural to use <code>gl_DrawID</code> perhaps.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">layout(std430, buffer_reference, buffer_reference_align = 8) readonly buffer Position
{
    vec2 positions[];
};

layout(std430, buffer_reference, buffer_reference_align = 8) readonly buffer PositionReferences
{
    Position buffers[];
};

layout(push_constant) uniform Registers
{
    mat4 view_projection;
    PositionReferences references;
} registers;

void main()
{
    int slice = gl_InstanceIndex;
    // Load pointer to VBO
    restrict Position ptr_positions = registers.references.buffers[slice];
    // Load attribute based on gl_VertexIndex.
    // No fixed function here!
    vec2 pos = ptr_positions.positions[gl_VertexIndex];
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_debugging_notes"><a class="anchor" href="#_debugging_notes"></a>Debugging notes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When debugging or capturing an application that uses buffer device addresses, there are some special driver requirements that are not universally supported.
Essentially, to be able to capture application buffers which contain raw pointers, we must ensure that the device address for a given buffer remains stable when the capture is replayed in a new process.
Applications do not have to do anything here, since tools like RenderDoc will enable the <code>bufferDeviceAddressCaptureReplay</code> feature for you, and deal with all the magic associated with address capture behind the scenes.
If the <code>bufferDeviceAddressCaptureReplay</code> is not present however, tools like RenderDoc will mask out the <code>bufferDeviceAddress</code> feature, so beware.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion"><a class="anchor" href="#_conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Buffer device address is an extremely powerful feature which enables various use cases which were either impossible or very impractical before.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <!--
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
    -->
</footer>
<script id="site-script" src="../../../../../_/js/site.js" data-ui-root-path="../../../../../_"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../../.." data-snippet-length="100" data-stylesheet="../../../../../_/css/search.css"></script>
<script async src="../../../../../search-index.js"></script>
  </body>
</html>
