<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenCL interoperability :: Vulkan Documentation Project Demo</title>
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../../..">Vulkan Documentation Project Demo</a>
      <div class="navbar-item">
        <img alt="Vulkan White Label" src="../../../../../_/Vulkan_White_Dec16.svg" height="100%" />
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label for="search-input"></label><input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <!-- <a class="navbar-item" href="#">Home</a> -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Specs</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../spec/latest/chapters/introduction.html">Vulkan 1.3</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Guides</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../guide/latest/index.html">Vulkan Guide</a>
          </div>
        </div>
            <!--
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Tools</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">TBD</a>
          </div>
        </div>
            -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Tutorial</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../tutorial/latest/index.html">Vulkan Tutorial</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Samples</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../samples/latest/README.html">Vulkan Samples</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Help</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://discord.gg/vulkan">Vulkan Discord</a>
            <a class="navbar-item" href="https://khr.io/khrdiscord">Khronos Discord</a>
          </div>
        </div>
            <!--
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
            -->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="samples" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../README.html">Vulkan Samples</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../README.html">Readme</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#vulkan_basics.adoc">Vulkan basics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../framework/README.html">Sample framework</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/README.adoc">Api usage samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/compute_nbody/README.adoc">Compute N-body❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_compute_nbody/README.adoc">hpp compute nbody❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/dynamic_uniform_buffers/README.adoc">Dynamic uniform buffers❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_dynamic_uniform_buffers/README.adoc">hpp dynamic uniform buffers❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/hdr/README.adoc">HDR❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_hdr/README.adoc">hpp hdr❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/hello_triangle/README.adoc">Hello Triangle❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_hello_triangle/README.adoc">hpp hello triangle❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/hlsl_shaders/README.adoc">HLSL Shaders</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_hlsl_shaders/README.adoc">hpp hlsl shaders</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/instancing/README.adoc">Instancing❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_instancing/README.adoc">hpp instancing❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/separate_image_sampler/README.adoc">Separate image sampler</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_separate_image_sampler/README.adoc">hpp separate image sampler</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/terrain_tessellation/README.adoc">Terrain tessellation❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_terrain_tessellation/README.adoc">hpp terrain tessellation❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/texture_loading/README.adoc">Texture loading❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_texture_loading/README.adoc">hpp texture loading❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/texture_mipmap_generation/README.adoc">Texture mipmap generation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_texture_mipmap_generation/README.adoc">hpp texture mipmap generation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/timestamp_queries/README.adoc">Timestamp queries</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_timestamp_queries/README.adoc">hpp timestamp queries</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#extensions/README.adoc">Extension usage samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/buffer_device_address/README.adoc">Buffer device address</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/calibrated_timestamps/README.adoc">Calibrated timestamps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/conditional_rendering/README.adoc">Conditional rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/conservative_rasterization/README.adoc">Conservative rasterization❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/debug_utils/README.adoc">Debug utils</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/descriptor_buffer_basic/README.adoc">Descriptor buffer basic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/descriptor_indexing/README.adoc">Descriptor indexing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/dynamic_rendering/README.adoc">Dynamic rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/extended_dynamic_state2/README.adoc">Extended dynamic state2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/fragment_shader_barycentric/README.adoc">Fragment shader barycentric</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/fragment_shading_rate/README.adoc">Fragment shading rate❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/fragment_shading_rate_dynamic/README.adoc">Fragment shading rate dynamic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/full_screen_exclusive/README.adoc">Full screen exclusive</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/graphics_pipeline_library/README.adoc">Graphics pipeline library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/logic_op_dynamic_state/README.adoc">Logic op dynamic state</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/memory_budget/README.adoc">Memory budget</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/mesh_shader_culling/README.adoc">Mesh shader culling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/mesh_shading/README.adoc">Mesh shading❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/open_cl_interop/README.adoc">OpenCL interop (Cross-vendor)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/open_cl_interop_arm/README.adoc">OpenCl interop (Arm)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/open_gl_interop/README.adoc">OpenGL interop❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/portability/README.adoc">Portability</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/push_descriptors/README.adoc">Push descriptors❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/raytracing_basic/README.adoc">Raytracing basic❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/raytracing_extended/README.adoc">Raytracing extended</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/ray_queries/README.adoc">Ray queries❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/ray_tracing_reflection/README.adoc">Ray tracing reflection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/synchronization_2/README.adoc">Synchronization 2❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/timeline_semaphore/README.adoc">Timeline semaphore</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/vertex_dynamic_state/README.adoc">Vertex dynamic state</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#performance/README.adoc">Performance samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/16bit_arithmetic/README.adoc">16bit arithmetic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/16bit_storage_input_output/README.adoc">16bit storage input output</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/afbc/README.adoc">AFBC</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/async_compute/README.adoc">Async compute</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/command_buffer_usage/README.adoc">Command buffer usage</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/constant_data/README.adoc">Constant data</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/descriptor_management/README.adoc">Descriptor management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/layout_transitions/README.adoc">Layout transitions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/msaa/README.adoc">MSAA</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/multithreading_render_passes/README.adoc">Multithreading render passes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/multi_draw_indirect/README.adoc">Multi draw indirect</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/pipeline_barriers/README.adoc">Pipeline barriers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#performance/pipeline_cache/README.adoc">Pipeline cache</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#performance/hpp_pipeline_cache/README.adoc">hpp pipeline cache</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/render_passes/README.adoc">Render passes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/specialization_constants/README.adoc">Specialization constants</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/subpasses/README.adoc">Subpasses</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/surface_rotation/README.adoc">Surface rotation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#performance/swapchain_images/README.adoc">Swapchain images</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#performance/hpp_swapchain_images/README.adoc">hpp swapchain images</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/texture_compression_basisu/README.adoc">Texture compression basisu</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/texture_compression_comparison/README.adoc">Texture compression comparison❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/wait_idle/README.adoc">Wait idle</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#tooling/README.adoc">Tooling samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tooling/profiles/README.adoc">Profiles</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#docs/README.adoc">General documentation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/build.html">Build guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#docs/create_sample.adoc">Creating a new sample</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#docs/debug_graphs.adoc">Debug graphics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/memory_limits.html">Memory limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/misc.html">Miscellaneous</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Vulkan Samples</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../../guide/latest/index.html">Vulkan Guide</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../guide/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../../README.html">Vulkan Samples</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../../README.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../../spec/latest/index.html">Vulkan Specification and Proposals</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../spec/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../../spec/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../README.html">Vulkan Samples</a></li>
    <li><a href="README.html">OpenCL interoperability</a></li>
  </ul>
</nav>
    <!--
  <div class="edit-this-page"><a href="https://github.com/gpx1000/Vulkan-Samples/edit/antora/antora/modules/ROOT/pages/samples/extensions/open_cl_interop/README.adoc">Edit this Page</a></div>
      -->
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">OpenCL interoperability</h1>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In certain scenarios OpenCL is used for compute, while another API is used for graphics, and interoperability between two APIs becomes important in this case.
For example, in AR applications graphics rendering is often combined with machine learning workloads, which can be executed using OpenCL.
In such cases we need zero-copy data sharing and efficient workload synchronization to achieve the best performance.</p>
</div>
<div class="paragraph">
<p>While there are no dedicated extensions for direct Vulkan - OpenCL interoperability at the moment, both APIs provide generic sharing mechanism that can be used to achieve it.
This sample demonstrates an approach for zero-copy data sharing using Android Hardware Buffers and corresponding extensions for Vulkan and OpenCL.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_sharing"><a class="anchor" href="#_data_sharing"></a>Data sharing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Zero-copy assumes that both APIs use the same region of memory for an image or a buffer.
In case of OpenCL and Vulkan we can use extensions to share data using:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Android Hardware Buffers</p>
</li>
<li>
<p>dma_buf</p>
</li>
<li>
<p>Host memory</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This sample covers one of these options, which is more relevant to mobile developers working with Vulkan: Android Hardware Buffers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_android_hardware_buffers"><a class="anchor" href="#_android_hardware_buffers"></a>Android Hardware Buffers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Native hardware buffers on Android represent a region of memory which can be bound to Vulkan, OpenGL ES or OpenCL primitives.
This allows us to reuse it with two different APIs:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/extensions/open_cl_interop/images/shared_hardware_buffer.png" alt="Sample">
</div>
</div>
<div class="sect2">
<h3 id="_support_by_vulkan_api"><a class="anchor" href="#_support_by_vulkan_api"></a>Support by Vulkan API</h3>
<div class="paragraph">
<p>In Vulkan hardware buffers can be imported or exported using <a href="https://www.khronos.org/registry/vulkan/specs/1.2-extensions/man/html/VK_ANDROID_external_memory_android_hardware_buffer.html">VK_ANDROID_external_memory_android_hardware_buffer</a> extension.
AHardwareBuffer can be bound to a <code>VkDeviceMemory</code> object, which serves as an allocation for objects of type <code>VkImage</code> or <code>VkBuffer</code>.</p>
</div>
<div class="paragraph">
<p>If we need to use an image backed by an AHardwareBuffer, we must specify while creating the image.
It is done by assigning a pointer to the following structure to <code>pNext</code> field of <code>VkImageCreateInfo</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">VkExternalMemoryImageCreateInfo external_memory_image_create_info;
external_memory_image_create_info.sType = VK_STRUCTURE_TYPE_EXTERNAL_MEMORY_IMAGE_CREATE_INFO;
external_memory_image_create_info.pNext = nullptr;
external_memory_image_create_info.handleTypes = VK_EXTERNAL_MEMORY_HANDLE_TYPE_ANDROID_HARDWARE_BUFFER_BIT_ANDROID;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This image (or buffer) must be specified as target during memory allocation.
Below you can see, how the image object which is supposed to be shared with OpenCL is assigned to the <code>image</code> field of <code>VkMemoryDedicatedAllocateInfo</code>, while <code>buffer</code> field is assigned with <code>VK_NULL_HANDLE</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">VkMemoryDedicatedAllocateInfo dedicated_allocate_info;
dedicated_allocate_info.sType = VK_STRUCTURE_TYPE_MEMORY_DEDICATED_ALLOCATE_INFO;
dedicated_allocate_info.pNext = nullptr;
dedicated_allocate_info.buffer = VK_NULL_HANDLE;
dedicated_allocate_info.image = shared_image;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_export_from_vulkan_api"><a class="anchor" href="#_export_from_vulkan_api"></a>Export from Vulkan API</h4>
<div class="paragraph">
<p>A pointer to <code>dedicated_allocate_info</code> is provided as <code>pNext</code> of <code>VkExportMemoryAllocateInfo</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">VkExportMemoryAllocateInfo export_memory_allocate_Info;
export_memory_allocate_Info.sType = VK_STRUCTURE_TYPE_EXPORT_MEMORY_ALLOCATE_INFO;
export_memory_allocate_Info.pNext = &amp;dedicated_allocate_info;
export_memory_allocate_Info.handleTypes = VK_EXTERNAL_MEMORY_HANDLE_TYPE_ANDROID_HARDWARE_BUFFER_BIT_ANDROID;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is specified as <code>pNext</code> of <code>VkMemoryAllocateInfo</code>, while <code>allocationSize</code> is set to 0.
You can find more info on this in the <a href="https://www.khronos.org/registry/vulkan/specs/1.2-extensions/html/vkspec.html#VkMemoryRequirements">specification</a>.</p>
</div>
<div class="paragraph">
<p>Once the memory is allocated <strong>and</strong> bound to the image (or buffer), we can export a handle of type <code>AHardwareBuffer</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">VkMemoryGetAndroidHardwareBufferInfoANDROID info;
info.sType = VK_STRUCTURE_TYPE_MEMORY_GET_ANDROID_HARDWARE_BUFFER_INFO_ANDROID;
info.pNext = nullptr;
info.memory = shared_memory;
vkGetMemoryAndroidHardwareBufferANDROID(device, &amp;info, &amp;hardware_buffer);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_import_to_vulkan_api"><a class="anchor" href="#_import_to_vulkan_api"></a>Import to Vulkan API</h4>
<div class="paragraph">
<p>In this case AHardwareBuffer is created first and then used for <code>VkDeviceMemory</code> allocation.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
there are certain restrictions on image or buffer format and usage.
You can find the list of Android Hardware Buffer formats and their Vulkan counterparts in this <a href="https://developer.android.com/ndk/reference/group/a-hardware-buffer#ahardwarebuffer_format">table</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A pointer to <code>dedicated_allocate_info</code> is provided as <code>pNext</code> of <code>VkImportAndroidHardwareBufferInfoANDROID</code>.
Also the hardware buffer we want to import must be provided during this stage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">VkImportAndroidHardwareBufferInfoANDROID import_info;
import_info.sType = VK_STRUCTURE_TYPE_IMPORT_ANDROID_HARDWARE_BUFFER_INFO_ANDROID;
import_info.pNext = &amp;dedicated_allocate_info;
import_info.buffer = hardware_buffer;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to specify this data as <code>pNext</code> in <code>VkMemoryAllocateInfo</code>.
In case of import, <code>allocationSize</code> and <code>memoryTypeIndex</code> should be based on the results of <code>vkGetAndroidHardwareBufferPropertiesANDROID</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">VkAndroidHardwareBufferPropertiesANDROID buffer_properties;
buffer_properties.sType = VK_STRUCTURE_TYPE_ANDROID_HARDWARE_BUFFER_PROPERTIES_ANDROID;
buffer_properties.pNext = nullptr;
vkGetAndroidHardwareBufferPropertiesANDROID(device, hardware_buffer, &amp;buffer_properties);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the memory is allocated and bound to the image as usual.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_support_by_opencl"><a class="anchor" href="#_support_by_opencl"></a>Support by OpenCL</h3>
<div class="paragraph">
<p>On Arm devices Android hardware buffers (as well as dma_buf and host memory) can be imported to OpenCL using <a href="https://www.khronos.org/registry/OpenCL/extensions/arm/cl_arm_import_memory.txt">cl_arm_import_memory</a> extension.</p>
</div>
<div class="paragraph">
<p><code>cl_mem</code> object is retrieved in the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">const cl_import_properties_arm import_properties[3] = {
	    CL_IMPORT_TYPE_ARM, CL_IMPORT_TYPE_ANDROID_HARDWARE_BUFFER_ARM,
	    0};

cl_int result = CL_SUCCESS;
cl_mem shared_cl_mem = clImportMemoryARM(context,
                                                    CL_MEM_READ_WRITE,
                                                    import_properties,
                                                    hardware_buffer,
                                                    CL_IMPORT_MEMORY_WHOLE_ALLOCATION_ARM,
                                                    &amp;result);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <code>cl_import_properties_arm</code> array the types and values of the properties are listed one by one with a 0 as a terminator in the end.</p>
</div>
<div class="paragraph">
<p>We need to specify the type of the imported object in this list (in our case it&#8217;s <code>CL_IMPORT_TYPE_ANDROID_HARDWARE_BUFFER_ARM</code>).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_sample"><a class="anchor" href="#_the_sample"></a>The sample</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this sample a simple OpenCL kernel is executed in the beginning of each frame to fill a <code>cl_mem</code> object backed by an <code>AHardwareBuffer</code> with a simple pattern (this pattern changes over time).
This <code>AHardwareBuffer</code> is exported from a <code>VkDeviceMemory</code> object which is bound to a texture.
After the OpenCL kernel is executed, the filled texture is displayed.</p>
</div>
<div class="paragraph">
<p>The texture is displayed as a quad using the approach and shaders from <a href="../../api/texture_loading">Texture Loading</a> sample.</p>
</div>
<div class="paragraph">
<p>The sample uses only one shared texture for simplicity, but in real applications it&#8217;s worth having as many shared textures as there are framebuffers.
This way the OpenCL kernel would be executed for the current frame, while the previous frame is being rendered and displayed (double buffering).</p>
</div>
<div class="paragraph">
<p>Synchronization between APIs is performed on host:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>OpenCL queue is flushed before rendering</p>
</li>
<li>
<p>A <code>VkFence</code> object is used to make sure the rendering is finished</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/extensions/open_cl_interop/images/sample.png" alt="Sample">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion"><a class="anchor" href="#_conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Both OpenCL and Vulkan extensions allow us to import or export certain handle types, which represent a region of memory.
These memory regions can be used to achieve zero-copy data sharing.
In this sample one of such handle types is demonstrated: Android Hardware Buffers.</p>
</div>
<div class="paragraph">
<p>The extensions used in this case are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.khronos.org/registry/vulkan/specs/1.2-extensions/man/html/VK_ANDROID_external_memory_android_hardware_buffer.html">VK_ANDROID_external_memory_android_hardware_buffer</a></p>
</li>
<li>
<p><a href="https://www.khronos.org/registry/OpenCL/extensions/arm/cl_arm_import_memory.txt">cl_arm_import_memory</a></p>
</li>
</ul>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <!--
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
    -->
</footer>
<script id="site-script" src="../../../../../_/js/site.js" data-ui-root-path="../../../../../_"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../../.." data-snippet-length="100" data-stylesheet="../../../../../_/css/search.css"></script>
<script async src="../../../../../search-index.js"></script>
  </body>
</html>
