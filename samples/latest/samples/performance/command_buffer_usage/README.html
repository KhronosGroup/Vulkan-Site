<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Command buffer usage and multi-threaded recording :: Vulkan Documentation Project Demo</title>
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../../..">Vulkan Documentation Project Demo</a>
      <div class="navbar-item">
        <img alt="Vulkan White Label" src="../../../../../_/Vulkan_White_Dec16.svg" height="100%" />
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label for="search-input"></label><input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <!-- <a class="navbar-item" href="#">Home</a> -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Specs</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../spec/latest/chapters/introduction.html">Vulkan 1.3</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Guides</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../guide/latest/index.html">Vulkan Guide</a>
          </div>
        </div>
            <!--
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Tools</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">TBD</a>
          </div>
        </div>
            -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Tutorial</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../tutorial/latest/index.html">Vulkan Tutorial</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Samples</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../samples/latest/README.html">Vulkan Samples</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Help</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://discord.gg/vulkan">Vulkan Discord</a>
            <a class="navbar-item" href="https://khr.io/khrdiscord">Khronos Discord</a>
          </div>
        </div>
            <!--
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
            -->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="samples" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../README.html">Vulkan Samples</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../README.html">Readme</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#vulkan_basics.adoc">Vulkan basics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../framework/README.html">Sample framework</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/README.adoc">Api usage samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/compute_nbody/README.adoc">Compute N-body❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_compute_nbody/README.adoc">hpp compute nbody❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/dynamic_uniform_buffers/README.adoc">Dynamic uniform buffers❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_dynamic_uniform_buffers/README.adoc">hpp dynamic uniform buffers❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/hdr/README.adoc">HDR❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_hdr/README.adoc">hpp hdr❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/hello_triangle/README.adoc">Hello Triangle❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_hello_triangle/README.adoc">hpp hello triangle❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/hlsl_shaders/README.adoc">HLSL Shaders</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_hlsl_shaders/README.adoc">hpp hlsl shaders</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/instancing/README.adoc">Instancing❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_instancing/README.adoc">hpp instancing❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/separate_image_sampler/README.adoc">Separate image sampler</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_separate_image_sampler/README.adoc">hpp separate image sampler</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/terrain_tessellation/README.adoc">Terrain tessellation❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_terrain_tessellation/README.adoc">hpp terrain tessellation❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/texture_loading/README.adoc">Texture loading❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_texture_loading/README.adoc">hpp texture loading❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/texture_mipmap_generation/README.adoc">Texture mipmap generation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_texture_mipmap_generation/README.adoc">hpp texture mipmap generation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/timestamp_queries/README.adoc">Timestamp queries</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_timestamp_queries/README.adoc">hpp timestamp queries</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#extensions/README.adoc">Extension usage samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/buffer_device_address/README.adoc">Buffer device address</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/calibrated_timestamps/README.adoc">Calibrated timestamps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/conditional_rendering/README.adoc">Conditional rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/conservative_rasterization/README.adoc">Conservative rasterization❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/debug_utils/README.adoc">Debug utils</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/descriptor_buffer_basic/README.adoc">Descriptor buffer basic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/descriptor_indexing/README.adoc">Descriptor indexing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/dynamic_rendering/README.adoc">Dynamic rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/extended_dynamic_state2/README.adoc">Extended dynamic state2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/fragment_shader_barycentric/README.adoc">Fragment shader barycentric</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/fragment_shading_rate/README.adoc">Fragment shading rate❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/fragment_shading_rate_dynamic/README.adoc">Fragment shading rate dynamic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/full_screen_exclusive/README.adoc">Full screen exclusive</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/graphics_pipeline_library/README.adoc">Graphics pipeline library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/logic_op_dynamic_state/README.adoc">Logic op dynamic state</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/memory_budget/README.adoc">Memory budget</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/mesh_shader_culling/README.adoc">Mesh shader culling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/mesh_shading/README.adoc">Mesh shading❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/open_cl_interop/README.adoc">OpenCL interop (Cross-vendor)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/open_cl_interop_arm/README.adoc">OpenCl interop (Arm)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/open_gl_interop/README.adoc">OpenGL interop❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/portability/README.adoc">Portability</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/push_descriptors/README.adoc">Push descriptors❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/raytracing_basic/README.adoc">Raytracing basic❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/raytracing_extended/README.adoc">Raytracing extended</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/ray_queries/README.adoc">Ray queries❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/ray_tracing_reflection/README.adoc">Ray tracing reflection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/synchronization_2/README.adoc">Synchronization 2❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/timeline_semaphore/README.adoc">Timeline semaphore</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/vertex_dynamic_state/README.adoc">Vertex dynamic state</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#performance/README.adoc">Performance samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/16bit_arithmetic/README.adoc">16bit arithmetic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/16bit_storage_input_output/README.adoc">16bit storage input output</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/afbc/README.adoc">AFBC</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/async_compute/README.adoc">Async compute</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/command_buffer_usage/README.adoc">Command buffer usage</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/constant_data/README.adoc">Constant data</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/descriptor_management/README.adoc">Descriptor management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/layout_transitions/README.adoc">Layout transitions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/msaa/README.adoc">MSAA</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/multithreading_render_passes/README.adoc">Multithreading render passes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/multi_draw_indirect/README.adoc">Multi draw indirect</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/pipeline_barriers/README.adoc">Pipeline barriers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#performance/pipeline_cache/README.adoc">Pipeline cache</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#performance/hpp_pipeline_cache/README.adoc">hpp pipeline cache</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/render_passes/README.adoc">Render passes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/specialization_constants/README.adoc">Specialization constants</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/subpasses/README.adoc">Subpasses</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/surface_rotation/README.adoc">Surface rotation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#performance/swapchain_images/README.adoc">Swapchain images</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#performance/hpp_swapchain_images/README.adoc">hpp swapchain images</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/texture_compression_basisu/README.adoc">Texture compression basisu</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/texture_compression_comparison/README.adoc">Texture compression comparison❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/wait_idle/README.adoc">Wait idle</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#tooling/README.adoc">Tooling samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tooling/profiles/README.adoc">Profiles</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#docs/README.adoc">General documentation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/build.html">Build guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#docs/create_sample.adoc">Creating a new sample</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#docs/debug_graphs.adoc">Debug graphics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/memory_limits.html">Memory limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/misc.html">Miscellaneous</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Vulkan Samples</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../../guide/latest/index.html">Vulkan Guide</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../guide/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../../README.html">Vulkan Samples</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../../README.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../../spec/latest/index.html">Vulkan Specification and Proposals</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../spec/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../../spec/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../README.html">Vulkan Samples</a></li>
    <li><a href="README.html">Command buffer usage and multi-threaded recording</a></li>
  </ul>
</nav>
    <!--
  <div class="edit-this-page"><a href="https://github.com/gpx1000/Vulkan-Samples/edit/antora/antora/modules/ROOT/pages/samples/performance/command_buffer_usage/README.adoc">Edit this Page</a></div>
      -->
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Command buffer usage and multi-threaded recording</h1>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This sample demonstrates how to use and manage secondary command buffers, and how to record them concurrently.</p>
</div>
<div class="paragraph">
<p>Implementing multi-threaded recording of draw calls can help reduce CPU frame time.</p>
</div>
<div class="paragraph">
<p>In tile-based renderers, the best approach to split the draw calls is to record them in secondary command buffers.
This way they can all be submitted to the same render pass, and can take advantage of tile local memory.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_secondary_command_buffers"><a class="anchor" href="#_secondary_command_buffers"></a>Secondary command buffers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Secondary command buffers can inherit the render pass state from a primary command buffer using a <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkCommandBufferInheritanceInfo.html">VkCommandBufferInheritanceInfo</a> structure which is passed to <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkBeginCommandBuffer.html">vkBeginCommandBuffer</a> as part of <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkCommandBufferBeginInfo.html">VkCommandBufferBeginInfo</a>, along with the flag <code>VK_COMMAND_BUFFER_USAGE_RENDER_PASS_CONTINUE_BIT</code>.
Secondary command buffers may then be recorded concurrently.</p>
</div>
<div class="paragraph">
<p>The primary command buffer must have used the flag <code>VK_SUBPASS_CONTENTS_SECONDARY_COMMAND_BUFFERS</code> in <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkCmdBeginRenderPass.html">vkCmdBeginRenderPass</a>.</p>
</div>
<div class="paragraph">
<p>Finally, the primary command buffer records <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkCmdExecuteCommands.html">vkCmdExecuteCommands</a> (before <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkCmdEndRenderPass.html">vkCmdEndRenderPass</a>) with an array of recorded secondary command buffers to execute.
The sample divides the draw calls for opaque objects based on the slider value.
It then submits a separate buffer for transparent objects if any, and finally one for the GUI elements if visible.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_multi_threaded_recording"><a class="anchor" href="#_multi_threaded_recording"></a>Multi-threaded recording</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To record command buffers concurrently, the framework needs to manage resource pools per frame and per thread.
According to the Vulkan Spec:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkCommandPool.html"><em>A command pool must not be used concurrently in multiple threads.</em></a></p>
</li>
<li>
<p><a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkDescriptorPool.html"><em>The application must not allocate and/or free descriptor sets from the same pool in multiple threads simultaneously.</em></a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the framework, each frame in the queue (e.g.
three frames in case of triple buffering) manages a collection of pools so that each thread can own:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A command pool</p>
</li>
<li>
<p>A descriptor pool cache</p>
</li>
<li>
<p>A descriptor set cache</p>
</li>
<li>
<p>A buffer pool</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This sample then uses a thread pool to push work to multiple threads.
When splitting the draw calls, it is advisable to keep the loads balanced.
The sample allows to change the number of buffers, but if the number of calls is not divisible, the remaining will be evenly spread through other buffers.
The average number of draws per buffer is shown on the screen.</p>
</div>
<div class="paragraph">
<p>Note that since state is not reused across command buffers, a reasonable number of draw calls should be submitted per command buffer, to avoid having the GPU going idle while processing commands.
Therefore having many secondary command buffers with few draw calls can negatively affect performance.
In any case there is no advantage in exceeding the CPU parallelism level i.e.
using more command buffers than threads.
Similarly having more threads than buffers may have a performance impact.
To keep all threads busy, the sample resizes the thread pool for low number of buffers.
The sample slider can help illustrate these trade-offs and their impact on performance, as shown by the performance graphs.</p>
</div>
<div class="paragraph">
<p>In this case, a scene with a high number of draw calls (~1800, this number may be found in the <a href="../../../docs/misc.adoc#debug-window">debug window</a>) shows a 15% improvement in performance when dividing the workload among 8 buffers across 8 threads:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/command_buffer_usage/images/single_threading.png" alt="Single-threaded">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/command_buffer_usage/images/multi_threading.png" alt="Multi-threaded">
</div>
</div>
<div class="paragraph">
<p>To test the sample, make sure to build it in release mode and without validation layers.
Both these factors can significantly affect the results.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recycling_strategies"><a class="anchor" href="#_recycling_strategies"></a>Recycling strategies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vulkan provides different ways to manage and allocate command buffers.
This sample compares them and demonstrates the best approach.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#allocate-and-free">Allocate and Free</a></p>
</li>
<li>
<p><a href="#resetting-individual-command-buffers">Resetting individual command buffers</a></p>
</li>
<li>
<p><a href="#resetting-the-command-pool">Resetting the command pool</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_allocate_and_free"><a class="anchor" href="#_allocate_and_free"></a>Allocate and free</h3>
<div class="paragraph">
<p>Command buffers are allocated from a command pool with <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkAllocateCommandBuffers.html">vkAllocateCommandBuffers</a>.
They can then be recorded and submitted to a queue for the Vulkan device to execute them.</p>
</div>
<div class="paragraph">
<p>A possible approach to managing the command buffers for each frame in our application would be to free them once they are executed, using <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkFreeCommandBuffers.html">vkFreeCommandBuffers</a>.</p>
</div>
<div class="paragraph">
<p>The command pool will not automatically recycle memory from deleted command buffers if the command pool was created without the <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkCommandPoolCreateFlagBits.html">RESET_COMMAND_BUFFER_BIT</a> flag.
This flag however will force separate internal allocators to be used for each command buffer in the pool, which can increase CPU overhead compared to a single pool reset.</p>
</div>
<div class="paragraph">
<p>This is the worst-performing method of managing command buffers as it involves a significant CPU overhead for allocating and freeing memory frequently.
The sample shows how to use the framework to follow this approach and profile its performance.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/command_buffer_usage/images/allocate_and_free.jpg" alt="Allocate and Free">
</div>
</div>
<div class="paragraph">
<p>Rather than freeing and re-allocating the memory used by a command buffer, it is more efficient to recycle it for recording new commands.
There are two ways of resetting a command buffer: individually, with <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkResetCommandBuffer.html">vkResetCommandBuffer</a>, or indirectly by resetting the command pool with <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkResetCommandPool.html">vkResetCommandPool</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resetting_individual_command_buffers"><a class="anchor" href="#_resetting_individual_command_buffers"></a>Resetting individual command buffers</h3>
<div class="paragraph">
<p>In order to reset command buffers individually with <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkResetCommandBuffer.html">vkResetCommandBuffer</a>, the pool must have been created with the <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkCommandPoolCreateFlagBits.html">RESET_COMMAND_BUFFER_BIT</a> flag set.
The buffer will then return to a recordable state and the command pool can reuse the memory it allocated for it.</p>
</div>
<div class="paragraph">
<p>However frequent calls to <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkResetCommandBuffer.html">vkResetCommandBuffer</a> are more expensive than a command pool reset.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/command_buffer_usage/images/reset_buffers.jpg" alt="Reset Buffers">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resetting_the_command_pool"><a class="anchor" href="#_resetting_the_command_pool"></a>Resetting the command pool</h3>
<div class="paragraph">
<p>Resetting the pool with <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkResetCommandPool.html">vkResetCommandPool</a> automatically resets all the command buffers allocated by it.
Doing this periodically will allow the pool to reuse the memory allocated for command buffers with lower CPU overhead.</p>
</div>
<div class="paragraph">
<p>To reset the pool the flag <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkCommandPoolCreateFlagBits.html">RESET_COMMAND_BUFFER_BIT</a> is <em>not</em> required, and it is actually better to avoid it since it prevents it from using a single large allocator for all buffers in the pool thus increasing memory overhead.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/command_buffer_usage/images/reset_pool.jpg" alt="Reset Pool">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_relative_performance"><a class="anchor" href="#_relative_performance"></a>Relative performance</h3>
<div class="paragraph">
<p>The sample offers the option of recording all drawing operations on a single command buffer, or to divide the opaque object draw calls among a given number of secondary command buffers.
The second method allows multi-threaded command buffer construction.
However the number of secondary command buffers should be kept low since their invocations are expensive.
This sample lets the user adjust the number of command buffers.
Using a high number of secondary command buffers causes the application to become CPU bound and makes the differences between the described memory allocation approaches more pronounced.</p>
</div>
<div class="paragraph">
<p>All command buffers in this sample are initialized with the <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkCommandBufferUsageFlagBits.html">ONE_TIME_SUBMIT_BIT</a> flag set.
This indicates to the driver that the buffer will not be re-submitted after execution, and allows it to optimize accordingly.
Performance may be reduced if the <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkCommandBufferUsageFlagBits.html">SIMULTANEOUS_USE_BIT</a> flag is set instead.</p>
</div>
<div class="paragraph">
<p>This sample provides options to try the three different approaches to command buffer management described above and monitor their efficiency.
This is relatively obvious directly on the device by monitoring frame time.</p>
</div>
<div class="paragraph">
<p>Since the application is CPU bound, the <a href="https://developer.android.com/studio/profile/android-profiler">Android Profiler</a> is a helpful tool to analyze the differences in performance.
As expected, most of the time goes into the <a href="https://github.com/ARM-software/vulkan_best_practice_for_mobile_developers/blob/master/framework/core/command_pool.cpp">command pool framework functions</a>: <code>request_command_buffer</code> and <code>reset</code>.
These handle the different modes of operation exposed by this sample.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../../_images/samples/performance/command_buffer_usage/images/android_profiler_allocate_and_free.png" alt="Android Profiler: Allocate and Free"></span> <em>Android Profiler capture: use the Flame Chart to visualize which functions take the most time in the capture.
Filter for command buffer functions, and use the tooltips to find out how much time out of the overall capture was used by each function.</em></p>
</div>
<div class="paragraph">
<p>Capturing the C&#43;&#43; calls this way allows us to determine how much each function contributed to the overall running time.
The results are captured in the table below.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Mode</th>
<th class="tableblock halign-left valign-top">Request + Reset command buffers (ms)</th>
<th class="tableblock halign-left valign-top">Total capture (ms)</th>
<th class="tableblock halign-left valign-top">Contribution</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reset pool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">53.3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11 877</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">0.45 %</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Reset buffers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">140.29</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">12 087</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.16 %</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allocate and free</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3 319.25</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">11 513</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">28.8 %</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In this application the differences between individual reset and pool reset are more subtle, but allocating and freeing buffers are clearly the bottleneck in the worst performing case.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_further_reading"><a class="anchor" href="#_further_reading"></a>Further reading</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="#../multithreading_render_passes/README.adoc" class="xref unresolved">Multi-threaded recording with multiple render passes</a></p>
</li>
<li>
<p><a href="https://www.khronos.org/registry/vulkan/specs/1.3-extensions/html/chap6.html#commandbuffer-allocation">Command Buffer Allocation and Management</a></p>
</li>
<li>
<p><a href="https://www.khronos.org/registry/vulkan/specs/1.0-wsi_extensions/html/chap5.html#commandbuffers-lifecycle">Command Buffer Lifecycle</a></p>
</li>
<li>
<p><em>"Writing an efficient Vulkan renderer"</em> by Arseny Kapoulkine (from "GPU Zen 2: Advanced Rendering Techniques")</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_best_practice_summary"><a class="anchor" href="#_best_practice_summary"></a>Best-practice summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Do</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use secondary command buffers to allow multi-threaded render pass construction.</p>
</li>
<li>
<p>Minimize the number of secondary command buffer invocations used per frame.</p>
</li>
<li>
<p>Set <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkCommandBufferUsageFlagBits.html">ONE_TIME_SUBMIT_BIT</a> if you are not going to reuse the command buffer.</p>
</li>
<li>
<p>Periodically call <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkResetCommandPool.html">vkResetCommandPool()</a> to release the memory if you are not reusing command buffers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Don&#8217;t</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkCommandPoolCreateFlagBits.html">RESET_COMMAND_BUFFER_BIT</a> if you only need to free the whole pool.
If the bit is not set, some implementations might use a single large allocator for the pool, reducing memory management overhead.</p>
</li>
<li>
<p>Call <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkResetCommandBuffer.html">vkResetCommandBuffer()</a> on a high frequency call path.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Impact</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Increased CPU load will be incurred with secondary command buffers.</p>
</li>
<li>
<p>Increased CPU load will be incurred if command pool creation and command buffer begin flags are not used appropriately.</p>
</li>
<li>
<p>Increased CPU overhead if command buffer resets are too frequent.</p>
</li>
<li>
<p>Increased memory usage until a manual command pool reset is triggered.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Debugging</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Evaluate every use of any command buffer flag other than <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkCommandBufferUsageFlagBits.html">ONE_TIME_SUBMIT_BIT</a>, and review whether it&#8217;s a necessary use of the flag combination.</p>
</li>
<li>
<p>Evaluate every use of <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkResetCommandBuffer.html">vkResetCommandBuffer()</a> and see if it could be replaced with <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkResetCommandPool.html">vkResetCommandPool()</a> instead.</p>
</li>
</ul>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <!--
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
    -->
</footer>
<script id="site-script" src="../../../../../_/js/site.js" data-ui-root-path="../../../../../_"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../../.." data-snippet-length="100" data-stylesheet="../../../../../_/css/search.css"></script>
<script async src="../../../../../search-index.js"></script>
  </body>
</html>
