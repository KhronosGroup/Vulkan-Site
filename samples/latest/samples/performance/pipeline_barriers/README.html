<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Using pipeline barriers efficiently :: Vulkan Documentation Project Demo</title>
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../../..">Vulkan Documentation Project Demo</a>
      <div class="navbar-item">
        <img alt="Vulkan White Label" src="../../../../../_/Vulkan_White_Dec16.svg" height="100%" />
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label for="search-input"></label><input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <!-- <a class="navbar-item" href="#">Home</a> -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Specs</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../spec/latest/chapters/introduction.html">Vulkan 1.3</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Guides</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../guide/latest/index.html">Vulkan Guide</a>
          </div>
        </div>
            <!--
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Tools</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">TBD</a>
          </div>
        </div>
            -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Tutorial</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../tutorial/latest/index.html">Vulkan Tutorial</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Samples</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../samples/latest/README.html">Vulkan Samples</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Help</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://discord.gg/vulkan">Vulkan Discord</a>
            <a class="navbar-item" href="https://khr.io/khrdiscord">Khronos Discord</a>
          </div>
        </div>
            <!--
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
            -->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="samples" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../README.html">Vulkan Samples</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../README.html">Readme</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="#vulkan_basics.adoc">Vulkan basics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../framework/README.html">Sample framework</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/README.adoc">Api usage samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/compute_nbody/README.adoc">Compute N-body❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_compute_nbody/README.adoc">hpp compute nbody❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/dynamic_uniform_buffers/README.adoc">Dynamic uniform buffers❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_dynamic_uniform_buffers/README.adoc">hpp dynamic uniform buffers❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/hdr/README.adoc">HDR❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_hdr/README.adoc">hpp hdr❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/hello_triangle/README.adoc">Hello Triangle❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_hello_triangle/README.adoc">hpp hello triangle❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/hlsl_shaders/README.adoc">HLSL Shaders</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_hlsl_shaders/README.adoc">hpp hlsl shaders</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/instancing/README.adoc">Instancing❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_instancing/README.adoc">hpp instancing❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/separate_image_sampler/README.adoc">Separate image sampler</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_separate_image_sampler/README.adoc">hpp separate image sampler</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/terrain_tessellation/README.adoc">Terrain tessellation❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_terrain_tessellation/README.adoc">hpp terrain tessellation❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/texture_loading/README.adoc">Texture loading❕</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_texture_loading/README.adoc">hpp texture loading❕</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/texture_mipmap_generation/README.adoc">Texture mipmap generation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_texture_mipmap_generation/README.adoc">hpp texture mipmap generation</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#api/timestamp_queries/README.adoc">Timestamp queries</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#api/hpp_timestamp_queries/README.adoc">hpp timestamp queries</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#extensions/README.adoc">Extension usage samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/buffer_device_address/README.adoc">Buffer device address</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/calibrated_timestamps/README.adoc">Calibrated timestamps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/conditional_rendering/README.adoc">Conditional rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/conservative_rasterization/README.adoc">Conservative rasterization❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/debug_utils/README.adoc">Debug utils</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/descriptor_buffer_basic/README.adoc">Descriptor buffer basic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/descriptor_indexing/README.adoc">Descriptor indexing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/dynamic_rendering/README.adoc">Dynamic rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/extended_dynamic_state2/README.adoc">Extended dynamic state2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/fragment_shader_barycentric/README.adoc">Fragment shader barycentric</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/fragment_shading_rate/README.adoc">Fragment shading rate❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/fragment_shading_rate_dynamic/README.adoc">Fragment shading rate dynamic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/full_screen_exclusive/README.adoc">Full screen exclusive</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/graphics_pipeline_library/README.adoc">Graphics pipeline library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/logic_op_dynamic_state/README.adoc">Logic op dynamic state</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/memory_budget/README.adoc">Memory budget</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/mesh_shader_culling/README.adoc">Mesh shader culling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/mesh_shading/README.adoc">Mesh shading❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/open_cl_interop/README.adoc">OpenCL interop (Cross-vendor)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/open_cl_interop_arm/README.adoc">OpenCl interop (Arm)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/open_gl_interop/README.adoc">OpenGL interop❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/portability/README.adoc">Portability</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/push_descriptors/README.adoc">Push descriptors❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/raytracing_basic/README.adoc">Raytracing basic❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/raytracing_extended/README.adoc">Raytracing extended</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/ray_queries/README.adoc">Ray queries❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/ray_tracing_reflection/README.adoc">Ray tracing reflection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/synchronization_2/README.adoc">Synchronization 2❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/timeline_semaphore/README.adoc">Timeline semaphore</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#extensions/vertex_dynamic_state/README.adoc">Vertex dynamic state</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#performance/README.adoc">Performance samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/16bit_arithmetic/README.adoc">16bit arithmetic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/16bit_storage_input_output/README.adoc">16bit storage input output</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/afbc/README.adoc">AFBC</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/async_compute/README.adoc">Async compute</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/command_buffer_usage/README.adoc">Command buffer usage</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/constant_data/README.adoc">Constant data</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/descriptor_management/README.adoc">Descriptor management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/layout_transitions/README.adoc">Layout transitions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/msaa/README.adoc">MSAA</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/multithreading_render_passes/README.adoc">Multithreading render passes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/multi_draw_indirect/README.adoc">Multi draw indirect</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/pipeline_barriers/README.adoc">Pipeline barriers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#performance/pipeline_cache/README.adoc">Pipeline cache</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#performance/hpp_pipeline_cache/README.adoc">hpp pipeline cache</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/render_passes/README.adoc">Render passes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/specialization_constants/README.adoc">Specialization constants</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/subpasses/README.adoc">Subpasses</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/surface_rotation/README.adoc">Surface rotation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#performance/swapchain_images/README.adoc">Swapchain images</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="#performance/hpp_swapchain_images/README.adoc">hpp swapchain images</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/texture_compression_basisu/README.adoc">Texture compression basisu</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/texture_compression_comparison/README.adoc">Texture compression comparison❕</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#performance/wait_idle/README.adoc">Wait idle</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#tooling/README.adoc">Tooling samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#tooling/profiles/README.adoc">Profiles</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#docs/README.adoc">General documentation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/build.html">Build guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#docs/create_sample.adoc">Creating a new sample</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#docs/debug_graphs.adoc">Debug graphics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/memory_limits.html">Memory limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/misc.html">Miscellaneous</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Vulkan Samples</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../../guide/latest/index.html">Vulkan Guide</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../guide/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../../README.html">Vulkan Samples</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../../README.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../../spec/latest/index.html">Vulkan Specification and Proposals</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../spec/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../../spec/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../README.html">Vulkan Samples</a></li>
    <li><a href="README.html">Using pipeline barriers efficiently</a></li>
  </ul>
</nav>
    <!--
  <div class="edit-this-page"><a href="https://github.com/gpx1000/Vulkan-Samples/edit/antora/antora/modules/ROOT/pages/samples/performance/pipeline_barriers/README.adoc">Edit this Page</a></div>
      -->
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Using pipeline barriers efficiently</h1>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vulkan gives the application significant control over memory access for resources.
Pipeline barriers are particularly convenient for synchronizing memory accesses between render passes.</p>
</div>
<div class="paragraph">
<p>Having barriers is required whenever there is a memory dependency - the application should not assume that render passes are executed in order.</p>
</div>
<div class="paragraph">
<p>However, having too many or too strict barriers can affect the application&#8217;s performance.
This sample will cover how to set up pipeline barriers efficiently, with a focus on pipeline stages.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tile_based_rendering"><a class="anchor" href="#_tile_based_rendering"></a>Tile-based rendering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section will give an overview of why pipeline stages are relevant, especially for tile-based GPUs.</p>
</div>
<div class="paragraph">
<p>The traditional desktop GPU architecture would run the fragment shader on each primitive, in each draw call, in sequence.
Each primitive is rendered to completion before starting the next one with an algorithm which approximates to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">for each ( primitive )
    for each ( fragment )
        execute fragment shader</code></pre>
</div>
</div>
<div class="paragraph">
<p>This approach will require all fragments shaded to touch the working sets which include blending, depth testing and stencil operations.</p>
</div>
<div class="paragraph">
<p>At high framebuffer resolutions the bandwidth can be exceptionally high, with multiple read-modify-write operations per fragment.
Even if caching can mitigate this slightly, there is still a need for specialized high-frequency memory with a wide memory interface with lots of pins which are all particularly energy intensive.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/pipeline_barriers/images/immediate_mode_rendering.png" alt="Traditional Approach">
</div>
</div>
<div class="paragraph">
<p>Tile-based GPUs are designed to minimize the amount of power hungry external memory accesses which are needed during rendering, using a two-pass rendering algorithm for each render target.
They first process all the geometry, then execute all the per-fragment work.</p>
</div>
<div class="paragraph">
<p>For tile-based architectures the algorithm equates to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-asciidoc hljs" data-lang="asciidoc">for each ( tile )
    for each ( primitive in tile )
        for each ( fragment in primitive in tile )
            execute fragment shader</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mali GPUs break up the screen into small 16x16 pixel tiles which makes it possible to keep the entire working set in a fast RAM which is tightly coupled with the GPU shader core.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/pipeline_barriers/images/tile_based_rendering.png" alt="Tile-based Approach">
</div>
</div>
<div class="paragraph">
<p>Mali GPUs queue their work in a pair of internal slots, one for vertex/compute workloads and one for fragment workloads.
The workloads from both slots can be processed by the GPU at the same time, so vertex processing and fragment processing for different frames or render passes can be run in parallel.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/pipeline_barriers/images/mali_three_stage_pipeline.png" alt="Mali&#8217;s three stage pipeline">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_choosing_pipeline_stages"><a class="anchor" href="#_choosing_pipeline_stages"></a>Choosing pipeline stages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Vulkan a GPU command (e.g <code>vkCmdDraw</code>, <code>vkCmdDrawIndirect</code>, <code>vkCmdDispatch</code>, etc.) is executed in a pipeline consisting of multiple stages.
The available pipeline stages are defined in the <code>VkPipelineStage</code> enumeration.</p>
</div>
<div class="paragraph">
<p>For the synchronization of a shared resource accessed for writing by one command and then followed by another read command, Vulkan introduces the concept of pipeline barriers.
Depending on the resource type (e.g.
<code>VkImage</code> or <code>VkBuffer</code>) required by a read operation there are three different types of barriers - <code>VkMemoryBarrier</code>, <code>VkBufferMemoryBarrier</code> and <code>VkImageMemoryBarrier</code>.</p>
</div>
<div class="paragraph">
<p>Adding a pipeline barrier when recording a command buffer defines an execution dependency between all commands recorded before and the ones recorded after the barrier.</p>
</div>
<div class="paragraph">
<p>For example, if we set up deferred rendering with two render passes, we will write to the G-buffer images in the first render pass and then sample them in the second render pass.
This will require a pipeline barrier to avoid hazards.</p>
</div>
<div class="paragraph">
<p>The naive solution comes from using a very conservative barrier which blocks on all stages (e.g.
<code>ALL_GRAPHICS_BIT</code> or <code>ALL_COMMANDS_BIT</code>).
This will have a performance implication as it will force a pipeline flush between the two render passes.</p>
</div>
<div class="paragraph">
<p>If the second render pass only needs to sample the G-buffer image during fragment shading, we can add a more relaxed barrier (<code>COLOR_ATTACHMENT_OUTPUT_BIT</code> → <code>FRAGMENT_SHADER_BIT</code>), which still ensures the correct dependencies.
Such a barrier will let the GPU overlap fragment shading for the first render pass with vertex shading for the second render pass.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_the_sample"><a class="anchor" href="#_the_sample"></a>The sample</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>pipeline_barriers</code> Vulkan sample allows to switch between conservative and relaxed pipeline barriers, letting you visualize the resulting GPU behavior.
The app is fragment-bound, which allows the GPU to fully utilize pipelining.</p>
</div>
<div class="paragraph">
<p>The sample sets up deferred rendering with two render passes and uses pipeline barriers to synchronize them.
Note that a deferred rendering implementation using subpasses might be more efficient overall;
see <a href="#../subpasses/README.adoc" class="xref unresolved">the subpasses tutorial</a> for more detail.</p>
</div>
<div class="paragraph">
<p>The base case is with the most conservative barrier (<code>BOTTOM_OF_PIPE_BIT</code> → <code>TOP_OF_PIPE_BIT</code>).
As the graphs show, vertex and fragment work are serialized, as they never happen at the same time.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/pipeline_barriers/images/sample_bot_to_top.jpg" alt="Sample - Bottom to Top">
</div>
</div>
<div class="paragraph">
<p>A second case is with a slightly more relaxed barrier (<code>COLOR_ATTACHMENT_OUTPUT_BIT</code> → <code>VERTEX_SHADER_BIT</code>).
This is most commonly used by developers as a "default" barrier, to ensure that the image is available by vertex shading in the next render pass, in case it is needed.</p>
</div>
<div class="paragraph">
<p>While this is ok if the image is actually needed during vertex shading, there is a potential for optimization if the image is only needed for fragment shading, as discussed before.
As shown in the graph, the work is still serialized and there is no performance improvement from the previous case.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/pipeline_barriers/images/sample_frag_to_vert.jpg" alt="Sample - Frag to vert">
</div>
</div>
<div class="paragraph">
<p>The third case is with the most efficient barrier for this case (<code>COLOR_ATTACHMENT_OUTPUT_BIT</code> → <code>FRAGMENT_SHADER_BIT</code>), further relaxed from the previous one.</p>
</div>
<div class="paragraph">
<p>This time fragment shading keeps happening throughout, with vertex shading running in parallel to it.
Pipeline bubbles have disappeared and frame time has improved by 13%.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/pipeline_barriers/images/sample_frag_to_frag.jpg" alt="Sample - Frag to frag">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_best_practice_summary"><a class="anchor" href="#_best_practice_summary"></a>Best practice summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Do</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keep your <code>srcStageMask</code> as early as possible in the pipeline.</p>
</li>
<li>
<p>Keep your <code>dstStageMask</code> as late as possible in the pipeline.</p>
</li>
<li>
<p>Review if your dependencies are pointing forwards (vertex/compute -&gt; fragment) or backwards (fragment -&gt; vertex/compute) through the pipeline, and minimize use of backwards-facing dependencies unless you can add sufficient latency between generation of a resource and its consumption to hide the scheduling bubble it introduces.</p>
</li>
<li>
<p>Use <code>srcStageMask = ALL_GRAPHICS_BIT</code> and <code>dstStageMask = FRAGMENT_SHADING_BIT</code> when synchronizing render passes with each other.</p>
</li>
<li>
<p>Minimize use of <code>TRANSFER</code> copy operations&#8201;&#8212;&#8201;zero copy algorithms are more efficient if possible&#8201;&#8212;&#8201;and always review their impact on the hardware pipelining.</p>
</li>
<li>
<p>Only use intra-queue barriers when you need to, and put as much work as possible between barriers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Don&#8217;t</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Assume that render passes are synchronized by default.</p>
</li>
<li>
<p>Needlessly starve the hardware for work;
aim to overlap vertex/compute with fragment processing.</p>
</li>
<li>
<p>Use the following <code>srcStageMask</code> → <code>dstStageMask</code> synchronization pairings because they will often cause a full drain of the pipeline:</p>
</li>
<li>
<p><code>BOTTOM_OF_PIPE_BIT</code> → <code>TOP_OF_PIPE_BIT</code></p>
</li>
<li>
<p><code>ALL_GRAPHICS_BIT</code> → <code>ALL_GRAPHICS_BIT</code></p>
</li>
<li>
<p><code>ALL_COMMANDS_BIT</code> → <code>ALL_COMMANDS_BIT</code></p>
</li>
<li>
<p>Use a <code>VkEvent</code> if you&#8217;re signaling and waiting for that event right away, use <code>vkCmdPipelineBarrier()</code> instead.</p>
</li>
<li>
<p>Use a <code>VkSemaphore</code> for dependency management within a single queue.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Impact</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Getting pipeline barriers wrong might either starve GPU of work (too much synchronization) or cause rendering corruption (too little synchronization).
Getting this just right is a critical component of any Vulkan application.</p>
</li>
<li>
<p>Note that the presence of two distinct hardware slots which are scheduled independently for different types of workload is one aspect where tile-based GPUs like Mali are very different to desktop immediate-mode renderers.
Expect to have to tune your pipelining to work well on a tile-based GPU when porting content from a desktop GPU.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Debugging</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Look through the rendering pipeline for any case of missing synchronization between passes.</p>
</li>
<li>
<p>If on a Mali GPU, use <a href="https://developer.arm.com/tools-and-software/embedded/arm-development-studio/components/streamline-performance-analyzer">Streamline Performance Analyzer</a> to visualize the Arm CPU and GPU activity on both GPU hardware slots.
You can quickly see if there are bubbles in scheduling either locally to the GPU hardware (indicative of a stage dependency issue) or globally across both CPU and GPU (indicative of a blocking CPU call being used).</p>
</li>
</ul>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <!--
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
    -->
</footer>
<script id="site-script" src="../../../../../_/js/site.js" data-ui-root-path="../../../../../_"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../../.." data-snippet-length="100" data-stylesheet="../../../../../_/css/search.css"></script>
<script async src="../../../../../search-index.js"></script>
  </body>
</html>
