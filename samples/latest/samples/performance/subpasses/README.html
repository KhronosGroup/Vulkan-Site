<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Subpasses :: Vulkan Documentation Project</title>
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../../../../../_/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../../../_/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../../../_/img/favicon-16x16.png">
    <link rel="manifest" href="../../../../../_/static/site.webmanifest">
    <link rel="mask-icon" href="../../../../../_/img/safari-pinned-tab.svg" color="#a41e22">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="theme-color" content="#ffffff">
    <script>var uiRootPath = '../../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../../.."><img class="navbar-item" alt="Vulkan White Label" src="../../../../../_/Vulkan_Docs.svg" /></a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label for="search-input"></label><input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <!-- <a class="navbar-item" href="#">Home</a> -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Specs</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../spec/latest/chapters/introduction.html">Vulkan 1.3</a>
            <a class="navbar-item" href="https://registry.khronos.org/OpenGL/specs/gl/GLSLangSpec.4.60.html">GLSL</a>
            <a class="navbar-item" href="../../../../../guide/latest/hlsl.html">HLSL</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Education</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../../guide/latest/index.html">Vulkan Guide</a>
            <a class="navbar-item" href="../../../../../tutorial/latest/index.html">Vulkan Tutorial</a>
            <a class="navbar-item" href="../../../../../samples/latest/README.html">Vulkan Samples</a>
            <a class="navbar-item" href="https://www.youtube.com/c/vulkan">YouTube</a>
            <a class="navbar-item" href="https://vulkan.org">More Info at Vulkan.org</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://discord.gg/vulkan">Vulkan Discord</a>
            <a class="navbar-item" href="https://reddit.com/r/vulkan">Reddit</a>
            <a class="navbar-item" href="https://stackoverflow.com/questions/tagged/vulkan">Stack Overflow</a>
            <a class="navbar-item" href="https://fosstodon.org/@vulkan">Mastodon</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="samples" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../README.html">Vulkan Samples</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../vulkan_basics.html">Vulkan basics</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../framework/README.html">Sample framework</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../api/README.html">Api usage samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../api/compute_nbody/README.html">Compute N-body</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../api/hpp_compute_nbody/README.html">Compute N-body (Vulkan.hpp)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../api/dynamic_uniform_buffers/README.html">Dynamic uniform buffers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../api/hpp_dynamic_uniform_buffers/README.html">Dynamic Uniform Buffers (Vulkan.hpp)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../api/hdr/README.html">HDR</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../api/hpp_hdr/README.html">HDR (Vulkan.hpp)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../api/hello_triangle/README.html">Hello Triangle</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../api/hpp_hello_triangle/README.html">Hello Triangle (Vulkan.hpp)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../api/hlsl_shaders/README.html">HLSL Shaders</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../api/hpp_hlsl_shaders/README.html">HLSL Shaders (Vulkan.hpp)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../api/instancing/README.html">Instancing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../api/hpp_instancing/README.html">Instancing (Vulkan.hpp)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../api/separate_image_sampler/README.html">Separate image sampler</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../api/hpp_separate_image_sampler/README.html">Separate image sampler (Vulkan.hpp)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../api/terrain_tessellation/README.html">Terrain tessellation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../api/hpp_terrain_tessellation/README.html">Terrain tessellation (Vulkan.hpp)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../api/texture_loading/README.html">Texture loading</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../api/hpp_texture_loading/README.html">Texture loading (Vulkan.hpp)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../api/texture_mipmap_generation/README.html">Texture mipmap generation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../api/hpp_texture_mipmap_generation/README.html">Texture mipmap generation (Vulkan.hpp)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../api/timestamp_queries/README.html">Timestamp queries</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../api/hpp_timestamp_queries/README.html">Timestamp queries (Vulkan.hpp)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../api/oit_linked_lists/README.html">OIT linked lists</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../extensions/README.html">Extension usage samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/buffer_device_address/README.html">Buffer device address</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/calibrated_timestamps/README.html">Calibrated timestamps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/conditional_rendering/README.html">Conditional rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/conservative_rasterization/README.html">Conservative rasterization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/debug_utils/README.html">Debug utils</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/descriptor_buffer_basic/README.html">Descriptor buffer basic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/descriptor_indexing/README.html">Descriptor indexing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/dynamic_line_rasterization/README.html">Dynamic line rasterization</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/dynamic_rendering/README.html">Dynamic rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/extended_dynamic_state2/README.html">Extended dynamic state2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/fragment_shader_barycentric/README.html">Fragment shader barycentric</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/fragment_shading_rate/README.html">Fragment shading rate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/fragment_shading_rate_dynamic/README.html">Fragment shading rate dynamic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/full_screen_exclusive/README.html">Full screen exclusive</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/graphics_pipeline_library/README.html">Graphics pipeline library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/gshader_to_mshader/README.html">Geometry shader to mesh shader</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/logic_op_dynamic_state/README.html">Logic op dynamic state</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/memory_budget/README.html">Memory budget</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/mesh_shader_culling/README.html">Mesh shader culling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/mesh_shading/README.html">Mesh shading</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/open_cl_interop/README.html">OpenCL interop</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/open_cl_interop_arm/README.html">OpenCL interop (Arm)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/open_gl_interop/README.html">OpenGL interop</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/portability/README.html">Portability</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/push_descriptors/README.html">Push descriptors</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/raytracing_basic/README.html">Raytracing basic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/raytracing_extended/README.html">Raytracing extended</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/ray_queries/README.html">Ray queries</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/ray_tracing_reflection/README.html">Ray tracing reflection</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/shader_object/README.html">Shader Object</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/synchronization_2/README.html">Synchronization 2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/timeline_semaphore/README.html">Timeline semaphore</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../extensions/vertex_dynamic_state/README.html">Vertex dynamic state</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../README.html">Performance samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../16bit_arithmetic/README.html">16bit arithmetic</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../16bit_storage_input_output/README.html">16bit storage input output</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../afbc/README.html">AFBC</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../async_compute/README.html">Async compute</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../command_buffer_usage/README.html">Command buffer usage</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../constant_data/README.html">Constant data</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../descriptor_management/README.html">Descriptor management</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../layout_transitions/README.html">Layout transitions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../msaa/README.html">MSAA</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../multithreading_render_passes/README.html">Multithreading render passes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../multi_draw_indirect/README.html">Multi draw indirect</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../pipeline_barriers/README.html">Pipeline barriers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../pipeline_cache/README.html">Pipeline cache</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../hpp_pipeline_cache/README.html">Pipeline cache (Vulkan.hpp)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../render_passes/README.html">Render passes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../specialization_constants/README.html">Specialization constants</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="README.html">Subpasses</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../surface_rotation/README.html">Surface rotation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../swapchain_images/README.html">Swapchain images</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../hpp_swapchain_images/README.html">Swapchain images (Vulkan.hpp)</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../texture_compression_basisu/README.html">Texture compression basisu</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../texture_compression_comparison/README.html">Texture compression comparison</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../wait_idle/README.html">Wait idle</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../tooling/README.html">Tooling samples</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../tooling/profiles/README.html">Profiles</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="#docs/README.adoc">General documentation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/build.html">Build guide</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/memory_limits.html">Memory limits</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../docs/misc.html">Miscellaneous</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Vulkan Samples</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../../tutorial/latest/00_Introduction.html">Khronos Vulkan Tutorial</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../tutorial/latest/00_Introduction.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../../guide/latest/index.html">Vulkan Guide</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../guide/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../../README.html">Vulkan Samples</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../../README.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../../spec/latest/index.html">Vulkan Specification and Proposals</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../../spec/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../../spec/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../README.html">Vulkan Samples</a></li>
    <li><a href="../README.html">Performance samples</a></li>
    <li><a href="README.html">Subpasses</a></li>
  </ul>
</nav>
    <!--
  <div class="edit-this-page"><a href="https://github.com/KhronosGroup/Vulkan-Samples/edit/main/antora/modules/ROOT/pages/samples/performance/subpasses/README.adoc">Edit this Page</a></div>
      -->
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Subpasses</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The source for this sample can be found in the <a href="https://github.com/KhronosGroup/Vulkan-Samples/tree/main/samples/performance/subpasses">Khronos Vulkan samples github repository</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview"><a class="anchor" href="#_overview"></a>Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vulkan introduces the concept of <em>subpasses</em> to subdivide a single <a href="#../render_passes/README.adoc" class="xref unresolved">render pass</a> into separate logical phases.
The benefit of using subpasses over multiple render passes is that a GPU is able to perform various optimizations.
Tile-based renderers, for example, can take advantage of tile memory, which being on chip is decisively faster than external memory, potentially saving a considerable amount of bandwidth.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deferred_rendering"><a class="anchor" href="#_deferred_rendering"></a>Deferred rendering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>Subpasses sample</em> implements a <a href="https://en.wikipedia.org/wiki/Deferred_shading">deferred renderer</a>, which splits rendering in two passes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A geometry pass, where data needed for shading is written to the <em>G-buffer</em> (depth, albedo, normals).</p>
</li>
<li>
<p>A lighting pass, where shading is performed using the information in the G-buffer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The G-buffer layout used by the sample is below a limit of 128-bit per pixel of <em>tile buffer color storage</em> (more about that in the next section):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Lighting (<code>RGBA8_SRGB</code>), as attachment #0 will take advantage of <a href="https://www.arm.com/technologies/graphics-technologies/transaction-elimination">transaction elimination</a>.</p>
</li>
<li>
<p>Depth (<code>D32_SFLOAT</code>), which does not add up to the 128-bit limit.</p>
</li>
<li>
<p>Albedo (<code>RGBA8_UNORM</code>)</p>
</li>
<li>
<p>Normal (<code>RGB10A2_UNORM</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By using the format <code>RGB10A2_UNORM</code> for the normal buffer, normal values, which are within [-1,1], need to be transformed into [0,1].
The formula used in the shader is this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">out_normal = 0.5 * in_normal + 0.5;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Position can be reconstructed from the lighting pass using the depth attachment, using the following technique: [<a href="#references">1</a>]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">mat4 inv_view_proj  = inverse(projection * view);
vec2 inv_resolution = vec2(1.0f / width, 1.0f / height);

// Load depth from tile buffer and reconstruct world position
vec4 clip    = vec4(in_uv * 2.0 - 1.0,
                    subpassLoad(i_depth).x, 1.0);
vec4 world_w = inv_view_proj * clip;
vec3 world   = world_w.xyz / world_w.w;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to highlight the benefit of subpasses over multiple render passes, the sample allows the user to switch between two different techniques at run-time.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/subpasses/images/render-passes.jpg" alt="Render passes">
</div>
</div>
<div class="paragraph">
<p>One of the techniques uses two render passes, running one after another.
The first render pass generates the G-buffer, and the second uses it in the lighting stage to generate our final image.
The above screenshot shows four GPU counters (collected by HWCPipe), and their values when using two render passes.
We can see that there is a high number of physical tiles (<code>PTILES</code>) used and a considerable amount of bandwidth (external reads/writes).</p>
</div>
<div class="paragraph">
<p>Another technique uses a <em>single</em> render pass which is composed of two subpasses.
The first subpass generates the G-buffer and the second performs the lighting calculations to generate our final image (similarly to the two render pass technique).
On tile-based GPUs the G-buffer might be kept in tile memory across subpasses, which is why this method is considered a best practice.</p>
</div>
<div class="paragraph">
<p>The first thing that you may notice from the <a href="https://developer.arm.com/tools-and-software/embedded/arm-development-studio/components/streamline-performance-analyzer">Streamline</a> screenshot below is the difference in terms of bandwidth between the two techniques:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On the left, from <code>0s</code> to <code>3.6s</code>, the benefit of the subpasses technique is clear, as it is able to store the G-buffer on tile memory.</p>
</li>
<li>
<p>On the right, from <code>3.7s</code>, is highlighted the two render passes technique, which writes lots of data back to the external memory, as the first render pass needs to store the G-buffer in order to be read by the second render pass.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/subpasses/images/subpasses-renderpasses-trace.jpg" alt="Subpasses vs render passes trace">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_merging"><a class="anchor" href="#_merging"></a>Merging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As stated by the Vulkan reference, <em>Subpasses with simple framebuffer-space dependencies may be merged into a single tile rendering pass, keeping the attachment data on-chip for the duration of a renderpass.</em> [<a href="#references">2</a>].</p>
</div>
<div class="paragraph">
<p>Since subpass information is known ahead of time, the driver is able to detect if two or more subpasses can be merged together.
The consequence of this is that <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/vkCmdNextSubpass.html">vkCmdNextSubpass</a> becomes a <code>NOP</code>.</p>
</div>
<div class="paragraph">
<p>In other words, a GPU driver can optimize even more by merging two or more subpasses together as long as certain requirements are met.
Such requirements may vary between vendors, the following are the ones for Arm GPUs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If merge can save a write-out/read-back;
two unrelated subpasses which don&#8217;t share any data do not benefit from multipass and will not be merged.</p>
</li>
<li>
<p>If the number of unique <code>VkAttachments</code> used for input and color attachments in all considered subpasses is &lt;= 8.
Note that depth/stencil does not count towards this limit.</p>
</li>
<li>
<p>The depth/stencil attachment does not change between subpasses.</p>
</li>
<li>
<p>Multisample counts are the same for all attachments.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On Mali devices in order to be merged, subpasses are required to use at most 128-bit per pixel of <em>tile buffer color storage</em>, although some of the more recent GPUs such as Mali-G72 increase this to up to 256-bits per pixel.
G-buffers requiring more color storage than this can be used at the expense of needing smaller tiles during fragment shading, which can reduce overall throughput and increase bandwidth reading tile lists.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/subpasses/images/good-practice.jpg" alt="Good practice">
</div>
</div>
<div class="paragraph">
<p>The best way to verify whether two subpasses are merged or not is to compare the physical tiles (<code>PTILES</code>) counter by switching between the subpasses and the render passes techniques.
When we compare the screenshots of the two render techniques on a <code>Mali-G76</code>, we can see that there is approximately a <code>55%</code> reduction in the number of tiles used (<code>262.2k/s</code> vs <code>614.7k/s</code>), and therefore a <code>55%</code> reduction in bandwidth.</p>
</div>
<div class="paragraph">
<p>In order to calculate the number in the physical tiles counter, you need to know the resolution of the device you are using and the size of a single tile.
In the case of an <code>S10 Mali-G76</code>, the resolution is <code>2220 * 1080</code> and a tile is <code>16x16</code> pixels.
Therefore every frame needs <code>(2220 * 1080) / (16 * 16) = ~9k</code> tiles.
To get the tiles every second, we multiply this number by the FPS (this can vary) so <code>9k * 30 = 270k/s</code> which is approximately what we see in the tiles counter.</p>
</div>
<div class="paragraph">
<p>It is important to note that by using a <code>VkImageFormat</code> that requires more bits, it is most likely that the G-buffer will no longer fit the drivers budget, denying the possibility to merge the subpasses.
The following picture shows how the number of physical tiles used almost doubles to <code>409.6k/s</code>, indicating that subpasses are not merged.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/subpasses/images/gbuffer-size.jpg" alt="G-buffer size">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transient_attachments"><a class="anchor" href="#_transient_attachments"></a>Transient attachments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Some framebuffer attachments in the sample (such as <em>depth</em>, <em>albedo</em>, and <em>normal</em>), are cleared at the beginning of the render pass, written by the geometry subpass, read by the lighting subpass, and discarded at the end of the render pass.
If the GPU has enough memory available to store them on tile memory, there is no need to write them back to external memory.
Actually, there is not even a need to allocate them at all.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../../_images/samples/performance/subpasses/images/transient-attachments.jpg" alt="Non-transient attachments">
</div>
</div>
<div class="paragraph">
<p>In practice, their <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkImageUsageFlagBits.html">image usage</a> needs to be specified as <code>TRANSIENT</code> and their <a href="https://www.khronos.org/registry/vulkan/specs/1.1-extensions/man/html/VkMemoryPropertyFlagBits.html">memory</a> needs to be <code>LAZILY_ALLOCATED</code>.
Failing to set these flags properly will lead to an increase of <a href="https://community.arm.com/developer/tools-software/graphics/b/blog/posts/mali-bifrost-family-performance-counters">fragment jobs</a> as the GPU will need to write them back to external memory.
As you can see in the above screenshot, we see roughly a double in fragment jobs per second (from <code>56/s</code> to <code>113/s</code>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_further_reading"><a class="anchor" href="#_further_reading"></a>Further reading</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://community.arm.com/developer/tools-software/graphics/b/blog/posts/vulkan-multipass-at-gdc-2017">Vulkan Multipass at GDC 2017</a> - community.arm.com</p>
</li>
<li>
<p><a href="https://arm-software.github.io/vulkan-sdk/multipass.html">Deferring shading with Multipass</a> - arm-software.github.io</p>
</li>
<li>
<p><a href="https://www.saschawillems.de/blog/2018/07/19/vulkan-input-attachments-and-sub-passes/">Vulkan input attachments and subpasses</a> - saschawillems.de</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references"><a class="anchor" href="#_references"></a>References</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://stackoverflow.com/a/32246825">Getting World Position from Depth Buffer Value</a> - stackoverflow.com</p>
</li>
<li>
<p><a href="https://vulkan.lunarg.com/doc/view/1.0.37.0/linux/vkspec.chunked/ch07.html">Render Pass</a> - vulkan.lunarg.com</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_best_practice_summary"><a class="anchor" href="#_best_practice_summary"></a>Best-practice summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Do</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use subpasses.</p>
</li>
<li>
<p>Keep your G-buffer budget for color small.</p>
</li>
<li>
<p>Use <code>DEPTH_STENCIL_READ_ONLY</code> image layout for depth after the geometry pass is done.</p>
</li>
<li>
<p>Use <code>LAZILY_ALLOCATED</code> memory to back images for every attachment except for the light buffer, which is the only texture written out to memory.</p>
</li>
<li>
<p>Follow the basic <a href="#../render_passes/README.adoc" class="xref unresolved">render pass best practices</a>, with <code>LOAD_OP_CLEAR</code> or <code>LOAD_OP_DONT_CARE</code> for attachment loads and <code>STORE_OP_DONT_CARE</code> for transient stores.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Don&#8217;t</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Store G-buffer data out to memory.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Impact</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Not using multipass correctly may force the driver to use multiple physical passes, sending intermediate image data back via main memory between passes.
This loses all benefits of the multipass rendering feature.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Debugging</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>The GPU performance counters provide information about the number of physical tiles rendered, which can be used to determine if passes are being merged.</p>
</li>
<li>
<p>The GPU performance counters provide information about the number of fragment threads using late-zs testing, a high value here can be indicative of failing to use <code>DEPTH_STENCIL_READ_ONLY</code> correctly.</p>
</li>
</ul>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <!--
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
    -->
</footer>
<script id="site-script" src="../../../../../_/js/site.js" data-ui-root-path="../../../../../_"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../../.." data-snippet-length="100" data-stylesheet="../../../../../_/css/search.css"></script>
<script async src="../../../../../search-index.js"></script>
  </body>
</html>
