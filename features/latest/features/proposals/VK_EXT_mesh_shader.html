<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VK_EXT_mesh_shader :: Vulkan Documentation Project</title>
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../..">Vulkan Documentation Project</a>
      <div class="navbar-item">
        <img alt="Vulkan White Label" src="../../../../_/Vulkan_White_Dec16.svg" height="100%" />
      </div>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <label for="search-input"></label><input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <!-- <a class="navbar-item" href="#">Home</a> -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Specs</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../spec/latest/chapters/introduction.html">Vulkan 1.3</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Guides</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../guide/latest/index.html">Vulkan Guide</a>
          </div>
        </div>
            <!--
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Tools</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">TBD</a>
          </div>
        </div>
            -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Tutorial</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../tutorial/latest/index.html">Vulkan Tutorial</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Samples</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../samples/latest/README.html">Vulkan Samples</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Help</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://discord.gg/vulkan">Vulkan Discord</a>
            <a class="navbar-item" href="https://khr.io/khrdiscord">Khronos Discord</a>
          </div>
        </div>
            <!--
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
            -->
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="features" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Vulkan Feature Descriptions</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Vulkan Roadmap and Feature Descriptions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Roadmap.html">Vulkan Roadmap</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Feature Descriptions</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_AMDX_shader_enqueue.html">VK_AMDX_shader_enqueue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_AMD_anti_lag.html">VK_AMD_anti_lag</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_AMD_shader_early_and_late_fragment_tests.html">VK_AMD_shader_early_and_late_fragment_tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_ANDROID_external_format_resolve.html">VK_ANDROID_external_format_resolve</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_ARM_render_pass_striped.html">VK_ARM_render_pass_striped</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_attachment_feedback_loop_dynamic_state.html">VK_EXT_attachment_feedback_loop_dynamic_state</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_attachment_feedback_loop_layout.html">VK_EXT_attachment_feedback_loop_layout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_calibrated_timestamps.html">VK_EXT_calibrated_timestamps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_depth_bias_control.html">VK_EXT_depth_bias_control</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_depth_clamp_control.html">VK_EXT_depth_clamp_control</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_descriptor_buffer.html">VK_EXT_descriptor_buffer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_device_fault.html">VK_EXT_device_fault</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_device_generated_commands.html">VK_EXT_device_generated_commands</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_dynamic_rendering_unused_attachments.html">VK_EXT_dynamic_rendering_unused_attachments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_extended_dynamic_state3.html">VK_EXT_extended_dynamic_state3</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_external_memory_acquire_unmodified.html">VK_EXT_external_memory_acquire_unmodified</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_frame_boundary.html">Proposal: <code>VK_EXT_frame_boundary</code></a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_graphics_pipeline_library.html">VK_EXT_graphics_pipeline_library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_host_image_copy.html">VK_EXT_host_image_copy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_image_2d_array_of_3d.html">VK_EXT_image_2d_array_of_3d</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_image_compression_control.html">VK_EXT_image_compression_control</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_image_sliced_view_of_3d.html">VK_EXT_image_sliced_view_of_3d</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_layer_settings.html">VK_EXT_layer_settings</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_legacy_dithering.html">VK_EXT_legacy_dithering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_legacy_vertex_attributes.html">VK_EXT_legacy_vertex_attributes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_map_memory_placed.html">VK_EXT_map_memory_placed</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="VK_EXT_mesh_shader.html">VK_EXT_mesh_shader</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_metal_objects.html">VK_EXT_metal_objects</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_multisampled_render_to_single_sampled.html">VK_EXT_multisampled_render_to_single_sampled</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_mutable_descriptor_type.html">VK_EXT_mutable_descriptor_type</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_non_seamless_cube_map.html">VK_EXT_non_seamless_cube_map</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_opacity_micromap.html">VK_EXT_opacity_micromap</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_pipeline_library_group_handles.html">VK_EXT_pipeline_library_group_handles</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_pipeline_protected_access.html">VK_EXT_pipeline_protected_access</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_present_mode_fifo_latest_ready.html">VK_EXT_present_mode_fifo_latest_ready</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_primitives_generated_query.html">VK_EXT_primitives_generated_query</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_rasterization_order_attachment_access.html">VK_EXT_rasterization_order_attachment_access</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_shader_module_identifier.html">VK_EXT_shader_module_identifier</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_shader_object.html">VK_EXT_shader_object</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_shader_replicated_composites.html">VK_EXT_shader_replicated_composites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_shader_tile_image.html">VK_EXT_shader_tile_image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_subpass_merge_feedback.html">VK_EXT_subpass_merge_feedback</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_surface_maintenance1.html">VK_EXT_surface_maintenance1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_swapchain_maintenance1.html">VK_EXT_swapchain_maintenance1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_GOOGLE_surfaceless_query.html">VK_GOOGLE_surfaceless_query</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_HUAWEI_cluster_culling_shader.html">VK_HUAWEI_cluster_culling_shader</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_HUAWEI_invocation_mask.html">VK_HUAWEI_invocation_mask</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_compute_shader_derivatives.html">VK_KHR_compute_shader_derivatives</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_cooperative_matrix.html">VK_KHR_cooperative_matrix</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_dynamic_rendering.html">VK_KHR_dynamic_rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_dynamic_rendering_local_read.html">VK_KHR_dynamic_rendering_local_read</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_fragment_shader_barycentric.html">VK_KHR_fragment_shader_barycentric</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_fragment_shading_rate.html">VK_KHR_fragment_shading_rate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_load_store_op_none.html">VK_KHR_load_store_op_none</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_maintenance5.html">VK_KHR_maintenance5</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_maintenance6.html">VK_KHR_maintenance6</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_maintenance7.html">VK_KHR_maintenance7</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_map_memory2.html">VK_KHR_map_memory2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_pipeline_binary.html">VK_KHR_pipeline_binary</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_ray_tracing_position_fetch.html">VK_KHR_ray_tracing_position_fetch</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_expect_assume.html">VK_KHR_shader_expect_assume</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_float_controls2.html">VK_KHR_shader_float_controls2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_integer_dot_product.html">VK_KHR_shader_integer_dot_product</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_maximal_reconvergence.html">VK_KHR_shader_maximal_reconvergence</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_quad_control.html">VK_KHR_shader_quad_control</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_relaxed_extended_instruction.html">VK_KHR_shader_relaxed_extended_instruction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_subgroup_rotate.html">Subgroup rotation instruction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_vertex_attribute_divisor.html">VK_KHR_vertex_attribute_divisor</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_decode_av1.html">VK_KHR_video_decode_av1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_decode_h264.html">VK_KHR_video_decode_h264</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_decode_h265.html">VK_KHR_video_decode_h265</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_decode_queue.html">VK_KHR_video_decode_queue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_encode_av1.html">VK_KHR_video_encode_av1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_encode_h264.html">VK_KHR_video_encode_h264</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_encode_h265.html">VK_KHR_video_encode_h265</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_encode_quantization_map.html">VK_KHR_video_encode_quantization_map</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_encode_queue.html">VK_KHR_video_encode_queue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_maintenance1.html">VK_KHR_video_maintenance1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_queue.html">VK_KHR_video_queue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_LUNARG_direct_driver_loading.html">VK_LUNARG_direct_driver_loading</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_MSFT_layered_driver.html">VK_MSFT_layered_driver</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_NV_cooperative_matrix2.html">VK_NV_cooperative_matrix2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_NV_display_stereo.html">VK_NV_display_stereo</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_NV_ray_tracing_validation.html">VK_NV_ray_tracing_validation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_QCOM_image_processing.html">VK_QCOM_image_processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_QCOM_tile_properties.html">VK_QCOM_tile_properties</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_VERSION_1_4.html">Vulkan 1.4</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Vulkan Feature Descriptions</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../tutorial/latest/00_Introduction.html">Khronos Vulkan Tutorial</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../tutorial/latest/00_Introduction.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../glsl/latest/index.html">OpenGL Shading Language Specification</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../glsl/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">Vulkan Feature Descriptions</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../guide/latest/index.html">Vulkan Guide</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../guide/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../samples/latest/README.html">Vulkan Samples</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../samples/latest/README.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../spec/latest/index.html">Vulkan Specification</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../spec/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../spec/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Vulkan Feature Descriptions</a></li>
    <li>Feature Descriptions</li>
    <li><a href="VK_EXT_mesh_shader.html">VK_EXT_mesh_shader</a></li>
  </ul>
</nav>
    <!--
    -->
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">VK_EXT_mesh_shader</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_problem_statement">1. Problem Statement</a></li>
<li><a href="#_solution_space">2. Solution Space</a></li>
<li><a href="#_proposal">3. Proposal</a>
<ul class="sectlevel2">
<li><a href="#new-shaders">3.1. New Shaders</a></li>
<li><a href="#_api_changes">3.2. API Changes</a></li>
<li><a href="#_spir_v_changes">3.3. SPIR-V Changes</a></li>
<li><a href="#_glsl_changes">3.4. GLSL Changes</a></li>
<li><a href="#_hlsl_changes">3.5. HLSL Changes</a></li>
</ul>
</li>
<li><a href="#_issues">4. Issues</a>
<ul class="sectlevel2">
<li><a href="#_what_are_the_differences_to_vk_nv_mesh_shader">4.1. What are the differences to VK_NV_mesh_shader?</a></li>
<li><a href="#_what_are_the_differences_to_directx_12s_mesh_shaders">4.2. What are the differences to DirectX® 12&#8217;s Mesh shaders?</a></li>
<li><a href="#_can_there_be_more_than_one_output_payload_in_a_task_shader">4.3. Can there be more than one output payload in a task shader?</a></li>
<li><a href="#_should_developers_port_everything_to_mesh_shading">4.4. Should developers port everything to mesh shading?</a></li>
<li><a href="#_does_vertex_input_interface_state_interact_with_taskmesh_shaders">4.5. Does vertex input interface state interact with task/mesh shaders?</a></li>
</ul>
</li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This extension provides a new mechanism allowing applications to generate collections of geometric primitives via programmable mesh shading.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_problem_statement"><a class="anchor" href="#_problem_statement"></a>1. Problem Statement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The rasterization pipeline for Vulkan is fairly fixed - a fixed input stage assembles vertex data for the vertex shader, data optionally passes through tessellation and geometry stages, then fixed vertex processing passes the resulting primitives to the rasterizer.
As rendering engines get increasingly complex, the fixed nature of this pipeline has become a bottleneck; many developers are augmenting their rasterization pipelines with compute shaders to make them more flexible.
Using compute shaders comes at a cost though - data has to be piped via global memory, and once there it still has to be optimized for an implementation&#8217;s vertex caches or face performance penalties.
With compute shaders processing geometry, the role of the vertex shader is also somewhat redundant - transformations could be performed just as easily in compute shaders, and the vertex shader serves merely as a way to get at the fixed rasterization interface.</p>
</div>
<div class="paragraph">
<p>This proposal aims to find a way to make the geometry pipeline more flexible, removing the unnecessary cost of an extra shader.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solution_space"><a class="anchor" href="#_solution_space"></a>2. Solution Space</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Making the geometry pipeline more flexible requires rethinking how data is transmitted from buffers to device memory; ideally a solution should allow applications to flexibly modify the set of geometry as a whole in the way developers are currently using compute shaders, and how they may use them in future (e.g. culling, grouping, decompression), without compromising on efficiency. Some considered ways to do this include:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Giving vertex shaders defined grouping, and enabling communication via subgroup operations</p>
</li>
<li>
<p>Skipping the vertex shader and using geometry or tessellation shaders at the start of the pipeline</p>
</li>
<li>
<p>Use compute shaders in place of pre-rasterization shader stages</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>While a defined grouping in the vertex shaders would give applications the ability to manipulate sets of vertices, there is very limited ability to cull or remove vertices or primitives within a group, and the groups would be limited by the size of subgroups on the GPU without significant modifications.
Similarly, applications would be largely constrained by fixed input assembly requiring a 1:1 ratio of indices to input vertices, meaning things like decompressing meshes or acting at any granularity other than vertices would be infeasible.
Changing the vertex stage to accommodate this extra flexibility would require significant changes to how the stage works, which could likely better be accommodated by other existing stages.</p>
</div>
<div class="paragraph">
<p>Skipping vertex shading and jumping straight to geometry or tessellation stages would provide a level of flexibility that could be interesting - both have access to geometric data at a granularity other than vertices, and are able to remove or add geometric detail before rasterization.
The main issues with these stages is that they are still rather fixed in terms of inputs, output topology, and the granularity they operate at - they are also historically not very efficient across platforms, and removing the vertex shader from the front of the pipeline would not do much to help that.</p>
</div>
<div class="paragraph">
<p>The last clear option is to effectively use compute shaders in place of existing rasterization stages, enabling applications to more easily port existing compute shaders to this new extension with all the flexibility intact.
The main difficulty with this is simply defining the interface between the shader and the rasterizer, as existing compute shaders simply write out to buffers, whereas rasterization hardware is highly specialized, and may need to be fed in a particular manner.</p>
</div>
<div class="paragraph">
<p>This extension opts for something close to option 3, by replacing all pre-rasterization shaders in the graphics pipeline with two new stages that operate like compute shaders but with output that can be consumed by the rasterizer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proposal"><a class="anchor" href="#_proposal"></a>3. Proposal</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="new-shaders"><a class="anchor" href="#new-shaders"></a>3.1. New Shaders</h3>
<div class="paragraph">
<p>This proposal adds two new shader stages, which can be used in place of the existing pre-rasterization shader stages; <a href="#mesh-shaders">Mesh Shaders</a> and <a href="#task-shaders">Task Shaders</a>.</p>
</div>
<div class="sect3">
<h4 id="mesh-shaders"><a class="anchor" href="#mesh-shaders"></a>3.1.1. Mesh Shaders</h4>
<div class="paragraph">
<p>Mesh shaders are a new compute-like shader stage that has a primary aim of generating a set of primitives to the rasterizer, which are passed via its new output interface.
For the most part, these map well to compute shaders - they are dispatched in workgroups and have access to shared memory, workgroup barriers, and local IDs, allowing for a lot of flexibility in how they are executed.</p>
</div>
<div class="paragraph">
<p>Unlike vertex shaders, they do not use the vertex input interface, and geometry and indices <strong>must</strong> be generated by the shader or read from buffers with no requirement for applications to provide the data in a particular way.
As such, this allows applications to read or generate data however they need to, removing the need to prepare data before launching the graphics pipeline.
This allows items such as decompression or decryption of data to be performed within the graphics pipeline directly, avoiding the bandwidth cost typically associated with compute shaders.</p>
</div>
<div class="paragraph">
<p>Another key part of mesh shaders is that the number of primitives that a given workgroup can emit is dynamic - there are limits to how much can be emitted, which is advertised by the implementation, but applications can freely emit fewer primitives than the maximum.
This allows things like modifying the LOD at a fine granularity without the use of tessellation.
Vertex outputs are written via the <code>Output</code> storage class and using standard built-ins like <code>Position</code> and <code>PointSize</code>, but are written as arrays in the same way as a tessellation control shader&#8217;s outputs.
Additionally, the mesh shader outputs indices per primitive according to the output primitive type (points, lines, or triangles). Indices are emitted as a separate array in a similar fashion to vertex outputs.
Mesh shader output topologies are lists only - there is no support for triangle or line strips or triangle fans; data in these formats must be unpacked by the shader.
Other user data can be emitted at per-vertex or per-primitive rates alongside these built-ins.
Mesh shaders must specify the actual number of primitives and vertices being emitted before writing them, via the <code>OpSetMeshOutputsEXT</code> instruction.
Subsequent fragment shaders can retrieve input data at both rates, tied to the vertices and primitive being rasterized.</p>
</div>
<div class="paragraph">
<p>Mesh shaders can be dispatched from the API like a compute shader would be, or launched via <a href="#task-shaders">Task Shaders</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="task-shaders"><a class="anchor" href="#task-shaders"></a>3.1.2. Task Shaders</h4>
<div class="paragraph">
<p>Task shaders are an optional shader stage that executes ahead of mesh shaders. A task shader is dispatched like a compute shader, and indirectly dispatches mesh shader workgroups.
This shader is another compute-like stage that is executed in workgroups and has all the other features of compute shaders as well, with the addition of access to a dedicated instruction to launch mesh shaders.</p>
</div>
<div class="paragraph">
<p>The primary function of task shaders is to dispatch mesh shaders via <code>OpEmitMeshTasksEXT</code>, which takes as input a number of mesh shader groups to emit, and a payload variable that will be visible to all mesh shader invocations launched by this instruction.
This instruction is executed once per workgroup rather than per-invocation, and the payload itself is in a workgroup-wide storage class, similar to shared memory.
Once this instruction is called, the workgroup is terminated immediately, and the mesh shaders are launched.</p>
</div>
<div class="paragraph">
<p>Task shaders can be used for functionality like coarse culling of entire meshlets or dynamically generating more or less geometry depending on the LOD required.
This is notionally similar to the purpose of tessellation shaders, but without the constraint of fixed functionality, and with greater flexibility in how primitives are executed.
Applications can use task shaders to determine the number of launched mesh shader workgroups at whatever input granularity they want, and however they see fit.</p>
</div>
</div>
<div class="sect3">
<h4 id="_rasterization_order"><a class="anchor" href="#_rasterization_order"></a>3.1.3. Rasterization Order</h4>
<div class="paragraph">
<p>As task and mesh shaders change how primitives are dispatched, a subsequent modification of rasterization order is made.
Within a mesh shader workgroup, primitives are rasterized in the order in which they are defined in the output.
A group of mesh shaders either launched directly by the API, indirectly by the API,
or indirectly from a single task shader workgroup will rasterize their outputs in sequential order based on their flattened global invocation index,
equal to <span class="steminline"> <svg style="vertical-align: -0.464ex; overflow: visible;" xmlns="http://www.w3.org/2000/svg" width="26.073ex" height="2.034ex" role="img" focusable="false" viewBox="0 -694 11524.2 899"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mstyle"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mo" transform="translate(794.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(1794.4,0)"><path data-c="1D466" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(2506.7,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path></g><g data-mml-node="mi" transform="translate(3006.9,0)"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></g><g data-mml-node="mrow" id="h + z * width * height" transform="translate(3722.9,694)"><text data-id-align="true"></text><g data-idbox="true" transform="translate(0,-694)"><g data-mml-node="mi"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g></g></g><g data-mml-node="mo" transform="translate(4521.1,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mi" transform="translate(5521.3,0)"><path data-c="1D467" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z"></path></g><g data-mml-node="mo" transform="translate(6208.6,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path></g><g data-mml-node="mi" transform="translate(6708.8,0)"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></g><g data-mml-node="mrow" id="h * height" transform="translate(7424.8,694)"><text data-id-align="true"></text><g data-idbox="true" transform="translate(0,-694)"><g data-mml-node="mi"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g></g></g><g data-mml-node="mo" transform="translate(8223,0)"><path data-c="22C5" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250Z"></path></g><g data-mml-node="mi" transform="translate(8723.2,0)"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mi" transform="translate(9299.2,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(9765.2,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(10110.2,0)"><path data-c="1D454" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path></g><g data-mml-node="mi" transform="translate(10587.2,0)"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mi" transform="translate(11163.2,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g></g></g></g></svg> </span>, where <code>x</code>, <code>y</code>, and <code>z</code> refer to the components of the <code>GlobalInvocationId</code> built-in.
<code>width</code> and <code>height</code> are equal to <code>NumWorkgroups</code> times <code>WorkgroupSize</code> for their respective dimensions.
When using task shaders, there is no rasterization order guarantee between mesh shaders launched by separate task shader workgroups, even within the same draw command.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_api_changes"><a class="anchor" href="#_api_changes"></a>3.2. API Changes</h3>
<div class="sect3">
<h4 id="_graphics_pipeline_creation"><a class="anchor" href="#_graphics_pipeline_creation"></a>3.2.1. Graphics Pipeline Creation</h4>
<div class="paragraph">
<p>Graphics pipelines can now be created using mesh and task shaders in place of vertex, tessellation, and geometry shaders.
This can be achieved by omitting existing pre-rasterization shaders and including a mesh shader stage, and optionally a task shader stage.
When present, a graphics pipeline is complete without the inclusion of the <a href="https://www.khronos.org/registry/vulkan/specs/latest/html/vkspec.html#pipeline-graphics-subsets-vertex-input">vertex input state subset</a>, as this state does not participate in mesh pipelines.
No other modifications to graphics pipelines are necessary.
Two new shader stages are added to the API to describe the new shader stages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">VK_SHADER_STAGE_TASK_BIT = 0x40,
VK_SHADER_STAGE_MESH_BIT = 0x80,</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that <code>VK_SHADER_STAGE_ALL_GRAPHICS_BIT</code> was defined as a mask of existing bits during Vulkan 1.0 development, and thus cannot include these new bits; modifying it would break compatibility.</p>
</div>
</div>
<div class="sect3">
<h4 id="_synchronization"><a class="anchor" href="#_synchronization"></a>3.2.2. Synchronization</h4>
<div class="paragraph">
<p>New pipeline stages are added for synchronization of these new stages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">VK_PIPELINE_STAGE_TASK_SHADER_BIT_EXT = 0x80000,
VK_PIPELINE_STAGE_MESH_SHADER_BIT_EXT = 0x100000,</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">static const VkPipelineStageFlagBits2KHR VK_PIPELINE_STAGE_TASK_SHADER_BIT_2_EXT = 0x00080000ULL;
static const VkPipelineStageFlagBits2KHR VK_PIPELINE_STAGE_MESH_SHADER_BIT_2_EXT = 0x00100000ULL;</code></pre>
</div>
</div>
<div class="paragraph">
<p>These new pipeline stages interact similarly to compute shaders, with all the same access types and operations.
They are also logically ordered before fragment shading, but have no logical ordering compared to existing pre-rasterization shader stages.
The <code>VK_PIPELINE_STAGE_2_PRE_RASTERIZATION_SHADERS_BIT</code> stage added by <a href="https://docs.vulkan.org/spec/latest/appendices/extensions.html#VK_KHR_synchronization2">VK_KHR_synchronization2</a> includes these new shader stages, and can be used identically.</p>
</div>
</div>
<div class="sect3">
<h4 id="_queries"><a class="anchor" href="#_queries"></a>3.2.3. Queries</h4>
<div class="paragraph">
<p>Pipeline statistics queries are updated with new bits to count mesh and task shader invocations, in a similar manner to how other shader invocations are counted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">VK_QUERY_PIPELINE_STATISTIC_TASK_SHADER_INVOCATIONS_BIT_EXT = 0x800,
VK_QUERY_PIPELINE_STATISTIC_MESH_SHADER_INVOCATIONS_BIT_EXT = 0x1000,</code></pre>
</div>
</div>
<div class="paragraph">
<p>An additional standalone query counting the number of mesh primitives generated is added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">VK_QUERY_TYPE_MESH_PRIMITIVES_GENERATED_EXT = 1000328000,</code></pre>
</div>
</div>
<div class="paragraph">
<p>An active query of this type will generate a count of every individual primitive emitted from any mesh shader workgroup that is not culled by fixed function culling.</p>
</div>
</div>
<div class="sect3">
<h4 id="_draw_calls"><a class="anchor" href="#_draw_calls"></a>3.2.4. Draw Calls</h4>
<div class="paragraph">
<p>Three new draw calls are added to the API to dispatch mesh pipelines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">VKAPI_ATTR void VKAPI_CALL vkCmdDrawMeshTasksEXT(
    VkCommandBuffer                             commandBuffer,
    uint32_t                                    groupCountX,
    uint32_t                                    groupCountY,
    uint32_t                                    groupCountZ);

VKAPI_ATTR void VKAPI_CALL vkCmdDrawMeshTasksIndirectEXT(
    VkCommandBuffer                             commandBuffer,
    VkBuffer                                    buffer,
    VkDeviceSize                                offset,
    uint32_t                                    drawCount,
    uint32_t                                    stride);

VKAPI_ATTR void VKAPI_CALL vkCmdDrawMeshTasksIndirectCountEXT(
    VkCommandBuffer                             commandBuffer,
    VkBuffer                                    buffer,
    VkDeviceSize                                offset,
    VkBuffer                                    countBuffer,
    VkDeviceSize                                countBufferOffset,
    uint32_t                                    maxDrawCount,
    uint32_t                                    stride);

typedef struct VkDrawMeshTasksIndirectCommandEXT {
    uint32_t    x;
    uint32_t    y;
    uint32_t    z;
} VkDrawMeshTasksIndirectCommandEXT;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>vkCmdDrawMeshTasksEXT</code> is the simplest as it functions the same as <a href="https://docs.vulkan.org/spec/latest/chapters/dispatch.html#vkCmdDispatch">vkCmdDispatch</a>, but dispatches the mesh or task shader in a graphics pipeline with the specified workgroup counts, rather than a compute shader.</p>
</div>
<div class="paragraph">
<p><code>vkCmdDrawMeshTasksIndirectEXT</code> functions similarly to <a href="https://docs.vulkan.org/spec/latest/chapters/dispatch.html#vkCmdDispatchIndirect">vkCmdDispatchIndirect</a>, but with the draw count functionality from other draw commands.
Multiple draws are dispatched according to the <code>drawCount</code> parameter, with data in buffer being consumed as a strided array of <code>VkDrawMeshTasksIndirectCommandEXT</code> structures, with stride equal to <code>stride</code>.
Each element of this array defines a separate draw call&#8217;s workgroup counts in each dimension, and dispatches mesh or task shaders for the current pipeline accordingly.</p>
</div>
<div class="paragraph">
<p><code>vkCmdDrawMeshTasksIndirectCountEXT</code> functions as <code>vkCmdDrawMeshTasksIndirectEXT</code>, but takes its draw count from the device as well.
The draw count is read from <code>countBuffer</code> at an offset of <code>countBufferOffset</code>, and must be lower than <code>maxDrawCount</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="properties"><a class="anchor" href="#properties"></a>3.2.5. Properties</h4>
<div class="paragraph">
<p>Several new properties are added to the API - some dictating hard limits, and others indicating performance considerations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">typedef struct VkPhysicalDeviceMeshShaderPropertiesEXT {
    VkStructureType    sType;
    void*              pNext;
    uint32_t           maxTaskWorkGroupTotalCount;
    uint32_t           maxTaskWorkGroupCount[3];
    uint32_t           maxTaskWorkGroupInvocations;
    uint32_t           maxTaskWorkGroupSize[3];
    uint32_t           maxTaskPayloadSize;
    uint32_t           maxTaskSharedMemorySize;
    uint32_t           maxTaskPayloadAndSharedMemorySize;
    uint32_t           maxMeshWorkGroupTotalCount;
    uint32_t           maxMeshWorkGroupCount[3];
    uint32_t           maxMeshWorkGroupInvocations;
    uint32_t           maxMeshWorkGroupSize[3];
    uint32_t           maxMeshSharedMemorySize;
    uint32_t           maxMeshPayloadAndSharedMemorySize;
    uint32_t           maxMeshOutputMemorySize;
    uint32_t           maxMeshPayloadAndOutputMemorySize;
    uint32_t           maxMeshOutputComponents;
    uint32_t           maxMeshOutputVertices;
    uint32_t           maxMeshOutputPrimitives;
    uint32_t           maxMeshOutputLayers;
    uint32_t           maxMeshMultiviewViewCount;
    uint32_t           meshOutputPerVertexGranularity;
    uint32_t           meshOutputPerPrimitiveGranularity;
    uint32_t           maxPreferredTaskWorkGroupInvocations;
    uint32_t           maxPreferredMeshWorkGroupInvocations;
    VkBool32           prefersLocalInvocationVertexOutput;
    VkBool32           prefersLocalInvocationPrimitiveOutput;
    VkBool32           prefersCompactVertexOutput;
    VkBool32           prefersCompactPrimitiveOutput;
} VkPhysicalDeviceMeshShaderPropertiesEXT;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following limits affect task shader execution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>maxTaskWorkGroupTotalCount</code> indicates the total number of workgroups that can be launched for a task shader.</p>
</li>
<li>
<p><code>maxTaskWorkGroupCount</code> indicates the number of workgroups that can be launched for a task shader in each given dimension.</p>
</li>
<li>
<p><code>maxTaskWorkGroupInvocations</code> indicates the total number of invocations that can be launched for a task shader in a single workgroup.</p>
</li>
<li>
<p><code>maxTaskWorkGroupSize</code> indicates the maximum number of invocations for a task shader in each dimension for a single workgroup.</p>
</li>
<li>
<p><code>maxTaskPayloadSize</code> indicates the maximum total size of task shader output payloads.</p>
</li>
<li>
<p><code>maxTaskSharedMemorySize</code> indicates the maximum total size of task shader shared memory variables.</p>
</li>
<li>
<p><code>maxTaskPayloadAndSharedMemorySize</code> indicates the maximum total combined size of task shader output payloads and shared memory variables.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Similar limits affect task shader execution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>maxMeshWorkGroupTotalCount</code> indicates the total number of workgroups that can be launched for a mesh shader.</p>
</li>
<li>
<p><code>maxMeshWorkGroupCount</code> indicates the number of workgroups that can be launched for a mesh shader in each given dimension.</p>
</li>
<li>
<p><code>maxMeshWorkGroupInvocations</code> indicates the total number of invocations that can be launched for a mesh shader in a single workgroup.</p>
</li>
<li>
<p><code>maxMeshWorkGroupSize</code> indicates the maximum number of invocations for a mesh shader in each dimension for a single workgroup.</p>
</li>
<li>
<p><code>maxMeshSharedMemorySize</code> indicates the maximum total size of mesh shader shared memory variables.</p>
</li>
<li>
<p><code>maxMeshPayloadAndSharedMemorySize</code> indicates the maximum total combined size of mesh shader input payloads and shared memory variables.</p>
</li>
<li>
<p><code>maxMeshSharedMemorySize</code> indicates the maximum total size of mesh shader output variables.</p>
</li>
<li>
<p><code>maxMeshPayloadAndOutputMemorySize</code> indicates the maximum total combined size of mesh shader input payloads and output variables.</p>
</li>
<li>
<p><code>maxMeshOutputComponents</code> is the maximum number of components of mesh shader output variables.</p>
</li>
<li>
<p><code>maxMeshOutputVertices</code> is the maximum number of vertices a mesh shader can emit.</p>
</li>
<li>
<p><code>maxMeshOutputPrimitives</code> is the maximum number of primitives a mesh shader can emit.</p>
</li>
<li>
<p><code>maxMeshOutputLayers</code> is the maximum number of layers that a mesh shader can render to.</p>
</li>
<li>
<p><code>maxMeshMultiviewViewCount</code> is the maximum number of views that a mesh shader can render to.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When considering the above properties, the number of mesh shader outputs a shader uses are rounded up to implementation-defined numbers defined by the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>meshOutputPerVertexGranularity</code> is the alignment of each per-vertex mesh shader output.</p>
</li>
<li>
<p><code>meshOutputPerPrimitiveGranularity</code> is the alignment of each per-primitive mesh shader output.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following properties are implementation preferences.
Violating these limits will not result in validation errors, but it is strongly recommended that applications adhere to them in order to maximize performance on each implementation.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>maxPreferredTaskWorkGroupInvocations</code> indicates the maximum preferred number of task shader invocations in a single workgroup.</p>
</li>
<li>
<p><code>maxPreferredMeshWorkGroupInvocations</code> indicates the maximum preferred number of mesh shader invocations in a single workgroup.</p>
</li>
<li>
<p>If <code>prefersLocalInvocationVertexOutput</code> is <code>VK_TRUE</code>, the implementation will perform best when each invocation writes to an array index in the per-vertex output matching <code>LocalInvocationIndex</code>.</p>
</li>
<li>
<p>If <code>prefersLocalInvocationPrimitiveOutput</code> is <code>VK_TRUE</code>, the implementation will perform best when each invocation writes to an array index in the per-primitive output matching <code>LocalInvocationIndex</code>.</p>
</li>
<li>
<p>If <code>prefersCompactVertexOutput</code> is <code>VK_TRUE</code>, the implementation will perform best if there are no unused vertices in the output array.</p>
</li>
<li>
<p>If <code>prefersCompactPrimitiveOutput</code> is <code>VK_TRUE</code>, the implementation will perform best if there are no unused primitives in the output array.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that even if some of the above values are false, the implementation can still perform just as well whether or not the corresponding preferences are followed. It is recommended to follow these preferences unless the performance cost of doing so outweighs the gains of hitting the optimal paths in the implementation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_features"><a class="anchor" href="#_features"></a>3.2.6. Features</h4>
<div class="paragraph">
<p>A few new features are introduced by this extension:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">typedef struct VkPhysicalDeviceMeshShaderFeaturesEXT {
    VkStructureType    sType;
    void*              pNext;
    VkBool32           taskShader;
    VkBool32           meshShader;
    VkBool32           multiviewMeshShader;
    VkBool32           primitiveFragmentShadingRateMeshShader;
    VkBool32           meshShaderQueries;
} VkPhysicalDeviceMeshShaderFeaturesEXT;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>taskShader</code> indicates support for task shaders and associated features - if not enabled, only mesh shaders can be used.</p>
</li>
<li>
<p><code>meshShader</code> indicates support for mesh shaders and associated features - if not enabled, none of the features in this extension can be used.</p>
</li>
<li>
<p><code>multiviewMeshShader</code> indicates support for the use of multi-view with mesh shaders.</p>
</li>
<li>
<p><code>primitiveFragmentShadingRateMeshShader</code> indicates whether the per-primitive fragment shading rate can be written by mesh shaders when fragment shading rates are supported.</p>
</li>
<li>
<p><code>meshShaderQueries</code> indicates support for the new queries added by this extension.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spir_v_changes"><a class="anchor" href="#_spir_v_changes"></a>3.3. SPIR-V Changes</h3>
<div class="paragraph">
<p>One new capability is added gating all of the new functionality:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">MeshShadingEXT</code></pre>
</div>
</div>
<div class="paragraph">
<p>Two new execution models are added, corresponding to the two <a href="#new-shaders">New Shaders</a> added by this extension:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">TaskEXT
MeshEXT</code></pre>
</div>
</div>
<div class="paragraph">
<p>Task shader output/mesh shader input payloads are declared in a new storage class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">TaskPayloadWorkgroupEXT</code></pre>
</div>
</div>
<div class="paragraph">
<p>Variables in this storage class are accessible by all invocations in a workgroup in a task shader, and is broadcast to all invocations in workgroups dispatched by the same task shader workgroup where it is read-only.</p>
</div>
<div class="paragraph">
<p>In task shaders, <code>TaskPayloadWorkgroupEXT</code> is a hybrid of <code>Output</code> and <code>Workgroup</code> storage classes. It supports all usual operations <code>Workgroup</code> supports, with the caveats of:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>No explicit memory layout support with <code>VK_KHR_workgroup_memory_explicit_layout</code></p>
</li>
<li>
<p>Can be declared independently of <code>Workgroup</code>, meaning local scratch workgroup memory can still be used with <code>VK_KHR_workgroup_memory_explicit_layout</code></p>
</li>
<li>
<p>Has two separate limits for size, <code>maxTaskPayloadSize</code> for its size in isolation, and <code>maxTaskPayloadAndSharedMemorySize</code> for the combined size</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Mesh shaders declare the type of primitive being output by way of three execution modes, two of which are introduced by this extension:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">OutputPoints
OutputLinesEXT
OutputTrianglesEXT</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mesh shaders declare the maximum number of vertex and primitives the shader will ever emit for the invocation group by way of two execution modes, one of which is introduced by this extension:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">OutputVertices
OutputPrimitivesEXT</code></pre>
</div>
</div>
<div class="paragraph">
<p>A new decoration is added to for mesh shader outputs/fragment shader inputs to indicate per-primitive data rather than per-vertex data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">PerPrimitiveEXT</code></pre>
</div>
</div>
<div class="paragraph">
<p>New per-primitive built-ins are added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">PrimitivePointIndicesEXT
PrimitiveLineIndicesEXT
PrimitiveTriangleIndicesEXT
CullPrimitiveEXT</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each of the <code>Primitive*IndicesEXT</code> built-ins is used when the corresponding execution mode is specified, declared as scalars or vectors with a number of components equal to the number of vertices in the primitive type.
<code>CullPrimitiveEXT</code> is a per-primitive boolean value indicating to the implementation that its corresponding primitive must not be rasterized and is instead discarded with no further processing once emitted.</p>
</div>
<div class="paragraph">
<p>A new instruction is added to task shaders to launch mesh shader workgroups:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10%;">
<col style="width: 10%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="5"><p class="tableblock"><a id="OpEmitMeshTasksEXT"></a><strong>OpEmitMeshTasksEXT</strong><br>
<br>
Defines the grid size of subsequent mesh shader workgroups to generate
upon completion of the task shader workgroup.<br>
<br>
'Group Count X Y Z' must each be a 32-bit unsigned integer value.
They configure the number of local workgroups in each respective dimensions
for the launch of child mesh tasks. See Vulkan API specification for more detail.<br>
<br>
'Payload' is an optional pointer to the payload structure to pass to the generated mesh shader invocations.
'Payload' must be the result of an <strong>OpVariable</strong> with a storage class of <strong>TaskPayloadWorkgroupEXT</strong>.<br>
<br>
The arguments are taken from the first invocation in each workgroup.
Any invocation must execute this instruction exactly once and under uniform
control flow.
This instruction also serves as an <strong>OpControlBarrier</strong> instruction, and also
performs and adheres to the description and semantics of an <strong>OpControlBarrier</strong>
instruction with the 'Execution' and 'Memory' operands set to <strong>Workgroup</strong> and
the 'Semantics' operand set to a combination of <strong>WorkgroupMemory</strong> and
<strong>AcquireRelease</strong>.
Ceases all further processing: Only instructions executed before
<strong>OpEmitMeshTasksEXT</strong> have observable side effects.<br>
<br>
This instruction must be the last instruction in a block.<br>
<br>
This instruction is only valid in the <strong>TaskEXT</strong> Execution Model.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Capability:<br>
<strong>MeshShadingEXT</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4 + variable</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5294</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'&lt;id&gt;'<br>
'Group Count X'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'&lt;id&gt;'<br>
'Group Count Y'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'&lt;id&gt;'<br>
'Group Count Z'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Optional<br>
'&lt;id&gt;'<br>
'Payload'</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>A new mesh shader instruction is added to set the number of actual primitives and vertices that a mesh shader writes, avoiding unnecessary allocations or processing by the implementation:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 37.5%;">
<col style="width: 37.5%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="3"><p class="tableblock"><a id="OpSetMeshOutputsEXT"></a><strong>OpSetMeshOutputsEXT</strong><br>
<br>
Sets the actual output size of the primitives and vertices that the mesh shader
workgroup will emit upon completion.<br>
<br>
'Vertex Count' must be a 32-bit unsigned integer value.
It defines the array size of per-vertex outputs.<br>
<br>
'Primitive Count' must a 32-bit unsigned integer value.
It defines the array size of per-primitive outputs.<br>
<br>
The arguments are taken from the first invocation in each workgroup.
Any invocation must execute this instruction no more than once and under
uniform control flow.
There must not be any control flow path to an output write that is not preceded
by this instruction.<br>
<br>
This instruction is only valid in the <strong>MeshEXT</strong> Execution Model.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Capability:<br>
<strong>MeshShadingEXT</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">5295</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'&lt;id&gt;'<br>
'Vertex Count'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">'&lt;id&gt;'<br>
'Primitive Count'</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This instruction must be called before writing to mesh shader outputs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_glsl_changes"><a class="anchor" href="#_glsl_changes"></a>3.4. GLSL Changes</h3>
<div class="paragraph">
<p>Mesh shaders defined in GLSL the same as compute shaders, with the addition of access to shader outputs normally available in vertex shaders and the following new features:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">out uint  gl_PrimitivePointIndicesEXT[];
out uvec2 gl_PrimitiveLineIndicesEXT[];
out uvec3 gl_PrimitiveTriangleIndicesEXT[];</code></pre>
</div>
</div>
<div class="paragraph">
<p>These built-ins correspond to the identically named SPIR-V constructs, and are written in the same way.
Applications should access only the index output corresponding to the primitive type declared by the following layout qualifiers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">points
lines
triangles</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each layout qualifier is declared as <code>layout(&lt;qualifier&gt;) out;</code>.</p>
</div>
<div class="paragraph">
<p>A new auxiliary storage qualifier can be added to interface variables to indicate that they are per-primitive rate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">perprimitiveEXT</code></pre>
</div>
</div>
<div class="paragraph">
<p>New write-only output blocks are defined for built-in output values from mesh shaders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">out gl_MeshPerVertexEXT {
  vec4  gl_Position;
  float gl_PointSize;
  float gl_ClipDistance[];
  float gl_CullDistance[];
} gl_MeshVerticesEXT[];

perprimitiveEXT out gl_MeshPerPrimitiveEXT {
  int  gl_PrimitiveID;
  int  gl_Layer;
  int  gl_ViewportIndex;
  bool gl_CullPrimitiveEXT;
  int  gl_PrimitiveShadingRateEXT;
} gl_MeshPrimitivesEXT[];</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that some existing outputs that previously were associated by provoking vertices are now directly declared as per-primitive variables.</p>
</div>
<div class="paragraph">
<p>Finally a new mesh-shader function is added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">    void SetMeshOutputsEXT(uint vertexCount,
                           uint primitiveCount)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This function maps exactly to the <code>OpSetMeshOutputsEXT</code> instruction - setting the number of valid vertices and primitives that are output by the mesh shader workgroup.</p>
</div>
<div class="paragraph">
<p>Task shader payloads can be declared in task and mesh shaders using the new <code>taskPayloadSharedEXT</code> storage qualifier as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">taskPayloadSharedEXT MyPayloadStruct {
    ...
} payload;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally a new function corresponding to <code>OpEmitMeshTasksEXT</code> is added to launch mesh workgroups:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-glsl hljs" data-lang="glsl">    void EmitMeshTasksEXT(uint groupCountX,
                          uint groupCountY,
                          uint groupCountZ)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hlsl_changes"><a class="anchor" href="#_hlsl_changes"></a>3.5. HLSL Changes</h3>
<div class="paragraph">
<p>The HLSL specification for mesh shaders is defined by Microsoft® here: <a href="https://microsoft.github.io/DirectX-Specs/d3d/MeshShader.html" class="bare">https://microsoft.github.io/DirectX-Specs/d3d/MeshShader.html</a>.</p>
</div>
<div class="paragraph">
<p>Everything in that specification should work directly as described, with the exception of linking per-primitive interface variables between pixel and mesh shaders.
Microsoft defined the fragment/mesh interface to effectively be fixed up at link time - making no distinction between per-vertex and per-primitive variables in the pixel shader.
This works okay with monolithic pipeline construction, but with the addition of things like <a href="https://docs.vulkan.org/spec/latest/appendices/extensions.html#VK_EXT_graphics_pipeline_library">VK_EXT_graphics_pipeline_library</a>, modifying this at link time would cause undesirable slowdown.
As a result, the Vulkan version of this feature requires the <code>[[vk::perprimitive]]</code> attribute on pixel shader inputs in order to generate a match with mesh shader outputs denoted with the <code>primitives</code> qualifier.</p>
</div>
<div class="paragraph">
<p>Mapping to SPIR-V is largely performed identically to any other shader for both mesh and task shaders, with most new functionality mapping 1:1.
One outlier is in index generation - the primitive index outputs are denoted by a variable in the function signature preceded by <code>out indices &#8230;&#8203;</code>.
The HLSL compiler should map this variable to the appropriate built-in value based on the selected <code>outputtopology</code> qualifier.</p>
</div>
<div class="paragraph">
<p>Another outlier is the groupshared task payload. In HLSL this is declared as groupshared, but must be declared in the <code>TaskPayloadWorkgroupEXT</code> storage class in SPIR-V.
The call to <code>DispatchMesh()</code> can inform the compiler which groupshared variable to promote to <code>TaskPayloadWorkgroupEXT</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_issues"><a class="anchor" href="#_issues"></a>4. Issues</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_what_are_the_differences_to_vk_nv_mesh_shader"><a class="anchor" href="#_what_are_the_differences_to_vk_nv_mesh_shader"></a>4.1. What are the differences to VK_NV_mesh_shader?</h3>
<div class="paragraph">
<p>The following changes have been made to the API:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Drawing mesh tasks can now be done with a three-dimensional number of workgroups, rather than just one-dimensional.</p>
</li>
<li>
<p>There are new device queries for the number of mesh primitives generated, and the number of shader invocations for the new shader stages.</p>
</li>
<li>
<p>A new command token is added when interacting with VK_NV_device_generated_commands, as mesh shaders from each extension are incompatible.</p>
</li>
<li>
<p>New optional features have been added for interactions with multiview, primitive fragment shading rate specification, and the new queries.</p>
</li>
<li>
<p>Support for the taskShader feature has been made mandatory.</p>
</li>
<li>
<p>Several more device properties are expressed to enable application developers to use mesh shaders optimally across vendors (see <a href="#properties">Properties</a> for details of how these are expressed and used).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that the SPIR-V and GLSL expression of these extensions have changed, details of which are outlined in those extensions.
These changes aim to make the extension more portable across multiple vendors, and increase compatibility with the similar feature in Microsoft® DirectX®.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_are_the_differences_to_directx_12s_mesh_shaders"><a class="anchor" href="#_what_are_the_differences_to_directx_12s_mesh_shaders"></a>4.2. What are the differences to DirectX® 12&#8217;s Mesh shaders?</h3>
<div class="paragraph">
<p>From the shader side, declaring mesh or amplification shaders in HLSL will have no meaningful differences - HLSL code written for DirectX should also work fine in Vulkan, with all the expected limits and features available.
One difference is present in pixel shaders though - any user-declared attributes with the "primitive" keyword in the mesh shader will need to be declared in the fragment shader with the <code>[[vk::perprimitive]]</code> attribute to facilitate linking.
This makes it so that the shader can be compiled without modifying the input interface, which is particularly important for interactions with extensions like <a href="https://docs.vulkan.org/spec/latest/appendices/extensions.html#VK_EXT_graphics_pipeline_library">VK_EXT_graphics_pipeline_library</a>.</p>
</div>
<div class="paragraph">
<p>Some amount of massaging by the HLSL compiler will be required to the shader interfaces as DirectX does linking by name rather than location between mesh and pixel shaders, but the requirement to use <code>[[vk::perprimitive]]</code> allows the different attributes to continue using locations in Vulkan.</p>
</div>
<div class="paragraph">
<p>The only notable difference on the API side is that Vulkan provides additional device properties that allow developers to tune their shaders to different vendors' fast paths, should they wish to.
Details of how these are expressed are detailed <a href="#properties">here</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_can_there_be_more_than_one_output_payload_in_a_task_shader"><a class="anchor" href="#_can_there_be_more_than_one_output_payload_in_a_task_shader"></a>4.3. Can there be more than one output payload in a task shader?</h3>
<div class="paragraph">
<p>There can only be one output payload per task shader; one declaration in HLSL or GLSL, and only one in the interface declaration for SPIR-V.
More would have no effect anyway, as only one payload can be emitted for mesh shader consumption.</p>
</div>
</div>
<div class="sect2">
<h3 id="_should_developers_port_everything_to_mesh_shading"><a class="anchor" href="#_should_developers_port_everything_to_mesh_shading"></a>4.4. Should developers port everything to mesh shading?</h3>
<div class="paragraph">
<p>Mesh shaders are not necessarily a performance win compared to the existing pipeline - their purpose is to offer greater flexibility at decent performance, but this flexibility may come at a cost, and that cost is likely platform dependent.
What task and mesh shading offer is a way to perform novel techniques efficiently compared to the hoops developers would previously have to jump through.
Task and mesh shaders are a tool that should be used when it makes sense to do so - if a developer has a novel technique that would be easier to implement using task and mesh shaders, then they are likely the appropriate tool.
Moving from an existing optimized pipeline without this consideration may lead to decreased performance.</p>
</div>
</div>
<div class="sect2">
<h3 id="_does_vertex_input_interface_state_interact_with_taskmesh_shaders"><a class="anchor" href="#_does_vertex_input_interface_state_interact_with_taskmesh_shaders"></a>4.5. Does vertex input interface state interact with task/mesh shaders?</h3>
<div class="paragraph">
<p>No, topology information is specified within the mesh shader, and data must be read or generated these shader stages programmatically.</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <!--
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
    -->
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="https://cdn.jsdelivr.net/pako/1.0.3/pako.min.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
  </body>
</html>
