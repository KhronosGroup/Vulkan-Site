<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VK_AMD_shader_early_and_late_fragment_tests :: Vulkan Documentation Project</title>
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../../../../_/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../../_/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../../_/img/favicon-16x16.png">
    <link rel="manifest" href="../../../../_/static/site.webmanifest">
    <link rel="mask-icon" href="../../../../_/img/safari-pinned-tab.svg" color="#a41e22">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="theme-color" content="#ffffff">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../.."><img class="navbar-item" alt="Vulkan White Label" src="../../../../_/Vulkan_Docs.svg" /></a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field has-filter">
          <label for="search-input"></label>
          <input id="search-input" type="text" placeholder="Search the docs">
          <label class="filter checkbox">
            <input type="checkbox" data-facet-filter="component:features" checked> In this component
          </label>
        </div>
      </div>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <!-- <a class="navbar-item" href="#">Home</a> -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Specs</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../spec/latest/chapters/introduction.html">Vulkan 1.3</a>
            <a class="navbar-item" href="https://registry.khronos.org/OpenGL/specs/gl/GLSLangSpec.4.60.html">GLSL</a>
            <a class="navbar-item" href="../../../../guide/latest/hlsl.html">HLSL</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Education</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../features/latest/features/index.html">Vulkan Feature Descriptions</a>
            <a class="navbar-item" href="../../../../guide/latest/index.html">Vulkan Guide</a>
            <a class="navbar-item" href="../../../../samples/latest/README.html">Vulkan Samples</a>
            <a class="navbar-item" href="../../../../tutorial/latest/index.html">Vulkan Tutorial</a>
            <a class="navbar-item" href="https://www.youtube.com/c/vulkan">YouTube</a>
            <a class="navbar-item" href="https://vulkan.org">More Info at Vulkan.org</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Feedback</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://github.com/KhronosGroup/Vulkan-Site/issues/new/choose" target="_blank">Report a Problem</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://discord.gg/vulkan">Vulkan Discord</a>
            <a class="navbar-item" href="https://reddit.com/r/vulkan">Reddit</a>
            <a class="navbar-item" href="https://stackoverflow.com/questions/tagged/vulkan">Stack Overflow</a>
            <a class="navbar-item" href="https://fosstodon.org/@vulkan">Mastodon</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="features" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">Vulkan Feature Descriptions</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Vulkan Roadmap and Feature Descriptions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Roadmap.html">Vulkan Roadmap</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Feature Descriptions</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_AMDX_shader_enqueue.html">VK_AMDX_shader_enqueue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_AMD_anti_lag.html">VK_AMD_anti_lag</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="VK_AMD_shader_early_and_late_fragment_tests.html">VK_AMD_shader_early_and_late_fragment_tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_ANDROID_external_format_resolve.html">VK_ANDROID_external_format_resolve</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_ARM_render_pass_striped.html">VK_ARM_render_pass_striped</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_attachment_feedback_loop_dynamic_state.html">VK_EXT_attachment_feedback_loop_dynamic_state</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_attachment_feedback_loop_layout.html">VK_EXT_attachment_feedback_loop_layout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_calibrated_timestamps.html">VK_EXT_calibrated_timestamps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_depth_bias_control.html">VK_EXT_depth_bias_control</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_depth_clamp_control.html">VK_EXT_depth_clamp_control</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_descriptor_buffer.html">VK_EXT_descriptor_buffer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_device_fault.html">VK_EXT_device_fault</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_device_generated_commands.html">VK_EXT_device_generated_commands</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_dynamic_rendering_unused_attachments.html">VK_EXT_dynamic_rendering_unused_attachments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_extended_dynamic_state3.html">VK_EXT_extended_dynamic_state3</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_external_memory_acquire_unmodified.html">VK_EXT_external_memory_acquire_unmodified</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_frame_boundary.html">Proposal: <code>VK_EXT_frame_boundary</code></a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_graphics_pipeline_library.html">VK_EXT_graphics_pipeline_library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_host_image_copy.html">VK_EXT_host_image_copy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_image_2d_array_of_3d.html">VK_EXT_image_2d_array_of_3d</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_image_compression_control.html">VK_EXT_image_compression_control</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_image_sliced_view_of_3d.html">VK_EXT_image_sliced_view_of_3d</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_layer_settings.html">VK_EXT_layer_settings</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_legacy_dithering.html">VK_EXT_legacy_dithering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_legacy_vertex_attributes.html">VK_EXT_legacy_vertex_attributes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_map_memory_placed.html">VK_EXT_map_memory_placed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_mesh_shader.html">VK_EXT_mesh_shader</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_metal_objects.html">VK_EXT_metal_objects</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_multisampled_render_to_single_sampled.html">VK_EXT_multisampled_render_to_single_sampled</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_mutable_descriptor_type.html">VK_EXT_mutable_descriptor_type</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_non_seamless_cube_map.html">VK_EXT_non_seamless_cube_map</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_opacity_micromap.html">VK_EXT_opacity_micromap</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_pipeline_library_group_handles.html">VK_EXT_pipeline_library_group_handles</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_pipeline_protected_access.html">VK_EXT_pipeline_protected_access</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_present_mode_fifo_latest_ready.html">VK_EXT_present_mode_fifo_latest_ready</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_primitives_generated_query.html">VK_EXT_primitives_generated_query</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_rasterization_order_attachment_access.html">VK_EXT_rasterization_order_attachment_access</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_shader_module_identifier.html">VK_EXT_shader_module_identifier</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_shader_object.html">VK_EXT_shader_object</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_shader_replicated_composites.html">VK_EXT_shader_replicated_composites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_shader_tile_image.html">VK_EXT_shader_tile_image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_subpass_merge_feedback.html">VK_EXT_subpass_merge_feedback</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_surface_maintenance1.html">VK_EXT_surface_maintenance1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_swapchain_maintenance1.html">VK_EXT_swapchain_maintenance1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_GOOGLE_surfaceless_query.html">VK_GOOGLE_surfaceless_query</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_HUAWEI_cluster_culling_shader.html">VK_HUAWEI_cluster_culling_shader</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_HUAWEI_invocation_mask.html">VK_HUAWEI_invocation_mask</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_compute_shader_derivatives.html">VK_KHR_compute_shader_derivatives</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_cooperative_matrix.html">VK_KHR_cooperative_matrix</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_dynamic_rendering.html">VK_KHR_dynamic_rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_dynamic_rendering_local_read.html">VK_KHR_dynamic_rendering_local_read</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_fragment_shader_barycentric.html">VK_KHR_fragment_shader_barycentric</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_fragment_shading_rate.html">VK_KHR_fragment_shading_rate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_load_store_op_none.html">VK_KHR_load_store_op_none</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_maintenance5.html">VK_KHR_maintenance5</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_maintenance6.html">VK_KHR_maintenance6</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_maintenance7.html">VK_KHR_maintenance7</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_map_memory2.html">VK_KHR_map_memory2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_pipeline_binary.html">VK_KHR_pipeline_binary</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_ray_tracing_position_fetch.html">VK_KHR_ray_tracing_position_fetch</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_expect_assume.html">VK_KHR_shader_expect_assume</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_float_controls2.html">VK_KHR_shader_float_controls2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_integer_dot_product.html">VK_KHR_shader_integer_dot_product</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_maximal_reconvergence.html">VK_KHR_shader_maximal_reconvergence</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_quad_control.html">VK_KHR_shader_quad_control</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_relaxed_extended_instruction.html">VK_KHR_shader_relaxed_extended_instruction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_subgroup_rotate.html">Subgroup rotation instruction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_vertex_attribute_divisor.html">VK_KHR_vertex_attribute_divisor</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_decode_av1.html">VK_KHR_video_decode_av1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_decode_h264.html">VK_KHR_video_decode_h264</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_decode_h265.html">VK_KHR_video_decode_h265</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_decode_queue.html">VK_KHR_video_decode_queue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_encode_h264.html">VK_KHR_video_encode_h264</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_encode_h265.html">VK_KHR_video_encode_h265</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_encode_queue.html">VK_KHR_video_encode_queue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_maintenance1.html">VK_KHR_video_maintenance1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_queue.html">VK_KHR_video_queue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_LUNARG_direct_driver_loading.html">VK_LUNARG_direct_driver_loading</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_MSFT_layered_driver.html">VK_MSFT_layered_driver</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_NV_cooperative_matrix2.html">VK_NV_cooperative_matrix2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_NV_ray_tracing_validation.html">VK_NV_ray_tracing_validation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_QCOM_image_processing.html">VK_QCOM_image_processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_QCOM_tile_properties.html">VK_QCOM_tile_properties</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Vulkan Feature Descriptions</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <div class="title"><a href="../../../../tutorial/latest/00_Introduction.html">Khronos Vulkan Tutorial</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../tutorial/latest/00_Introduction.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <div class="title"><a href="../index.html">Vulkan Feature Descriptions</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../../guide/latest/index.html">Vulkan Guide</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../guide/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../../samples/latest/README.html">Vulkan Samples</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../samples/latest/README.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../../spec/latest/index.html">Vulkan Specification</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../spec/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../spec/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Vulkan Feature Descriptions</a></li>
    <li>Feature Descriptions</li>
    <li><a href="VK_AMD_shader_early_and_late_fragment_tests.html">VK_AMD_shader_early_and_late_fragment_tests</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">VK_AMD_shader_early_and_late_fragment_tests</h1>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_problem_statement">1. Problem Statement</a></li>
<li><a href="#_solution_space">2. Solution Space</a></li>
<li><a href="#_proposal">3. Proposal</a>
<ul class="sectlevel2">
<li><a href="#_new_vulkan_feature">3.1. New Vulkan feature</a></li>
<li><a href="#_new_spir_v_execution_modes">3.2. New SPIR-V Execution Modes</a></li>
<li><a href="#_new_glsl_layout_qualifiers">3.3. New GLSL Layout Qualifiers</a></li>
<li><a href="#_new_hlsl_attributes">3.4. New HLSL Attributes</a></li>
</ul>
</li>
<li><a href="#_issues">4. Issues</a>
<ul class="sectlevel2">
<li><a href="#_unresolved_should_we_expose_a_featureproperty_indiciting_if_the_implementation_is_actually_going_to_perform_early_and_late_tests">4.1. UNRESOLVED: Should we expose a feature/property indiciting if the implementation is actually going to perform early and late tests?</a></li>
</ul>
</li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This document describes a proposal for a new SPIR-V execution mode that allows fragment shaders to be discarded by early fragment operations, even if they contain writes to storage resources or other side effects.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_problem_statement"><a class="anchor" href="#_problem_statement"></a>1. Problem Statement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most graphics devices are able to take advantage of early fragment operations when a fragment shader avoids certain operations - e.g. writing to depth or stencil, or to storage resources, providing significant performance advantages in most cases.
This is implicitly enabled wherever possible, and can be explicitly enabled by specifying the <code>EarlyFragmentTests</code> execution mode in SPIR-V.
However the <code>EarlyFragmentTests</code> execution mode makes it invalid to write fragment depth from a shader.</p>
</div>
<div class="paragraph">
<p>Some implementations can perform depth testing both before <em>and</em> after fragment shading, allowing a conservative early test to discard most fragments and a late test to discard with more precision.
<a href="https://registry.khronos.org/OpenGL/extensions/ARB/ARB_conservative_depth.txt">GL_ARB_conservative_depth</a> added a way to enable this optimization even when depth was written by the fragment shader, allowing further optimizations to be achieved in certain conditions.
However, if the shader also writes to storage resources, no such optimization is possible due to the predictability requirements of the specification.
In cases where an application does not care whether storage writes are performed by a fragment shader when discarded, it is possible to use this capability for a significant performance improvement on some console platforms, but so far Vulkan has no mechanism to do this.
For some applications, this can mean an unnecessary performance hit that should be relatively straightforward to solve.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solution_space"><a class="anchor" href="#_solution_space"></a>2. Solution Space</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is only really one solution to this problem, which is to expose this capability to applications in some way.
The main question is how to expose this, at what granularity, and whether we should provide any guarantees.
Ultimately this should be relatively easy to turn on/off, and ideally should be set per-fragment shader in some form.</p>
</div>
<div class="paragraph">
<p>The main options for signifying the switch are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pipeline creation flag</p>
</li>
<li>
<p>SPIR-V execution mode</p>
</li>
<li>
<p>Non-semantic instruction</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If it becomes a pipeline creation flag, it is easy to turn on/off on a per-pipeline basis.
However, the knowledge of whether the writes can be discarded is usually a property of whatever algorithm has been written in the fragment shader code itself, meaning this property has to be specified in two places.
From that perspective, it makes sense to have something in the shader code itself.</p>
</div>
<div class="paragraph">
<p>A SPIR-V execution mode is a straightforward way to express this, and it is consistent with the way that conservative depth is expressed in SPIR-V (e.g. <code>DepthGreater</code> <a href="https://registry.khronos.org/spir-v/specs/unified1/SPIRV.html#Execution_Mode">Execution Mode</a>).
The downside of using an execution mode which is essentially an optimization hint is that drivers have to implement the extension for the SPIR-V to be valid; when in fact it can be safely ignored in all cases.</p>
</div>
<div class="paragraph">
<p>Non-Semantic instructions seem like they could offer a way to specify the behavior without need for drivers to implement anything new.
Unfortunately, as the induced behavior violates the current Vulkan specification, it is not suitable for this use case, as it cannot be safely added to all shaders.</p>
</div>
<div class="paragraph">
<p>Without a wider "this can be ignored but can change behavior" extension along the lines of the non-semantic extension, a SPIR-V execution mode is likely the most suitable option.
Applications, an application-facing library, or a Vulkan software layer could be used to automatically remove the execution mode when not supported.
Implementations should also eventually be able to support the execution mode as a no-op if they do not have the required capabilities.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proposal"><a class="anchor" href="#_proposal"></a>3. Proposal</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_new_vulkan_feature"><a class="anchor" href="#_new_vulkan_feature"></a>3.1. New Vulkan feature</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c hljs" data-lang="c">typedef struct VkPhysicalDeviceShaderEarlyAndLateFragmentTestsFeaturesAMD {
    VkStructureType    sType;
    void*              pNext;
    VkBool32           shaderEarlyAndLateFragmentTests;
} VkPhysicalDeviceShaderEarlyAndLateFragmentTestsFeaturesAMD;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This feature allows the new execution mode in SPIR-V shaders consumed by the implementation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_new_spir_v_execution_modes"><a class="anchor" href="#_new_spir_v_execution_modes"></a>3.2. New SPIR-V Execution Modes</h3>
<div class="paragraph">
<p>A new execution mode is introduced which allows for early depth and stencil tests to be performed both early and late when depth and stencil writes are performed, in combination with the depth optimizations.
In order to allow for stencil reference writes with this new execution mode, similar stencil reference write optimizations are provided.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10%;">
<col style="width: 60%;">
<col style="width: 20%;">
<col style="width: 10%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top" colspan="2">Execution mode</th>
<th class="tableblock halign-center valign-top">Extra Operands</th>
<th class="tableblock halign-center valign-top">Enabling Capabilities</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5017</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>EarlyAndLateFragmentTestsAMD</strong><br>
Fragment tests can be performed both before and after fragment shader execution, with latter tests taking values written to <em>FragDepth</em> and <em>FragStencilRefEXT</em> into account. Early tests are not guaranteed, late tests are.+
<br>
If neither of <strong>ExecutionModeDepthReplacing</strong> or <strong>ExecutionModeStencilRefReplacingEXT</strong> are specified, functions identically to <strong>EarlyFragmentTests</strong>.<br>
If this and <strong>ExecutionModeStencilRefReplacingEXT</strong> are both specified, one of <strong>StencilRefGreaterAMD</strong>, <strong>StencilRefLessAMD</strong>, or <strong>StencilRefUnchangedAMD</strong> must also be specified.<br>
If this and <strong>ExecutionModeDepthReplacing</strong> are both specified, one of <strong>DepthGreater</strong>, <strong>DepthLess</strong>, or <strong>DepthUnchanged</strong> must also be specified.<br>
<br>
Only valid with the Fragment <a href="https://registry.khronos.org/spir-v/specs/unified1/SPIRV.html#Execution_Model">Execution Model</a>.<br>
See client API for detail on fragment operations.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Shader</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5079</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StencilRefUnchangedFrontAMD</strong><br>
Indicates that early per-fragment tests may assume that any <em>FragStencilRefEXT</em> built in-decorated value written by the shader is equal to the stencil reference value set for the front face in the client API after masking.
Late per-fragment tests will use the written value as normal.<br>
<br>
Only valid with the Fragment <a href="https://registry.khronos.org/spir-v/specs/unified1/SPIRV.html#Execution_Model">Execution Model</a>.<br>
At most one of <strong>StencilRefGreaterAMD</strong>, <strong>StencilRefLessAMD</strong>, and <strong>StencilRefUnchangedAMD</strong> can be specified.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StencilExportEXT</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5080</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StencilRefGreaterFrontAMD</strong><br>
Indicates that early per-fragment tests may assume that any <em>FragStencilRefEXT</em> built in-decorated value written by the shader is greater than or equal to the stencil reference value set for the front face in the client API after masking.
Late per-fragment tests will use the written value as normal.<br>
<br>
Only valid with the Fragment <a href="https://registry.khronos.org/spir-v/specs/unified1/SPIRV.html#Execution_Model">Execution Model</a>.<br>
At most one of <strong>StencilRefGreaterAMD</strong>, <strong>StencilRefLessAMD</strong>, and <strong>StencilRefUnchangedAMD</strong> can be specified.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StencilExportEXT</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5081</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StencilRefLessFrontAMD</strong><br>
Indicates that early per-fragment tests may assume that any <em>FragStencilRefEXT</em> built in-decorated value written by the shader is less than or equal to the stencil reference value  set for the front face in the client API after masking.
Late per-fragment tests will use the written value as normal.<br>
<br>
Only valid with the Fragment <a href="https://registry.khronos.org/spir-v/specs/unified1/SPIRV.html#Execution_Model">Execution Model</a>.<br>
At most one of <strong>StencilRefGreaterAMD</strong>, <strong>StencilRefLessAMD</strong>, and <strong>StencilRefUnchangedAMD</strong> can be specified.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StencilExportEXT</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5082</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StencilRefUnchangedBackAMD</strong><br>
Indicates that early per-fragment tests may assume that any <em>FragStencilRefEXT</em> built in-decorated value written by the shader is equal to the stencil reference value set for the back face in the client API after masking.
Late per-fragment tests will use the written value as normal.<br>
<br>
Only valid with the Fragment <a href="https://registry.khronos.org/spir-v/specs/unified1/SPIRV.html#Execution_Model">Execution Model</a>.<br>
At most one of <strong>StencilRefGreaterAMD</strong>, <strong>StencilRefLessAMD</strong>, and <strong>StencilRefUnchangedAMD</strong> can be specified.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StencilExportEXT</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5083</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StencilRefGreaterBackAMD</strong><br>
Indicates that early per-fragment tests may assume that any <em>FragStencilRefEXT</em> built in-decorated value written by the shader is greater than or equal to the stencil reference value set for the back face in the client API after masking.
Late per-fragment tests will use the written value as normal.<br>
<br>
Only valid with the Fragment <a href="https://registry.khronos.org/spir-v/specs/unified1/SPIRV.html#Execution_Model">Execution Model</a>.<br>
At most one of <strong>StencilRefGreaterAMD</strong>, <strong>StencilRefLessAMD</strong>, and <strong>StencilRefUnchangedAMD</strong> can be specified.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StencilExportEXT</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5084</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StencilRefLessBackAMD</strong><br>
Indicates that early per-fragment tests may assume that any <em>FragStencilRefEXT</em> built in-decorated value written by the shader is less than or equal to the stencil reference value set for the back face in the client API after masking.
Late per-fragment tests will use the written value as normal.<br>
<br>
Only valid with the Fragment <a href="https://registry.khronos.org/spir-v/specs/unified1/SPIRV.html#Execution_Model">Execution Model</a>.<br>
At most one of <strong>StencilRefGreaterAMD</strong>, <strong>StencilRefLessAMD</strong>, and <strong>StencilRefUnchangedAMD</strong> can be specified.</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>StencilExportEXT</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This allows implementations to perform both early and late tests explicitly.</p>
</div>
</div>
<div class="sect2">
<h3 id="_new_glsl_layout_qualifiers"><a class="anchor" href="#_new_glsl_layout_qualifiers"></a>3.3. New GLSL Layout Qualifiers</h3>
<div class="paragraph">
<p>The following new layout qualifiers are added to GLSL:</p>
</div>
<div class="paragraph">
<p>Fragment shaders allow the following stand-alone declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">__early_and_late_fragment_testsAMD</code></pre>
</div>
</div>
<div class="paragraph">
<p>to request that certain fragment tests be performed before and after fragment shader execution, as described in
the &#8220;Fragment Operations&#8221; chapter of the Vulkan 1.2 Specification.
This declaration must appear in a line on its own.</p>
</div>
<div class="paragraph">
<p>The following additional standalone declarations may be specified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">layout-qualifier-id:
    __stencil_ref_unchanged_frontAMD
    __stencil_ref_less_frontAMD
    __stencil_ref_greater_frontAMD
    __stencil_ref_unchanged_backAMD
    __stencil_ref_less_backAMD
    __stencil_ref_greater_backAMD</code></pre>
</div>
</div>
<div class="paragraph">
<p>These declarations must each appear in a line on their own.
Only one <em>stencil_ref_*<em>frontAMD and one </em>stencil_ref</em>*_backAMD declaration may be specified.
Each declaration constrains the intentions of the final value of <code>gl_FragStencilRefARB</code> written by any shader invocation.
Implementations are allowed to perform optimizations assuming that the stencil test fails (or passes) for a given fragment if all values of <code>gl_FragStencilRefARB</code> consistent with the declaration would fail (or pass).
This potentially includes skipping shader execution if the fragment is discarded because it is occluded and the shader has no side effects.
If the final value of <code>gl_FragStencilRefARB</code> is inconsistent with the declaration for the facing of the shaded polygon, the result of the stencil test for the corresponding fragment is undefined.
If the stencil test passes and stencil writes are enabled, the value written to the stencil buffer is always the value of <code>gl_FragStencilRefARB</code>, whether or not it is consistent with the layout qualifier.</p>
</div>
<div class="paragraph">
<p>Each of the above qualifiers maps directly to the equivalently named spir-v execution mode.</p>
</div>
</div>
<div class="sect2">
<h3 id="_new_hlsl_attributes"><a class="anchor" href="#_new_hlsl_attributes"></a>3.4. New HLSL Attributes</h3>
<div class="paragraph">
<p>The following new <a href="https://github.com/microsoft/DirectXShaderCompiler/blob/main/docs/SPIR-V.rst#vulkan-specific-attributes">Vulkan Specific Attribute</a> is added:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>early_and_late_tests</code>: Marks an entry point as enabling early and late depth tests.
If depth is written via <code>SV_Depth</code>, <code>depth_unchanged</code> must also be specified (SV_DepthLess and SV_DepthGreater can be written freely).
If a stencil reference value is written via <code>SV_StencilRef</code>, one of <code>stencil_ref_unchanged_front</code>, <code>stencil_ref_greater_equal_front</code>, or <code>stencil_ref_less_equal_front</code> and one of <code>stencil_ref_unchanged_back</code>, <code>stencil_ref_greater_equal_back</code>, or <code>stencil_ref_less_equal_back</code> must be specified.</p>
</li>
<li>
<p><code>depth_unchanged</code>: Specifies that any depth written to <code>SV_Depth</code> will not invalidate the result of early depth tests.
Sets the <code>DepthUnchanged</code> execution mode in SPIR-V.</p>
</li>
<li>
<p><code>stencil_ref_unchanged_front</code>: Specifies that any stencil ref written to <code>SV_StencilRef</code> will not invalidate the result of early stencil tests when the fragment is front facing.
Sets the <code>StencilRefUnchangedFrontAMD</code> execution mode in SPIR-V.</p>
</li>
<li>
<p><code>stencil_ref_greater_equal_front</code>: Specifies that any stencil ref written to <code>SV_StencilRef</code> will be greater than or equal to the stencil reference value set by the API when the fragment is front facing.
Sets the <code>StencilRefGreaterFrontAMD</code> execution mode in SPIR-V.</p>
</li>
<li>
<p><code>stencil_ref_less_equal_front</code>: Specifies that any stencil ref written to <code>SV_StencilRef</code> will be less than or equal to the stencil reference value set by the API when the fragment is front facing.
Sets the <code>StencilRefLessFrontAMD</code> execution mode in SPIR-V.</p>
</li>
<li>
<p><code>stencil_ref_unchanged_back</code>: Specifies that any stencil ref written to <code>SV_StencilRef</code> will not invalidate the result of early stencil tests when the fragment is back facing.
Sets the <code>StencilRefUnchangedBackAMD</code> execution mode in SPIR-V.</p>
</li>
<li>
<p><code>stencil_ref_greater_equal_back</code>: Specifies that any stencil ref written to <code>SV_StencilRef</code> will be greater than or equal to the stencil reference value set by the API when the fragment is back facing.
Sets the <code>StencilRefGreaterBackAMD</code> execution mode in SPIR-V.</p>
</li>
<li>
<p><code>stencil_ref_less_equal_back</code>: Specifies that any stencil ref written to <code>SV_StencilRef</code> will be less than or equal to the stencil reference value set by the API when the fragment is back facing.
Sets the <code>StencilRefLessBackAMD</code> execution mode in SPIR-V.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Shaders must not specify more than one of <code>stencil_ref_unchanged_front</code>, <code>stencil_ref_greater_equal_front</code>, and <code>stencil_ref_less_equal_front</code>.
Shaders must not specify more than one of <code>stencil_ref_unchanged_back</code>, <code>stencil_ref_greater_equal_back</code>, and <code>stencil_ref_less_equal_back</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_issues"><a class="anchor" href="#_issues"></a>4. Issues</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_unresolved_should_we_expose_a_featureproperty_indiciting_if_the_implementation_is_actually_going_to_perform_early_and_late_tests"><a class="anchor" href="#_unresolved_should_we_expose_a_featureproperty_indiciting_if_the_implementation_is_actually_going_to_perform_early_and_late_tests"></a>4.1. UNRESOLVED: Should we expose a feature/property indiciting if the implementation is actually going to perform early and late tests?</h3>
<div class="paragraph">
<p>It would be useful if ultimately all implementations could ship this feature, treating it as a no-op where relevant - but if some implementations cannot gain any advantage from this, it might be reasonable to expose a property indicating this.</p>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
  </body>
</html>
