<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VK_EXT_shader_module_identifier :: Vulkan Documentation Project</title>
    <meta name="generator" content="Antora 3.1.4">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="apple-touch-icon" sizes="180x180" href="../../../../_/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../../_/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../../../../_/img/favicon-16x16.png">
    <link rel="manifest" href="../../../../_/static/site.webmanifest">
    <link rel="mask-icon" href="../../../../_/img/safari-pinned-tab.svg" color="#a41e22">
    <meta name="msapplication-TileColor" content="#ffc40d">
    <meta name="theme-color" content="#ffffff">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../../.."><img class="navbar-item" alt="Vulkan White Label" src="../../../../_/Vulkan_Docs.svg" /></a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field has-filter">
          <label for="search-input"></label>
          <input id="search-input" type="text" placeholder="Search the docs">
          <label class="filter checkbox">
            <input type="checkbox" data-facet-filter="component:features" checked> In this component
          </label>
        </div>
      </div>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <!-- <a class="navbar-item" href="#">Home</a> -->
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Specs</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../spec/latest/chapters/introduction.html">Vulkan 1.3</a>
            <a class="navbar-item" href="https://registry.khronos.org/OpenGL/specs/gl/GLSLangSpec.4.60.html">GLSL</a>
            <a class="navbar-item" href="../../../../guide/latest/hlsl.html">HLSL</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Education</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="../../../../guide/latest/index.html">Vulkan Guide</a>
            <a class="navbar-item" href="../../../../tutorial/latest/index.html">Vulkan Tutorial</a>
            <a class="navbar-item" href="../../../../samples/latest/README.html">Vulkan Samples</a>
            <a class="navbar-item" href="https://www.youtube.com/c/vulkan">YouTube</a>
            <a class="navbar-item" href="https://vulkan.org">More Info at Vulkan.org</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Feedback</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://github.com/KhronosGroup/Vulkan-Site/issues/new/choose" target="_blank">Report a Problem</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Community</a>
          <div class="navbar-dropdown is-right">
            <a class="navbar-item" href="https://discord.gg/vulkan">Vulkan Discord</a>
            <a class="navbar-item" href="https://reddit.com/r/vulkan">Reddit</a>
            <a class="navbar-item" href="https://stackoverflow.com/questions/tagged/vulkan">Stack Overflow</a>
            <a class="navbar-item" href="https://fosstodon.org/@vulkan">Mastodon</a>
          </div>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="features" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">Vulkan Feature Descriptions</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Vulkan Roadmap and Feature Descriptions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="Roadmap.html">Vulkan Roadmap</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Feature Descriptions</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_AMDX_shader_enqueue.html">VK_AMDX_shader_enqueue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_AMD_shader_early_and_late_fragment_tests.html">VK_AMD_shader_early_and_late_fragment_tests</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_ANDROID_external_format_resolve.html">VK_ANDROID_external_format_resolve</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_ARM_render_pass_striped.html">VK_ARM_render_pass_striped</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_attachment_feedback_loop_dynamic_state.html">VK_EXT_attachment_feedback_loop_dynamic_state</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_attachment_feedback_loop_layout.html">VK_EXT_attachment_feedback_loop_layout</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_calibrated_timestamps.html">VK_EXT_calibrated_timestamps</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_depth_bias_control.html">VK_EXT_depth_bias_control</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_descriptor_buffer.html">VK_EXT_descriptor_buffer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_device_fault.html">VK_EXT_device_fault</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_dynamic_rendering_unused_attachments.html">VK_EXT_dynamic_rendering_unused_attachments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_extended_dynamic_state3.html">VK_EXT_extended_dynamic_state3</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_external_memory_acquire_unmodified.html">VK_EXT_external_memory_acquire_unmodified</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_frame_boundary.html">Proposal: <code>VK_EXT_frame_boundary</code></a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_graphics_pipeline_library.html">VK_EXT_graphics_pipeline_library</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_host_image_copy.html">VK_EXT_host_image_copy</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_image_2d_array_of_3d.html">VK_EXT_image_2d_array_of_3d</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_image_compression_control.html">VK_EXT_image_compression_control</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_image_sliced_view_of_3d.html">VK_EXT_image_sliced_view_of_3d</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_layer_settings.html">VK_EXT_layer_settings</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_legacy_dithering.html">VK_EXT_legacy_dithering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_legacy_vertex_attributes.html">VK_EXT_legacy_vertex_attributes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_map_memory_placed.html">VK_EXT_map_memory_placed</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_mesh_shader.html">VK_EXT_mesh_shader</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_metal_objects.html">VK_EXT_metal_objects</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_multisampled_render_to_single_sampled.html">VK_EXT_multisampled_render_to_single_sampled</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_mutable_descriptor_type.html">VK_EXT_mutable_descriptor_type</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_non_seamless_cube_map.html">VK_EXT_non_seamless_cube_map</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_opacity_micromap.html">VK_EXT_opacity_micromap</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_pipeline_library_group_handles.html">VK_EXT_pipeline_library_group_handles</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_pipeline_protected_access.html">VK_EXT_pipeline_protected_access</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_primitives_generated_query.html">VK_EXT_primitives_generated_query</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_rasterization_order_attachment_access.html">VK_EXT_rasterization_order_attachment_access</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="VK_EXT_shader_module_identifier.html">VK_EXT_shader_module_identifier</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_shader_object.html">VK_EXT_shader_object</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_shader_tile_image.html">VK_EXT_shader_tile_image</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_subpass_merge_feedback.html">VK_EXT_subpass_merge_feedback</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_surface_maintenance1.html">VK_EXT_surface_maintenance1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_EXT_swapchain_maintenance1.html">VK_EXT_swapchain_maintenance1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_GOOGLE_surfaceless_query.html">VK_GOOGLE_surfaceless_query</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_HUAWEI_cluster_culling_shader.html">VK_HUAWEI_cluster_culling_shader</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_HUAWEI_invocation_mask.html">VK_HUAWEI_invocation_mask</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_cooperative_matrix.html">VK_KHR_cooperative_matrix</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_dynamic_rendering.html">VK_KHR_dynamic_rendering</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_dynamic_rendering_local_read.html">VK_KHR_dynamic_rendering_local_read</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_fragment_shader_barycentric.html">VK_KHR_fragment_shader_barycentric</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_fragment_shading_rate.html">VK_KHR_fragment_shading_rate</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_load_store_op_none.html">VK_KHR_load_store_op_none</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_maintenance5.html">VK_KHR_maintenance5</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_maintenance6.html">VK_KHR_maintenance6</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_map_memory2.html">VK_KHR_map_memory2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_ray_tracing_position_fetch.html">VK_KHR_ray_tracing_position_fetch</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_expect_assume.html">VK_KHR_shader_expect_assume</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_float_controls2.html">VK_KHR_shader_float_controls2</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_integer_dot_product.html">VK_KHR_shader_integer_dot_product</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_maximal_reconvergence.html">VK_KHR_shader_maximal_reconvergence</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_quad_control.html">VK_KHR_shader_quad_control</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_shader_subgroup_rotate.html">Subgroup rotation instruction</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_vertex_attribute_divisor.html">VK_KHR_vertex_attribute_divisor</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_decode_av1.html">VK_KHR_video_decode_av1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_decode_h264.html">VK_KHR_video_decode_h264</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_decode_h265.html">VK_KHR_video_decode_h265</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_decode_queue.html">VK_KHR_video_decode_queue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_encode_h264.html">VK_KHR_video_encode_h264</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_encode_h265.html">VK_KHR_video_encode_h265</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_encode_queue.html">VK_KHR_video_encode_queue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_maintenance1.html">VK_KHR_video_maintenance1</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_KHR_video_queue.html">VK_KHR_video_queue</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_LUNARG_direct_driver_loading.html">VK_LUNARG_direct_driver_loading</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_MSFT_layered_driver.html">VK_MSFT_layered_driver</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_NV_ray_tracing_validation.html">VK_NV_ray_tracing_validation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_QCOM_image_processing.html">VK_QCOM_image_processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="VK_QCOM_tile_properties.html">VK_QCOM_tile_properties</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Vulkan Feature Descriptions</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <div class="title"><a href="../../../../tutorial/latest/00_Introduction.html">Khronos Vulkan Tutorial</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../tutorial/latest/00_Introduction.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <div class="title"><a href="../index.html">Vulkan Feature Descriptions</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../../guide/latest/index.html">Vulkan Guide</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../guide/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../../samples/latest/README.html">Vulkan Samples</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../samples/latest/README.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <div class="title"><a href="../../../../spec/latest/index.html">Vulkan Specification</a></div>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../spec/latest/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../spec/latest/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Vulkan Feature Descriptions</a></li>
    <li>Feature Descriptions</li>
    <li><a href="VK_EXT_shader_module_identifier.html">VK_EXT_shader_module_identifier</a></li>
  </ul>
</nav>
<div class="edit-this-page"><a href="https://github.com/KhronosGroup/Vulkan-Docs/edit/main/antora/features/modules/features/pages/proposals/VK_EXT_shader_module_identifier.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">VK_EXT_shader_module_identifier</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This extension adds functionality to avoid having to pass down complete SPIR-V to shaders in situations
where we speculate that an implementation already has a pipeline blob in cache and conversion to SPIR-V is not needed to begin with.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_problem_statement"><a class="anchor" href="#_problem_statement"></a>Problem Statement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In some applications, SPIR-V is generated on-the-fly, usually by translating from some other representation.
API translation libraries and emulators in particular frequently run into these problems.</p>
</div>
<div class="paragraph">
<p>In such applications, the overhead required to obtain valid SPIR-V before any pipeline creation call can be problematic.
Especially in graphics API translation layering efforts, applications expect that compilation with hot caches is "instant",
as that is how a native driver would behave. Translating to SPIR-V can therefore become a performance problem.
There are two common problems:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Applications compile PSOs late &#8594; stutter! &#8594; but we are expected to mitigate</p>
</li>
<li>
<p>Applications compile a lot of PSOs early &#8594; good! but can lead to excessive load times even on subsequent runs of application</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For translation layers, there are currently two options we can consider to mitigate the issue:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Optimize the translation</p>
</li>
<li>
<p>Cache converted SPIR-V on disk</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Neither option may be good enough. Disk requirements for large application caches can be impractical on some platforms,
since we might end up having to store in the order of 100k SPIR-V modules, easily in the gigabyte range.
Optimizing the translation might not be enough when faced with tens of thousand pipelines being compiled at once.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_solution_space"><a class="anchor" href="#_solution_space"></a>Solution Space</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The solution this extension addresses is the minimum viable approach to fix the problem.
The main idea is that when pipeline caches are primed, SPIR-V modules are largely useless,
since most implementations are likely to only hash, and never look at the SPIR-V again.
We can just hand back the hash to the implementation instead.</p>
</div>
<div class="paragraph">
<p>The extension is designed to work on top of <code>VK_EXT_pipeline_creation_cache_control</code>.
We can reuse the main idea of a "non-blocking" compile where we return early if pipeline compilation is required,
and the translation layer can build SPIR-V as needed. Next time, we are likely to hit in cache.</p>
</div>
<div class="paragraph">
<p>An important consideration here is that this solution is intended to aid internal implementation caching,
i.e. a "magic disk cache", which most desktop implementations of graphics APIs are expected to have.</p>
</div>
<div class="paragraph">
<p>For explicit application side caching mechanisms, larger cache sizes are reasonable and expected,
but we are more constrained with internal caches. These should be as lean and mean as possible,
but internal caches are also more "fuzzy" in nature. Spurious failure is okay, a "best effort" approach
is suitable for this use case.</p>
</div>
<div class="paragraph">
<p>One could extend this idea to full PSO keys as well, but that is better left to other proposals.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_example_use_case"><a class="anchor" href="#_example_use_case"></a>Example use case</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One scenario where this extension has been found to be particularly useful is D3D12 to Vulkan translation.
The translation layers need to translate DXBC and DXIL code to SPIR-V, which is then translated to GPU ISA.
SPIR-V to ISA translation is cached by Vulkan pipeline caches or in-driver caches,
but the DXBC/DXIL &#8594; SPIR-V cache is not covered by the API.</p>
</div>
<div class="paragraph">
<p>We can store SPIR-V on-disk and reload that in response to a pipeline creation call,
but the overhead of storing SPIR-V on disk, validating it, decompressing it, etc, is a significant overhead that can be avoided,
with storage space being the most significant problem.
If the final ISA is present in pipeline caches, we do not really need the SPIR-V at all.</p>
</div>
<div class="paragraph">
<p>We have observed &gt;95% disk savings with this scenario, and this is transformative since it makes it practical to share this cache across different machines.
This hypothetically allows an end-user to never observe shader compilation stutter or excessive load times on first run of a game.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proposal"><a class="anchor" href="#_proposal"></a>Proposal</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_querying_identifier"><a class="anchor" href="#_querying_identifier"></a>Querying identifier</h3>
<div class="paragraph">
<p>After the application has converted a shader to SPIR-V and compiled a pipeline, <code>vkGetShaderModuleIdentifierEXT</code> is used to obtain a shader identifier.
This identifier can be stored on-disk for later use. (<code>vkGetShaderModuleCreateInfoIdentifierEXT</code> can be used as an object-less alternative.)
<code>VkPhysicalDeviceShaderModuleIdentifierPropertiesEXT::shaderModuleIdentifierAlgorithmUUID</code>
is also needed so applications know if we need to throw away any caches using the identifier.
This should only happen on different driver implementations. Different versions of the same driver are not expected to change hashing algorithms.
For drivers sharing the same framework (e.g. Mesa), the module hashing algorithm could even be the same one.</p>
</div>
<div class="paragraph">
<p>To make the API friendly to applications, there is a small upper bound on how large an identifier may be,
so that the identifiers can be retrieved without memory allocation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_vk_null_handle_module_proxy"><a class="anchor" href="#_vk_null_handle_module_proxy"></a><code>VK_NULL_HANDLE</code> module proxy</h3>
<div class="paragraph">
<p>On subsequent runs of an application, we speculate that the driver caches (or VkPipelineCaches) are primed, and thus having SPIR-V is not useful anymore.
We then set <code>VkPipelineShaderStageCreateInfo::module</code> to <code>VK_NULL_HANDLE</code> and chain in <code>VkPipelineShaderStageModuleIdentifierCreateInfoEXT</code> as a proxy.
This allows a driver to generate the same internal PSO key that it would generate if we passed in actual SPIR-V.
<code>VK_PIPELINE_CREATE_FAIL_ON_COMPILE_REQUIRED_BIT</code> must be set in this situation, since this is a speculative compile by definition.</p>
</div>
</div>
<div class="sect2">
<h3 id="_handling_fallbacks"><a class="anchor" href="#_handling_fallbacks"></a>Handling fallbacks</h3>
<div class="paragraph">
<p>In a situation where we do not have the pipeline cached, we receive <code>VK_PIPELINE_COMPILE_REQUIRED</code>, and fall back to re-creating SPIR-V as usual.</p>
</div>
</div>
<div class="sect2">
<h3 id="_soft_guarantees_of_successfully_compiling_pipelines"><a class="anchor" href="#_soft_guarantees_of_successfully_compiling_pipelines"></a>Soft guarantees of successfully compiling pipelines</h3>
<div class="paragraph">
<p>The proposal as-is states that implementations may fail compilation for any reason. This is a defensive measure
to make it possible for this extension to interoperate with layers, validation, debug tooling, etc., without too many problems.
In most such layers, there is a need to parse the SPIR-V itself to figure out information required for correct operation.
While the ICD might recognize an identifier, a layer might not, and therefore they might need the escape hatch where they can spuriously fail compilation.</p>
</div>
<div class="paragraph">
<p>This effectively makes the spec somewhat vague, and it becomes a quality-of-implementation issue on what ICDs do.
This is not different from what implementations already do either way. After all, you may or may not have a PSO in disk cache and that is okay.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_issues"><a class="anchor" href="#_issues"></a>Issues</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_resolved_should_applications_be_allowed_to_specify_their_own_shader_module_identifier"><a class="anchor" href="#_resolved_should_applications_be_allowed_to_specify_their_own_shader_module_identifier"></a>RESOLVED: Should applications be allowed to specify their own shader module identifier?</h3>
<div class="paragraph">
<p>NO.</p>
</div>
<div class="paragraph">
<p>It is plausible that applications might want to generate their own keys instead of using driver-generated keys.
For this to be useful, an application will need to generate a key which depends
on input data/shaders, the revision of the code which performs runtime conversion to SPIR-V, and potentially, the driver kind or any configuration options
which affect shader conversion. A typical problem which comes up when doing forward hashing like this is that hashes can change for every revision of the application,
even if the resulting SPIR-V ends up being identical. This will easily contribute to pipeline cache bloat, since the exact same pipelines might end up in cache with
different hashes. Implementations can be defensive about this and introduce extra identifier indirections, e.g. have an extra hashmap for application identifier
to driver identifier, but ideally, this extension should not introduce extra implementation complexity to support it well.</p>
</div>
<div class="paragraph">
<p>Applications could also hash the resulting SPIR-V and ensure non-duplicated identifiers this way,
but this is not meaningfully different from just using the driver identifier, and also avoids added implementation complexity.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resolved_how_does_this_interact_with_vk_khr_ray_tracing_pipeline_vk_khr_pipeline_library_and_vk_ext_graphics_pipeline_library"><a class="anchor" href="#_resolved_how_does_this_interact_with_vk_khr_ray_tracing_pipeline_vk_khr_pipeline_library_and_vk_ext_graphics_pipeline_library"></a>RESOLVED: How does this interact with VK_KHR_ray_tracing_pipeline, VK_KHR_pipeline_library and VK_EXT_graphics_pipeline_library?</h3>
<div class="paragraph">
<p>SUPPORTED.</p>
</div>
<div class="paragraph">
<p>When using pipeline libraries, there are two scenarios where pipeline creation can fail if we only have an identifier,
at creation time of the library, and the consumption of that library.</p>
</div>
<div class="paragraph">
<p>There are at least three possibilities an implementation could consider when building libraries and consuming them:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate final code when creating library, link step is trivial. Ray tracing pipeline libraries may be implemented like this.</p>
</li>
<li>
<p>Generate code when creating library, but allow link-time optimization for later. Graphics pipeline libraries is a common case here.</p>
</li>
<li>
<p>Just retain a reference to the shader module, perform actual compilation during linking. Another strategy for ray tracing libraries.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the latter two scenarios, it is reasonable to assume that compilation may happen during the final pipeline build
and compilation would spuriously fail if the source module was only defined by identifier and the final PSO did not exist in cache.
If we do not allow compilation to fail with <code>VK_PIPELINE_CREATE_FAIL_ON_COMPILE_REQUIRED_BIT</code> here, it would not be safe to return
<code>VK_SUCCESS</code> from the library creation step, which would be unfortunate.</p>
</div>
<div class="paragraph">
<p>For scenarios where the implementation may generate code later, we require that any pipeline libraries
which were created with identifiers inherit the requirement of using <code>VK_PIPELINE_CREATE_FAIL_ON_COMPILE_REQUIRED_BIT</code>.
This allows applications to speculatively create link-time optimized pipelines from identifiers only as well as
ray-tracing pipelines from libraries.</p>
</div>
</div>
<div class="sect2">
<h3 id="_resolved_should_there_be_stronger_guarantees_on_when_pipeline_compilation_with_identifier_must_succeed"><a class="anchor" href="#_resolved_should_there_be_stronger_guarantees_on_when_pipeline_compilation_with_identifier_must_succeed"></a>RESOLVED: Should there be stronger guarantees on when pipeline compilation with identifier must succeed?</h3>
<div class="paragraph">
<p>NO.</p>
</div>
<div class="paragraph">
<p>The existing proposal gives a lot of lee-way for implementations to spuriously fail compilation when module is <code>VK_NULL_HANDLE</code>.
It might be possible to give stronger guarantees with tighter spec language?</p>
</div>
<div class="paragraph">
<p>CTS testing will report quality warnings if identifiers cannot be used with <code>VkPipelineCache</code>,
as there is no good excuse why an implementation should not be able to satisfy those pipelines.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_further_functionality"><a class="anchor" href="#_further_functionality"></a>Further Functionality</h2>
<div class="sectionbody">
<div class="paragraph">
<p>N/A</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
    <!--
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
    -->
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
  </body>
</html>
